<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sales-Beteiligung · Quelle · Vollständigkeit · Betrag</title>
<style>
  :root{
    --bg:#0a0f16; --panel:#0f1724; --panel2:#0c1320; --text:#e6ebf3; --muted:#94a3b8; --border:#213044;
    --accent:#3b82f6; --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b;
    --radius:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:linear-gradient(180deg,#08101a 0%, #0a0f16 100%); color:var(--text);
       font:15px/1.45 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial}
  .container{max-width:1160px; margin:26px auto; padding:0 16px}
  .card{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:0 12px 32px rgba(0,0,0,.35); overflow:hidden}
  .hd{padding:18px 20px 8px}
  .hd h1{margin:0 0 4px; font-size:22px}
  .hd p{margin:0; color:var(--muted); font-size:13px}
  .ct{padding:18px 20px 22px}
  .grid-3{display:grid; grid-template-columns:1fr 1fr 1fr; gap:14px}
  label{display:block; font-weight:600; margin:8px 0 6px}
  input[type="text"], input[type="number"]{
    width:100%; background:var(--panel2); color:var(--text); border:1px solid var(--border); border-radius:10px; padding:10px 12px;
    outline:none; transition:border .2s, box-shadow .2s}
  input[type="text"]:focus, input[type="number"]:focus{border-color:var(--accent); box-shadow:0 0 0 2px rgba(59,130,246,.35)}
  input[type="number"]{text-align:right}
  .note{color:var(--muted); font-size:12px}
  .actions{display:flex; gap:10px; flex-wrap:wrap}
  .right{display:flex; justify-content:flex-end; align-items:center; gap:10px}
  .btn{appearance:none; border:1px solid var(--border); background:#0d1426; color:var(--text);
       padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600}
  .btn.primary{background:var(--accent); border-color:transparent}
  .btn.ok{background:var(--ok); border-color:transparent}
  .btn.warn{background:var(--warn); color:#111}
  .btn.danger{background:var(--bad); border-color:transparent}
  .tag{background:#0c162b; border:1px solid var(--border); color:var(--muted); padding:6px 10px; border-radius:999px; font-size:12px}
  .table{width:100%; border:1px solid var(--border); border-radius:12px; overflow:auto; background:#0b1120}
  table{width:100%; min-width:920px; border-collapse:collapse}
  thead th{position:sticky; top:0; background:#0d162a; border-bottom:1px solid var(--border); padding:10px; text-align:left; font-size:13px}
  tbody td{border-top:1px solid var(--border); padding:8px 10px}
  tbody tr:hover{background:#0c1426}
  .delrow{background:#13203b; border:1px solid #21314f; color:#cbd5e1; border-radius:8px; padding:6px 8px; cursor:pointer}
  .sumchips{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
  .chip{background:#0b1220; border:1px solid var(--border); border-radius:999px; padding:8px 12px; font-size:12px; display:inline-flex; align-items:center; gap:8px}
  .chip .dot{width:8px; height:8px; border-radius:50%}
  .chip.ok .dot{background:var(--ok)} .chip.bad .dot{background:var(--bad)} .chip.warn .dot{background:var(--warn)}
  .errors{margin:10px 0 0; color:#fecaca; font-size:13px}
  .hr{height:1px; background:var(--border); margin:16px 0}
  .kpi{display:grid; grid-template-columns:repeat(4,1fr); gap:12px}
  .kpi .box{background:#0c1324; border:1px solid var(--border); border-radius:12px; padding:12px}
  .kpi .box h3{margin:0; font-size:12px; color:var(--muted)} .kpi .box p{margin:4px 0 0; font-size:18px; font-weight:700}
  .pill{background:#0e1a33; border:1px solid var(--border); padding:6px 10px; border-radius:999px; font-size:12px}
  .mono{font-family:ui-monospace, Menlo, Consolas, "Liberation Mono", monospace}
  .small{font-size:12px}
  .hide{display:none !important}
  .legend{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .legend .dot{width:10px; height:10px; border-radius:50%}
</style>
</head>
<body>
<div class="container">

  <!-- Eingabe -->
  <div class="card" id="view-input">
    <div class="hd">
      <h1>Sales-Beteiligung erfassen</h1>
      <p>Gewichte: Consultative Selling 50 %, Konzepterstellung 30 %, Pitch 20 %.</p>
    </div>
    <div class="ct">
      <div class="grid-3">
        <div>
          <label for="auftraggeber">Auftraggeber <span class="note">(Pflichtfeld)</span></label>
          <input id="auftraggeber" type="text" placeholder="z. B. Deutsche Rentenversicherung Bund" autocomplete="organization">
        </div>
        <div>
          <label for="projekttitel">Projekttitel <span class="note">(Pflichtfeld)</span></label>
          <input id="projekttitel" type="text" placeholder="z. B. Basisprogramm Führungskräfte – Los 4">
        </div>
        <div>
          <label for="auftragswert">Auftragswert (EUR) <span class="note">(Pflichtfeld)</span></label>
          <input id="auftragswert" type="number" min="0" step="1" placeholder="z. B. 120000">
        </div>
      </div>

      <div class="hr"></div>

      <div class="actions" style="justify-content:space-between">
        <div class="legend">
          <span class="tag">Punktefeld: 0–100 (Ganzzahl)</span>
          <span class="tag">Kategorie-Summe ≤ 100</span>
          <span class="tag">Wenn genutzt: Summe = 100</span>
        </div>
        <button class="btn" id="btnAddRow">+ Zeile</button>
      </div>

      <div class="table" style="margin-top:10px">
        <table>
          <thead>
            <tr>
              <th style="width:30%">Name</th>
              <th style="width:18%">Consultative Selling<br><span class="note">Gewicht 50 %</span></th>
              <th style="width:18%">Konzepterstellung<br><span class="note">Gewicht 30 %</span></th>
              <th style="width:18%">Pitch<br><span class="note">Gewicht 20 %</span></th>
              <th style="width:16%">Aktion</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="sumchips" id="sumchips"></div>
      <div class="errors" id="errors"></div>

      <div class="hr"></div>

      <div class="right">
        <button class="btn" id="btnReset">Zurücksetzen</button>
        <button class="btn primary" id="btnNext">Ergebnis anzeigen</button>
      </div>
    </div>
  </div>

  <!-- Ergebnis -->
  <div class="card hide" id="view-result">
    <div class="hd">
      <h1>Ergebnis</h1>
      <p>Prozentuale Beteiligung und monetäre Anteile.</p>
    </div>
    <div class="ct">
      <div class="kpi">
        <div class="box"><h3>Auftraggeber</h3><p id="kpiAG">–</p></div>
        <div class="box"><h3>Projekttitel</h3><p id="kpiPT">–</p></div>
        <div class="box"><h3>Auftragswert</h3><p id="kpiAmt">–</p></div>
        <div class="box"><h3>Aktive Kategorien</h3><p id="kpiCats">–</p></div>
      </div>

      <div class="hr"></div>

      <div class="legend" style="margin-bottom:8px">
        <span class="pill">Quelle: <strong id="badgeSource">manuell</strong></span>
        <span class="pill">Status: <strong id="badgeComplete">unvollständig</strong></span>
      </div>

      <div class="table">
        <table>
          <thead>
            <tr>
              <th style="width:46%">Person</th>
              <th style="width:27%">Gesamtbeitrag %</th>
              <th style="width:27%">Geldwert EUR</th>
            </tr>
          </thead>
          <tbody id="resultBody"></tbody>
        </table>
      </div>

      <div class="mono small" id="sumCheck" style="margin-top:8px">Summe: 0,00 %</div>

      <div class="hr"></div>

      <div class="actions">
        <button class="btn" id="btnBack">Zurück</button>
        <button class="btn ok" id="btnSave">In Historie speichern</button>
        <button class="btn warn" id="btnNew">Neu</button>
      </div>
    </div>
  </div>

  <!-- Historie -->
  <div class="card" id="view-history" style="margin-top:16px">
    <div class="hd">
      <h1>Historie</h1>
      <p>Quelle, Vollständigkeit, Beträge, Zeit.</p>
    </div>
    <div class="ct">
      <div class="legend" style="margin-bottom:8px">
        <span class="chip ok"><span class="dot"></span> vollständig</span>
        <span class="chip bad"><span class="dot"></span> unvollständig</span>
        <span class="tag">Quelle: manuell | hubspot</span>
      </div>
      <div class="table">
        <table>
          <thead>
            <tr>
              <th style="width:28%">Projekttitel</th>
              <th style="width:20%">Auftraggeber</th>
              <th style="width:12%">Quelle</th>
              <th style="width:14%">Status</th>
              <th style="width:14%">Wert EUR</th>
              <th style="width:12%">Zeit</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<template id="rowTpl">
  <tr>
    <td><input type="text" class="name" placeholder="Vor- und Nachname"></td>
    <td><input type="number" class="cs" min="0" max="100" step="1" value="0"></td>
    <td><input type="number" class="konzept" min="0" max="100" step="1" value="0"></td>
    <td><input type="number" class="pitch" min="0" max="100" step="1" value="0"></td>
    <td><button class="delrow">Entfernen</button></td>
  </tr>
</template>

<script>
(() => {
  // === Konfiguration ===
  const WORKER_BASE = "https://imap-sales-worker.tekin-6af.workers.dev";

  const CATS = [
    { key:'cs',      label:'Consultative Selling', weight:0.50 },
    { key:'konzept', label:'Konzepterstellung',    weight:0.30 },
    { key:'pitch',   label:'Pitch',                weight:0.20 },
  ];

  // === Formatierer ===
  const fmtPct  = new Intl.NumberFormat('de-DE', { minimumFractionDigits:2, maximumFractionDigits:2 });
  const fmtInt  = new Intl.NumberFormat('de-DE', { maximumFractionDigits:0 });
  const fmtCurr = new Intl.NumberFormat('de-DE', { style:'currency', currency:'EUR', maximumFractionDigits:0 });

  // === DOM-Refs ===
  const $ = (id)=>document.getElementById(id);
  const tbody = $('tbody');
  const rowTpl = $('rowTpl');

  const auftraggeber = $('auftraggeber');
  const projekttitel = $('projekttitel');
  const auftragswert = $('auftragswert');

  const sumchips = $('sumchips');
  const errorsEl = $('errors');

  const btnAddRow = $('btnAddRow');
  const btnReset  = $('btnReset');
  const btnNext   = $('btnNext');

  const viewInput  = $('view-input');
  const viewResult = $('view-result');

  const kpiAG = $('kpiAG');
  const kpiPT = $('kpiPT');
  const kpiAmt = $('kpiAmt');
  const kpiCats = $('kpiCats');

  const badgeSource = $('badgeSource');
  const badgeComplete = $('badgeComplete');

  const resultBody = $('resultBody');
  const sumCheck   = $('sumCheck');

  const btnBack = $('btnBack');
  const btnSave = $('btnSave');
  const btnNew  = $('btnNew');

  const historyBody = $('historyBody');

  // === Utils ===
  function toInt(v){
    const n = Math.round(Number(String(v ?? '0').replace(',', '.')));
    if (!Number.isFinite(n)) return 0;
    return Math.max(0, Math.min(100, n));
  }

  function addRow(focus=false){
    const tr = rowTpl.content.firstElementChild.cloneNode(true);
    tbody.appendChild(tr);
    bindRow(tr);
    if (focus) tr.querySelector('.name').focus();
    recalc();
  }

  function bindRow(tr){
    tr.addEventListener('input', (ev)=>{
      const el = ev.target;
      if (el.matches('input[type="number"]')){
        el.value = String(toInt(el.value));
      }
      recalc();
    });
    tr.querySelector('.delrow').addEventListener('click', ()=>{
      tr.remove();
      recalc();
    });
  }

  function readRows(){
    const rows=[];
    tbody.querySelectorAll('tr').forEach(tr=>{
      rows.push({
        name: (tr.querySelector('.name').value || '').trim(),
        cs: toInt(tr.querySelector('.cs').value),
        konzept: toInt(tr.querySelector('.konzept').value),
        pitch: toInt(tr.querySelector('.pitch').value),
      });
    });
    return rows;
  }

  function totals(rows){
    return rows.reduce((acc,r)=>{
      acc.cs += r.cs; acc.konzept += r.konzept; acc.pitch += r.pitch; return acc;
    }, {cs:0, konzept:0, pitch:0});
  }

  function usedCats(t){ return CATS.filter(c => t[c.key] > 0); }
  function normWeights(used){
    const s = used.reduce((a,c)=>a+c.weight,0) || 1;
    const out={}; used.forEach(c=>out[c.key]=c.weight/s); return out;
  }

  function renderChips(t){
    sumchips.innerHTML='';
    CATS.forEach(c=>{
      const x = t[c.key];
      const div = document.createElement('div'); div.className='chip';
      const dot = document.createElement('span'); dot.className='dot';
      const txt = document.createElement('span'); txt.innerHTML = `<strong>${c.label}</strong> &nbsp; ${fmtInt.format(x)} / 100`;
      if (x===0 || x===100) div.classList.add('ok');
      else if (x>100) div.classList.add('bad');
      else div.classList.add('warn');
      div.appendChild(dot); div.appendChild(txt);
      sumchips.appendChild(div);
    });
  }

  function validate(){
    const errs=[];
    if (!auftraggeber.value.trim()) errs.push('Auftraggeber ist erforderlich.');
    if (!projekttitel.value.trim()) errs.push('Projekttitel ist erforderlich.');
    const amount = Math.floor(Number(String(auftragswert.value||'').replace(',', '.')));
    if (!Number.isFinite(amount) || amount<=0) errs.push('Auftragswert ist erforderlich und muss > 0 sein.');

    const rows = readRows();
    const anyActive = rows.some(r => r.cs+r.konzept+r.pitch > 0);
    if (!anyActive) errs.push('Mindestens eine Person mit Punkten erfassen.');

    rows.forEach((r,i)=>{
      const active = r.cs+r.konzept+r.pitch>0;
      if (active && !r.name) errs.push(`Name in Zeile ${i+1} ist erforderlich (Punkte vorhanden).`);
    });

    const t = totals(rows);
    CATS.forEach(c=>{
      if (t[c.key] > 100) errs.push(`Kategorie „${c.label}“ überschreitet 100 (aktuell ${fmtInt.format(t[c.key])}).`);
    });
    CATS.forEach(c=>{
      if (t[c.key] > 0 && t[c.key] !== 100) errs.push(`Kategorie „${c.label}“ ist genutzt, Summe muss 100 sein (aktuell ${fmtInt.format(t[c.key])}).`);
    });

    return { ok: errs.length===0, errs, rows, t, amount };
  }

  function compute(rows, t){
    const used = usedCats(t);
    const nW = normWeights(used);
    const map = new Map();

    rows.forEach(r=>{
      if (!(r.name || r.cs+r.konzept+r.pitch>0)) return;
      const k = r.name || '(unbenannt)';
      const cur = map.get(k) || { name:k, cs:0, konzept:0, pitch:0 };
      cur.cs += r.cs; cur.konzept += r.konzept; cur.pitch += r.pitch;
      map.set(k, cur);
    });

    const out=[];
    [...map.values()].forEach(p=>{
      let pct=0;
      if (used.find(x=>x.key==='cs')      && t.cs>0)      pct += nW.cs      * (p.cs      / t.cs);
      if (used.find(x=>x.key==='konzept') && t.konzept>0) pct += nW.konzept * (p.konzept / t.konzept);
      if (used.find(x=>x.key==='pitch')   && t.pitch>0)   pct += nW.pitch   * (p.pitch   / t.pitch);
      out.push({ name:p.name, pct: pct*100 });
    });

    out.sort((a,b)=>b.pct - a.pct);
    const sum = out.reduce((a,x)=>a+x.pct,0);
    const resid = 100 - sum;
    if (out.length && Math.abs(resid)>1e-9) out[0].pct += resid;
    out.forEach(x=>{ if (x.pct<0) x.pct=0; });

    return { list: out, used, nW };
  }

  function recalc(){
    const rows = readRows();
    const t = totals(rows);
    renderChips(t);
  }

  async function loadHistory(){
    try{
      const r = await fetch(`${WORKER_BASE}/entries`, { method:'GET' });
      if (!r.ok) return;
      const arr = await r.json();
      renderHistory(arr);
    } catch {}
  }

  function renderHistory(arr){
    historyBody.innerHTML='';
    const sorted = [...arr].sort((a,b)=> (b.ts||0) - (a.ts||0));
    for (const e of sorted){
      const tr = document.createElement('tr');
      const ok = !!e.complete;
      const dot = `<span class="dot" style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${ok?'#22c55e':'#ef4444'};margin-right:6px"></span>`;
      const when = e.ts ? new Date(e.ts).toLocaleString('de-DE') : '–';
      tr.innerHTML = `
        <td>${e.title || e.projekttitel || '–'}</td>
        <td>${e.client || e.auftraggeber || '–'}</td>
        <td>${e.source || 'manuell'}</td>
        <td>${dot}${ok?'vollständig':'unvollständig'}</td>
        <td>${e.amount ? fmtCurr.format(e.amount) : '–'}</td>
        <td>${when}</td>
      `;
      historyBody.appendChild(tr);
    }
  }

  async function saveEntry(payload){
    const r = await fetch(`${WORKER_BASE}/entries`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    return r.ok;
  }

  // === Events ===
  btnAddRow.addEventListener('click', ()=>addRow(true));
  btnReset.addEventListener('click', ()=>{
    auftraggeber.value=''; projekttitel.value=''; auftragswert.value='';
    tbody.innerHTML=''; addRow(true); recalc(); errorsEl.textContent='';
  });

  btnNext.addEventListener('click', ()=>{
    const v = validate();
    const { list, used } = compute(v.rows, v.t);

    // KPIs
    kpiAG.textContent = auftraggeber.value.trim() || '–';
    kpiPT.textContent = projekttitel.value.trim() || '–';
    kpiAmt.textContent = Number.isFinite(v.amount) && v.amount>0 ? fmtCurr.format(v.amount) : '–';
    kpiCats.textContent = used.length ? used.map(c=>c.label).join(', ') : '–';

    // Badges
    badgeSource.textContent = 'manuell';
    badgeComplete.textContent = v.ok ? 'vollständig' : 'unvollständig';

    // Fehlerliste dennoch anzeigen, damit klar ist, warum unvollständig
    errorsEl.innerHTML = v.ok ? '' : v.errs.map(e=>`• ${e}`).join('<br>');

    // Ergebnis-Tabelle
    resultBody.innerHTML='';
    let sum=0;
    list.forEach(x=>{
      sum += x.pct;
      const eur = Math.round((v.amount>0? v.amount:0) * x.pct / 100);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${x.name}</td>
        <td>${fmtPct.format(x.pct)} %</td>
        <td>${fmtCurr.format(eur)}</td>
      `;
      resultBody.appendChild(tr);
    });
    sumCheck.textContent = `Summe: ${fmtPct.format(sum)} %`;

    // Zustand merken
    window.__lastComputed = {
      client: auftraggeber.value.trim(),
      title:  projekttitel.value.trim(),
      amount: v.amount>0? v.amount:0,
      list, rows: v.rows, totals: v.t,
      complete: v.ok
    };

    viewInput.classList.add('hide');
    viewResult.classList.remove('hide');
  });

  btnBack.addEventListener('click', ()=>{
    viewResult.classList.add('hide');
    viewInput.classList.remove('hide');
  });

  btnNew.addEventListener('click', ()=>{
    auftraggeber.value=''; projekttitel.value=''; auftragswert.value='';
    tbody.innerHTML=''; addRow(true); recalc(); errorsEl.textContent='';
    viewResult.classList.add('hide');
    viewInput.classList.remove('hide');
  });

  btnSave.addEventListener('click', async ()=>{
    const st = window.__lastComputed; if (!st) return;
    const ok = await saveEntry({
      source:'manuell',
      complete: !!st.complete,
      client: st.client || '',
      title:  st.title || '',
      amount: st.amount || 0,
      list:   st.list || [],
      rows:   st.rows || [],
      totals: st.totals || {},
      ts: Date.now()
    });
    if (ok) loadHistory();
  });

  // Init
  addRow(true); addRow(false);
  recalc();
  loadHistory();

  // Enter-Taste in Inputs deaktivieren (kein versehentlicher Submit)
  document.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' && e.target && e.target.tagName === 'INPUT'){
      e.preventDefault();
    }
  });
})();
</script>
</body>
</html>
