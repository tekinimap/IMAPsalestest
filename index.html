<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sales-Beteiligung – Punkte & Prozent</title>
<style>
  :root{
    --bg:#0b0d10; --panel:#12161c; --panel-2:#151b22; --border:#2a313a; --muted:#a0a7b4;
    --text:#e9edf3; --accent:#19b6ff; --danger:#ff6b6b; --ok:#3ddc97; --radius:14px;
    --gap:12px; --gap-lg:18px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:radial-gradient(1200px 800px at 10% -10%, #16202b, #0b0d10 50%) fixed;
    color:var(--text); font:14px/1.45 Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    letter-spacing:.2px;
  }
  .wrap{max-width:1200px; margin:28px auto; padding:0 16px}
  h1{font-size:22px; margin:0 0 10px}
  h2{font-size:16px; margin:22px 0 8px; color:#dfe6ee}
  h3{font-size:14px; margin:16px 0 6px; color:#dfe6ee}
  .muted{color:var(--muted)}
  .small{font-size:12px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .grid{display:grid; grid-template-columns:1fr; gap:var(--gap)}
  .card{
    background:linear-gradient(180deg, var(--panel), var(--panel-2));
    border:1px solid var(--border); border-radius:var(--radius); padding:18px; box-shadow:0 10px 30px rgba(0,0,0,.35);
  }
  .toolbar{display:flex; gap:var(--gap); flex-wrap:wrap; align-items:center}
  .nav{display:flex; gap:8px; align-items:center; margin-bottom:14px}
  .nav .brand{font-weight:700; letter-spacing:.3px; margin-right:auto}
  .btn{
    appearance:none; border:1px solid var(--border); background:#0f141a; color:var(--text);
    padding:10px 14px; border-radius:10px; cursor:pointer; transition:.15s ease; text-decoration:none; display:inline-flex; align-items:center; gap:8px;
  }
  .btn:hover{transform:translateY(-1px); box-shadow:0 8px 20px rgba(0,0,0,.25)}
  .btn.primary{background:var(--accent); border-color:transparent; color:#04121a; font-weight:600}
  .btn.ghost{background:transparent}
  .btn.danger{background:rgba(255,107,107,.1); border-color:#ff9292; color:#ffb3b3}
  .btn:disabled{opacity:.5; cursor:not-allowed; transform:none; box-shadow:none}
  .btn.icon{padding:8px 10px}
  .tag{display:inline-flex; gap:6px; align-items:center; padding:6px 10px; border:1px dashed var(--border); border-radius:999px; background:#0f141a}
  .tag.bad{border-color:#ff9e9e; color:#ffbebe; background:rgba(255,107,107,.08)}
  .row{display:flex; gap:var(--gap); flex-wrap:wrap; align-items:end}
  .field{display:flex; flex-direction:column; gap:6px; min-width:220px}
  input[type="text"], input[type="number"]{
    width:100%; padding:12px 12px; background:#0f141a; border:1px solid var(--border); color:var(--text);
    border-radius:10px; outline:none; transition:border .15s ease, box-shadow .15s ease;
  }
  input[type="number"]{text-align:right}
  table{width:100%; border-collapse:separate; border-spacing:0; margin-top:var(--gap); overflow:hidden; border-radius:12px; border:1px solid var(--border)}
 thead th {background:#10161d; color:#dbe6f2; position:sticky; top:0; z-index:1; text-align:left;}
  thead th.right {text-align:right;  /* Aktion-Spalte bleibt rechts */}

  th, td{padding:10px 10px; border-bottom:1px solid var(--border); vertical-align:middle}
  tfoot td{background:#10161d; font-weight:700}
  .right{text-align:right}
  .hidden{display:none !important}
  .error{color:#ffcccc; background:rgba(255,107,107,.08); border:1px solid #ff9e9e; padding:10px 12px; border-radius:10px}
  .ok{color:var(--ok)}
  .spacer{flex:1}
  .divider{height:1px; background:var(--border); margin:10px 0}
  .chips{display:flex; gap:8px; flex-wrap:wrap}
  .linklike{color:var(--accent); cursor:pointer; text-decoration:underline}
</style>
</head>
<body>
  <div class="wrap">
    <div class="nav">
      <div class="brand">IMAP · Sales-Beteiligung</div>
      <button id="navInput" class="btn ghost">Eingabe</button>
      <button id="navResult" class="btn ghost">Ergebnis</button>
      <button id="navHistory" class="btn ghost">Historie</button>
    </div>

    <!-- Eingabe -->
    <section id="view-input" class="grid">
      <div class="card">
        <h1>Eingabe</h1>
        <div class="muted small">Punkte je Person/Kategorie: 0–100. Wenn eine Kategorie genutzt wird, muss ihre Summe = 100 sein. Gewichtssumme = 100.</div>

        <h2>Rahmendaten</h2>
        <div class="row">
          <label class="field" style="flex:1;min-width:260px">
            <span>Auftraggeber <span class="muted small">(Pflichtfeld)</span></span>
            <input type="text" id="client" placeholder="z. B. DRV Bund" />
          </label>
          <label class="field" style="flex:1;min-width:260px">
            <span>Projekttitel <span class="muted small">(Pflichtfeld)</span></span>
            <input type="text" id="project" placeholder="z. B. Basisprogramm Führungskräfte – Los 4" />
          </label>
          <label class="field" style="flex:1;min-width:240px">
            <span>Schätzung von <span class="muted small">(Pflichtfeld)</span></span>
            <input type="text" id="assessor" placeholder="z. B. Abdi Tekin" />
          </label>
        </div>

        <h2>Gewichtungen (Summe = 100)</h2>
        <div class="row">
          <label class="field" style="width:220px">
            <span>Consultative Selling – %</span>
            <input type="number" id="w_cs" min="0" max="100" step="1" value="50" />
          </label>
          <label class="field" style="width:220px">
            <span>Konzepterstellung – %</span>
            <input type="number" id="w_kz" min="0" max="100" step="1" value="30" />
          </label>
          <label class="field" style="width:220px">
            <span>Pitch – %</span>
            <input type="number" id="w_pi" min="0" max="100" step="1" value="20" />
          </label>
          <div class="field" style="min-width:220px">
            <span class="muted small">Summe Gewichte</span>
            <div id="w_pill" class="tag"><span>∑</span><span id="w_sum">100</span><span>%</span></div>
            <div class="muted small">Berechnung nutzt nur aktive Kategorien; Gewichte werden intern skaliert.</div>
          </div>
        </div>

        <h2>Personen & Punkte</h2>
        <div class="muted small" style="margin-bottom:12px">Zahlen lassen sich entweder direkt eintippen oder durch Klicken und horizontales Ziehen verändern.</div>
        <div class="toolbar">
          <button class="btn" id="addRow">+ Zeile</button>
          <div class="spacer"></div>
          <button class="btn danger" id="resetTable">Tabelle leeren</button>
        </div>

        <table id="tbl">
          <thead>
            <tr>
              <th style="width:260px">Name <span class="muted small">(Pflicht bei Nutzung)</span></th>
              <th class="right">Consultative Selling<br><span class="muted small">Punkte (0–100)</span></th>
              <th class="right">Konzepterstellung<br><span class="muted small">Punkte (0–100)</span></th>
              <th class="right">Pitch<br><span class="muted small">Punkte (0–100)</span></th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr>
              <td class="right"><b>Summe je Kategorie</b></td>
              <td class="right"><span id="sum_cs">0</span></td>
              <td class="right"><span id="sum_kz">0</span></td>
              <td class="right"><span id="sum_pi">0</span></td>
              <td></td>
            </tr>
          </tfoot>
        </table>

        <div id="errors" class="error hidden"></div>

        <div class="toolbar" style="margin-top:12px">
          <div class="spacer"></div>
          <button class="btn primary" id="goResult">Weiter zur Ergebnisansicht</button>
        </div>
      </div>
    </section>

    <!-- Ergebnis -->
    <section id="view-result" class="grid hidden">
      <div class="card">
        <h1>Ergebnis</h1>
        <div class="row">
          <div class="field" style="min-width:260px">
            <h3>Auftraggeber</h3><div id="out_client" class="mono">–</div>
          </div>
          <div class="field" style="min-width:260px">
            <h3>Projekttitel</h3><div id="out_project" class="mono">–</div>
          </div>
          <div class="field" style="min-width:240px">
            <h3>Schätzung von</h3><div id="out_assessor" class="mono">–</div>
          </div>
        </div>

        <div class="row">
          <div class="field" style="min-width:280px">
            <h3>Eingabe-Gewichte (∑ 100)</h3>
            <div id="out_weights_input" class="mono">–</div>
          </div>
          <div class="field" style="min-width:280px">
            <h3>Aktive Gewichte (normalisiert)</h3>
            <div id="out_weights_active" class="mono">–</div>
          </div>
        </div>

        <h2>Prozentuale Beteiligung je Person</h2>
        <table id="tbl_result">
          <thead>
            <tr><th>Person</th><th class="right">Gesamtbeitrag&nbsp;%</th></tr>
          </thead>
          <tbody id="tbody_result"></tbody>
          <tfoot>
            <tr><td class="right"><b>Summe:</b></td><td class="right"><b><span id="sum_pct">100,00</span>&nbsp;%</b></td></tr>
          </tfoot>
        </table>

        <div class="divider"></div>

        <h2>Weitergabe</h2>
        <div class="muted small" style="margin-bottom:12px">Du kannst die berechnete relative Beteiligung der Personen durch anklicken des zugehörigen BUs direkt an die zuständige Person weiterleiten.</div>
        <div class="toolbar">
          <button class="btn" id="copyMsg">Nachricht kopieren</button>
          <div class="spacer"></div>
          <a class="btn" id="btn_oe" target="_blank" rel="noopener">Organisational Excellence</a>
          <a class="btn" id="btn_pi" target="_blank" rel="noopener">Public Impact</a>
          <a class="btn" id="btn_cp" target="_blank" rel="noopener">ChangePartner</a>
        </div>

        <div class="toolbar" style="margin-top:12px">
          <button class="btn" id="back">Zurück</button>
          <div class="spacer"></div>
          <button class="btn primary" id="saveEntry">Speichern</button>
          <button class="btn ghost" id="toHistory">Zur Historie</button>
        </div>
      </div>
    </section>

    <!-- Historie -->
    <section id="view-history" class="grid hidden">
      <div class="card">
        <h1>Historie</h1>
        <div class="muted small">Einträge werden serverseitig gespeichert.</div>
        <table>
          <thead>
            <tr>
              <th>Auftraggeber</th>
              <th>Projekttitel</th>
              <th>Schätzung von</th>
              <th>Zuletzt bearbeitet</th>
              <th class="right">Aktion</th>
            </tr>
          </thead>
          <tbody id="tbody_history"></tbody>
        </table>
        <div class="toolbar" style="margin-top:12px">
          <button class="btn" id="newEntry">Neuer Eintrag</button>
          <div class="spacer"></div>
        </div>
      </div>
    </section>
  </div>

<script>
const API_BASE = "https://imap-sales-worker.tekin-6af.workers.dev";

/* ---------- Utilities ---------- */
const $ = (id)=>document.getElementById(id);
const clamp = (v)=> {
  const n = Math.trunc(Number(v));
  if (Number.isNaN(n)) return 0;
  return Math.max(0, Math.min(100, n));
};
const z2 = n=>String(n).padStart(2,'0');
const fmt2 = n => (Math.round(n*100)/100).toFixed(2);
function formatTs(ts){ const d=new Date(ts); return `${z2(d.getDate())}/${z2(d.getMonth()+1)}/${d.getFullYear()} um ${z2(d.getHours())}:${z2(d.getMinutes())}`; }

/* ---------- Scrubbable Numbers (Drag auf Zahl) ---------- */
function addScrub(input, onChange){
  input.setAttribute('inputmode','numeric');
  input.setAttribute('pattern','[0-9]*');

  let dragging=false, startX=0, startVal=0;
  const step=1;

  function set(v){ input.value = clamp(v); onChange && onChange(); }
  function get(){ return clamp(input.value); }

  input.addEventListener('mousedown', e=>{
    if (e.button!==0) return;            // nur linke Taste
    // Klick soll tippen erlauben; Drag erst bei Bewegung starten
    dragging=true; startX=e.clientX; startVal=get();
    document.body.style.userSelect='none';
    document.body.style.cursor='ew-resize';
  });
  window.addEventListener('mousemove', e=>{
    if(!dragging) return;
    const dx = e.clientX - startX;
    const scale = e.shiftKey ? 2 : (e.altKey ? 0.25 : 1);
    set(startVal + Math.round(dx*scale*step));
  });
  window.addEventListener('mouseup', ()=>{
    if(!dragging) return;
    dragging=false;
    document.body.style.userSelect='';
    document.body.style.cursor='';
  });

  input.addEventListener('wheel', e=>{
    e.preventDefault();
    set(get() + (e.deltaY>0 ? -step : step));
  }, {passive:false});

  input.addEventListener('input', ()=> set(input.value));
}

/* ---------- Views / Refs ---------- */
function show(name){
  $('view-input').classList.toggle('hidden', name!=='input');
  $('view-result').classList.toggle('hidden', name!=='result');
  $('view-history').classList.toggle('hidden', name!=='history');
}
$('navInput').onclick = ()=>show('input');
$('navResult').onclick= ()=>{ renderResult(); show('result'); };
$('navHistory').onclick=()=>{ loadHistory(); show('history'); };

const clientEl=$('client'), projectEl=$('project'), assessorEl=$('assessor');

const wCs=$('w_cs'), wKz=$('w_kz'), wPi=$('w_pi');
const wSum=$('w_sum'), wPill=$('w_pill'), btnGo=$('goResult');

const tbody=$('tbody'), sumCs=$('sum_cs'), sumKz=$('sum_kz'), sumPi=$('sum_pi');
const errors=$('errors');

/* ---------- Gewichte: nur aktives Feld begrenzen ---------- */
function weightSum(){ return clamp(wCs.value)+clamp(wKz.value)+clamp(wPi.value); }
function updateWeightUI(){
  const s = weightSum();
  wSum.textContent=String(s);
  wPill.classList.toggle('bad', s!==100);
  btnGo.disabled = (s!==100);
}
function capActiveWeight(inp){
  const others = [wCs,wKz,wPi].filter(x=>x!==inp);
  const sumOthers = others.reduce((a,x)=>a+clamp(x.value),0);
  const rest = Math.max(0, 100 - sumOthers);
  inp.value = Math.min(clamp(inp.value), rest);
  updateWeightUI();
}
[wCs,wKz,wPi].forEach(inp=>{
  addScrub(inp, ()=>capActiveWeight(inp));
  inp.addEventListener('input', ()=>capActiveWeight(inp));
  inp.addEventListener('change',()=>capActiveWeight(inp));
});
updateWeightUI();

/* ---------- Personen: nur aktives Feld in Spalte begrenzen ---------- */
const cols = { cs:[], kz:[], pi:[] };

function capActiveInColumn(key, el){
  const group = cols[key];
  const sumOthers = group.filter(x=>x!==el).reduce((a,x)=>a+clamp(x.value),0);
  const rest = Math.max(0, 100 - sumOthers);
  el.value = Math.min(clamp(el.value), rest);
  recalcSums();
}

function addRow(data={name:'',cs:0,kz:0,pi:0}){
  const tr=document.createElement('tr');

  const tdName=document.createElement('td');
  const inpName=document.createElement('input');
  inpName.type='text'; inpName.placeholder='Vorname Nachname'; inpName.value=data.name||'';
  tdName.appendChild(inpName);

  function cell(val,key){
    const td=document.createElement('td'); td.className='right';
    const n=document.createElement('input'); n.type='number'; n.min='0'; n.max='100'; n.step='1'; n.value=clamp(val);
    addScrub(n, ()=>capActiveInColumn(key,n));
    n.addEventListener('input',  ()=>{ n.value=clamp(n.value); capActiveInColumn(key,n); });
    n.addEventListener('change', ()=>{ n.value=clamp(n.value); capActiveInColumn(key,n); });
    td.appendChild(n); cols[key].push(n);
    return {td, n};
  }
  const c1=cell(data.cs,'cs');
  const c2=cell(data.kz,'kz');
  const c3=cell(data.pi,'pi');

  const tdAct=document.createElement('td');
  const del=document.createElement('button'); del.className='btn icon'; del.textContent='Entfernen';
  del.onclick=()=>{
    ['cs','kz','pi'].forEach((k,i)=>{
      const ref=[c1.n,c2.n,c3.n][i]; const arr=cols[k]; const idx=arr.indexOf(ref); if(idx>=0) arr.splice(idx,1);
    });
    tr.remove(); recalcSums();
  };
  tdAct.appendChild(del);

  tr.appendChild(tdName); tr.appendChild(c1.td); tr.appendChild(c2.td); tr.appendChild(c3.td); tr.appendChild(tdAct);
  tbody.appendChild(tr);

  // initiale Kappung pro Spalte
  capActiveInColumn('cs', c1.n);
  capActiveInColumn('kz', c2.n);
  capActiveInColumn('pi', c3.n);
  recalcSums();
}

/* ---------- Summen / Validierung ---------- */
function readRows(){
  const out=[];
  tbody.querySelectorAll('tr').forEach(tr=>{
    const tds=tr.querySelectorAll('td');
    if (!tds.length) return;
    const name=tds[0].querySelector('input').value.trim();
    const cs=clamp(tds[1].querySelector('input').value);
    const kz=clamp(tds[2].querySelector('input').value);
    const pi=clamp(tds[3].querySelector('input').value);
    out.push({name,cs,kz,pi});
  });
  return out;
}
function recalcSums(){
  const rows=readRows();
  const s=rows.reduce((a,r)=>{a.cs+=r.cs;a.kz+=r.kz;a.pi+=r.pi;return a;},{cs:0,kz:0,pi:0});
  sumCs.textContent=s.cs; sumKz.textContent=s.kz; sumPi.textContent=s.pi;
  return s;
}
function validate(){
  const errs=[];
  if(!clientEl.value.trim()) errs.push('Auftraggeber fehlt.');
  if(!projectEl.value.trim()) errs.push('Projekttitel fehlt.');
  if(!assessorEl.value.trim()) errs.push('Schätzung von fehlt.');
  if(weightSum()!==100) errs.push('Gewichtssumme muss 100 sein.');

  const rows=readRows();
  if(!rows.some(r=>r.cs||r.kz||r.pi)) errs.push('Mindestens eine Zeile mit Punkten ist erforderlich.');
  rows.forEach((r,i)=>{ if((r.cs+r.kz+r.pi)>0 && !r.name) errs.push(`Name fehlt in Zeile ${i+1}.`); });

  const sums=recalcSums();
  [{k:'Consultative Selling',s:sums.cs},{k:'Konzepterstellung',s:sums.kz},{k:'Pitch',s:sums.pi}]
    .forEach(c=>{ if(c.s>0 && c.s!==100) errs.push(`Kategorie „${c.k}“: Summe = ${c.s}, erforderlich: 100.`); });

  if(errs.length){ errors.innerHTML=errs.map(e=>'• '+e).join('<br>'); errors.classList.remove('hidden'); return false; }
  errors.classList.add('hidden'); return true;
}

/* ---------- Ergebnis ---------- */
function compute(){
  const rows=readRows();
  const sums=recalcSums();
  const active={ cs:sums.cs>0, kz:sums.kz>0, pi:sums.pi>0 };

  const wIn={ cs:clamp(wCs.value), kz:clamp(wKz.value), pi:clamp(wPi.value) };
  let totalWActive=0; if(active.cs) totalWActive+=wIn.cs; if(active.kz) totalWActive+=wIn.kz; if(active.pi) totalWActive+=wIn.pi;

  let wn={cs:0,kz:0,pi:0}; const activeCount=(active.cs?1:0)+(active.kz?1:0)+(active.pi?1:0);
  if(totalWActive===0 && activeCount>0){
    if(active.cs) wn.cs=1/activeCount; if(active.kz) wn.kz=1/activeCount; if(active.pi) wn.pi=1/activeCount;
  } else {
    if(active.cs) wn.cs=wIn.cs/totalWActive; if(active.kz) wn.kz=wIn.kz/totalWActive; if(active.pi) wn.pi=wIn.pi/totalWActive;
  }

  const people=[];
  rows.forEach(r=>{
    if(!(r.cs||r.kz||r.pi)) return;
    let frac=0;
    if(active.cs) frac+=wn.cs*(r.cs/100);
    if(active.kz) frac+=wn.kz*(r.kz/100);
    if(active.pi) frac+=wn.pi*(r.pi/100);
    people.push({name:r.name||'Unbenannt', frac});
  });

  let totalPct=0;
  const pcts=people.map(p=>{ const pct=+(fmt2(p.frac*100)); totalPct+=+pct; return pct; });
  const diff=+(100-totalPct).toFixed(2);
  if(people.length && Math.abs(diff)>=0.01){ pcts[pcts.length-1]=+(pcts[pcts.length-1]+diff).toFixed(2); }

  return {
    input:{ client:clientEl.value.trim(), project:projectEl.value.trim(), assessor:assessorEl.value.trim(), weights:wIn },
    activeWeightsPct:{
      cs:active.cs?+(wn.cs*100).toFixed(2):0,
      kz:active.kz?+(wn.kz*100).toFixed(2):0,
      pi:active.pi?+(wn.pi*100).toFixed(2):0
    },
    people:people.map((p,i)=>({ name:p.name, pct:pcts[i] })),
    rowsRaw:readRows()
  };
}
function setTeamsLink(a, email, message){
  const encoded=encodeURIComponent(message);
  a.href=`https://teams.microsoft.com/l/chat/0/0?users=${encodeURIComponent(email)}&message=${encoded}`;
}
function renderResult(){
  const c=compute();
  $('out_client').textContent=c.input.client||'–';
  $('out_project').textContent=c.input.project||'–';
  $('out_assessor').textContent=c.input.assessor||'–';

  $('out_weights_input').textContent=
    `CS ${fmt2(c.input.weights.cs)}% | KZ ${fmt2(c.input.weights.kz)}% | PI ${fmt2(c.input.weights.pi)}%`;

  const aw=[]; if(c.activeWeightsPct.cs>0) aw.push(`CS ${fmt2(c.activeWeightsPct.cs)}%`);
  if(c.activeWeightsPct.kz>0) aw.push(`KZ ${fmt2(c.activeWeightsPct.kz)}%`);
  if(c.activeWeightsPct.pi>0) aw.push(`PI ${fmt2(c.activeWeightsPct.pi)}%`);
  $('out_weights_active').textContent=aw.join(' | ')||'–';

  const tbodyRes=$('tbody_result'); tbodyRes.innerHTML='';
  let s=0; c.people.forEach(p=>{
    const tr=document.createElement('tr');
    const tdN=document.createElement('td'); tdN.textContent=p.name;
    const tdP=document.createElement('td'); tdP.className='right'; tdP.textContent=fmt2(p.pct)+' %';
    tr.appendChild(tdN); tr.appendChild(tdP); tbodyRes.appendChild(tr); s+=+p.pct;
  });
  $('sum_pct').textContent=fmt2(s);

  const lines=[];
  lines.push(`Auftraggeber: ${c.input.client}`);
  lines.push(`Projekttitel: ${c.input.project}`);
  lines.push(`Schätzung von: ${c.input.assessor}`);
  lines.push(`Eingabe-Gewichte (∑100): CS ${fmt2(c.input.weights.cs)}% | KZ ${fmt2(c.input.weights.kz)}% | PI ${fmt2(c.input.weights.pi)}%`);
  const aw2=[]; if(c.activeWeightsPct.cs>0) aw2.push(`CS ${fmt2(c.activeWeightsPct.cs)}%`);
  if(c.activeWeightsPct.kz>0) aw2.push(`KZ ${fmt2(c.activeWeightsPct.kz)}%`);
  if(c.activeWeightsPct.pi>0) aw2.push(`PI ${fmt2(c.activeWeightsPct.pi)}%`);
  lines.push(`Aktive Gewichte (normalisiert): ${aw2.join(' | ')||'–'}`);
  lines.push(`Beteiligung je Person:`); c.people.forEach(p=>lines.push(`• ${p.name}: ${fmt2(p.pct)}%`));
  const msg=lines.join('\n');

  setTeamsLink($('btn_oe'),'tekin@imap-institut.de',msg);
  setTeamsLink($('btn_pi'),'bartsch@imap-institut.de',msg);
  setTeamsLink($('btn_cp'),'freitag@imap-institut.de',msg);
  $('copyMsg').onclick=async()=>{ try{ await navigator.clipboard.writeText(msg); alert('Nachricht kopiert.'); }catch(e){ alert('Kopieren nicht möglich.'); } };
}

/* ---------- API + Historie ---------- */
async function apiList(){ const r=await fetch(`${API_BASE}/entries`); if(!r.ok) throw new Error('API list failed'); return r.json(); }
async function apiSave(entry){ const r=await fetch(`${API_BASE}/entries`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(entry)}); if(!r.ok) throw new Error('API save failed'); return r.json(); }
async function apiUpdate(id,entry){ const r=await fetch(`${API_BASE}/entries/${encodeURIComponent(id)}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(entry)}); if(!r.ok) throw new Error('API update failed'); return r.json(); }
async function apiDelete(id){ const r=await fetch(`${API_BASE}/entries/${encodeURIComponent(id)}`,{method:'DELETE'}); if(!r.ok) throw new Error('API delete failed'); return r.json(); }

let editingId=null;

function loadEntryIntoForm(e){
  editingId=e.id||null;
  clientEl.value=e.input.client||''; projectEl.value=e.input.project||''; assessorEl.value=e.input.assessor||'';
  wCs.value=e.input.weights.cs; wKz.value=e.input.weights.kz; wPi.value=e.input.weights.pi;
  capActiveWeight(wCs); capActiveWeight(wKz); capActiveWeight(wPi);

  tbody.innerHTML=''; cols.cs.length=0; cols.kz.length=0; cols.pi.length=0;
  (e.rowsRaw||[]).forEach(r=>addRow({name:r.name, cs:r.cs, kz:r.kz, pi:r.pi}));
  if((e.rowsRaw||[]).length===0) addRow();
  recalcSums(); renderResult();
}
async function loadHistory(){
  const list = await apiList();
  list.sort((a,b)=>(b.ts||0)-(a.ts||0));
  const tb=$('tbody_history'); tb.innerHTML='';
  if(!list.length){
    const tr=document.createElement('tr'); const td=document.createElement('td'); td.colSpan=5; td.innerHTML='<span class="muted">Keine Einträge gespeichert.</span>'; tr.appendChild(td); tb.appendChild(tr); return;
  }
  list.forEach(e=>{
    const tr=document.createElement('tr');
    const tdC=document.createElement('td'); tdC.textContent=e.input?.client ?? '';
    const tdP=document.createElement('td'); tdP.textContent=e.input?.project ?? '';
    const tdA=document.createElement('td'); tdA.textContent=e.input?.assessor ?? '';
    const tdT=document.createElement('td'); tdT.textContent=e.ts?formatTs(e.ts):'—';
    const tdAct=document.createElement('td'); tdAct.className='right';
    const btnE=document.createElement('button'); btnE.className='btn'; btnE.textContent='Bearbeiten'; btnE.onclick=()=>{ loadEntryIntoForm(e); show('input'); };
    const btnD=document.createElement('button'); btnD.className='btn danger'; btnD.style.marginLeft='8px'; btnD.textContent='Löschen';
    btnD.onclick=async()=>{ if(!confirm('Eintrag wirklich löschen?')) return; await apiDelete(e.id); await loadHistory(); };
    tdAct.appendChild(btnE); tdAct.appendChild(btnD);
    tr.appendChild(tdC); tr.appendChild(tdP); tr.appendChild(tdA); tr.appendChild(tdT); tr.appendChild(tdAct);
    tb.appendChild(tr);
  });
}

/* ---------- Buttons ---------- */
$('addRow').onclick = ()=>addRow();
$('resetTable').onclick=()=>{
  tbody.innerHTML=''; cols.cs.length=0; cols.kz.length=0; cols.pi.length=0;
};
$('goResult').onclick = ()=>{ if(!validate()) return; renderResult(); show('result'); };
$('back').onclick     = ()=>show('input');
$('toHistory').onclick= ()=>{ loadHistory(); show('history'); };
$('newEntry').onclick = ()=>{
  editingId=null;
  clientEl.value=''; projectEl.value=''; assessorEl.value='';
  wCs.value='50'; wKz.value='30'; wPi.value='20';
  capActiveWeight(wCs); capActiveWeight(wKz); capActiveWeight(wPi);
  tbody.innerHTML=''; cols.cs.length=0; cols.kz.length=0; cols.pi.length=0; addRow(); recalcSums(); show('input');
};
$('saveEntry').onclick= async ()=>{
  if(!validate()) { show('input'); return; }
  const c=compute();
  const entry={ id: editingId||undefined, ts: Date.now(), input: c.input, activeWeightsPct: c.activeWeightsPct, people: c.people, rowsRaw: c.rowsRaw };
  if (editingId) await apiUpdate(editingId, entry);
  else { const res = await apiSave(entry); editingId = res.id; }
  await loadHistory(); show('history');
};

/* ---------- Init ---------- */
addRow();            // <- erste Zeile sichtbar
updateWeightUI();
</script>
</body>
</html>









