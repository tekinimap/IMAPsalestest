<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sales-Beteiligung</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#0a0f16; --panel:#0f1724; --panel2:#0c1320; --text:#e6ebf3; --muted:#94a3b8; --border:#213044;
    --accent:#3b82f6; --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b; --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial}
  .container{max-width:1200px;margin:28px auto;padding:0 16px}
  
  .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px; flex-wrap: wrap; gap: 14px;}
  .main-nav{display:flex;gap:10px; flex-wrap: wrap;}
  .main-nav a{text-decoration:none;padding:8px 14px;border-radius:9px;color:var(--muted);font-weight:500;transition:all .15s}
  .main-nav a:hover{color:var(--text);background:var(--panel2)}
  .main-nav a.active{color:var(--accent);background:rgba(59,130,246,0.1);font-weight:600}
  
  .controls{display:flex;align-items:center;gap:12px;flex-wrap: wrap;}
  .controls .btn{padding:9px 16px;border:none;border-radius:9px;background:var(--accent);color:#fff;font:inherit;font-weight:500;cursor:pointer;transition:all .15s}
  .controls .btn:hover{background:#2563eb}
  .controls .btn.secondary{background:var(--panel2);color:var(--muted)}
  .controls .btn.secondary:hover{background:var(--panel);color:var(--text)}
  .controls .btn.warn{background:var(--bad)}
  .controls .btn.warn:hover{background:#dc2626}
  .controls input[type=file]{display:none}
  
  .loading{text-align:center;padding:40px;font-size:1.2em;color:var(--muted)}
  .error{background:rgba(239,68,68,0.1);color:#f87171;border:1px solid rgba(239,68,68,0.3);padding:14px;border-radius:var(--radius);margin-bottom:16px}
  
  .entries-list{display:grid;gap:18px}
  .entry{background:var(--panel);border-radius:var(--radius);border:1px solid var(--border);overflow:hidden;transition:all .2s;position:relative}
  .entry:hover{border-color:rgba(59,130,246,0.5)}
  .entry.is-complete{background:rgba(34,197,94,0.03);border-color:rgba(34,197,94,0.2)}
  .entry.is-over{background:rgba(239,68,68,0.03);border-color:rgba(239,68,68,0.3)}

  .entry-header{display:flex;justify-content:space-between;align-items:flex-start;padding:18px 20px 14px;gap:14px;cursor:pointer}
  .entry-header h2{font-size:1.2em;font-weight:600;margin:0;line-height:1.3;color:var(--text)}
  .entry-header h2 .client{font-weight:400;color:var(--muted);display:block;font-size:0.9em;margin-top:2px}
  .entry-header .amount{font-size:1.4em;font-weight:600;color:var(--accent);white-space:nowrap}
  .entry-header .amount.is-complete{color:var(--ok)}
  .entry-header .amount.is-over{color:var(--bad)}
  
  .entry-meta{display:flex;gap:14px;align-items:center;padding:0 20px 18px;font-size:0.9em;color:var(--muted);flex-wrap:wrap}
  .entry-meta .tag{background:var(--panel2);padding:4px 8px;border-radius:7px;color:var(--text);font-weight:500}
  .entry-meta .status{font-weight:600;padding:4px 8px;border-radius:7px}
  .entry-meta .status.complete{color:var(--ok);background:rgba(34,197,94,0.1)}
  .entry-meta .status.incomplete{color:var(--warn);background:rgba(245,158,11,0.1)}
  .entry-meta .status.over{color:var(--bad);background:rgba(239,68,68,0.1)}
  
  .entry-details{display:none;padding:10px 20px 20px;border-top:1px solid var(--border)}
  .entry-details h3{font-size:1.1em;font-weight:600;margin:10px 0 12px;color:var(--muted)}
  .entry-details .form-row{display:flex;gap:12px;margin-bottom:12px}
  .entry-details .form-row .form-group{flex:1}
  .entry-details label{display:block;font-size:0.85em;font-weight:500;color:var(--muted);margin-bottom:4px}
  .entry-details input[type=text],
  .entry-details input[type=number],
  .entry-details select{width:100%;background:var(--panel2);border:1px solid var(--border);border-radius:9px;padding:9px 12px;color:var(--text);font:inherit}
  
  .split-list{display:grid;gap:10px;margin-bottom:16px}
  .split-item{display:flex;gap:10px;align-items:center}
  .split-item .name{flex:1}
  .split-item .money{width:100px}
  .split-item .pct{width:80px}
  .split-item .btn{flex-shrink:0}
  
  .split-summary{display:flex;justify-content:flex-end;align-items:center;gap:16px;font-weight:600;padding:10px 0}
  .split-summary .total-pct.over,
  .split-summary .total-money.over{color:var(--bad)}
  .split-summary .total-pct.complete,
  .split-summary .total-money.complete{color:var(--ok)}
  
  .actions{display:flex;justify-content:space-between;align-items:center;padding-top:16px;border-top:1px solid var(--border);margin-top:16px}
  
  .people-select{display:none;position:absolute;background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:6px;z-index:10;
    max-height:200px;overflow-y:auto;box-shadow:0 10px 30px rgba(0,0,0,0.3)}
  .people-select button{display:block;width:100%;text-align:left;padding:8px 12px;border:none;background:transparent;color:var(--text);font:inherit;
    cursor:pointer;border-radius:7px}
  .people-select button:hover{background:var(--accent);color:#fff}
  
  .transactions-list{padding:0;margin:0;list-style:none}
  .transactions-list li{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)}
  .transactions-list li:last-child{border-bottom:none}
  .transactions-list .trans-info .trans-kv{font-weight:500}
  .transactions-list .trans-info .trans-date{font-size:0.85em;color:var(--muted)}
  .transactions-list .trans-amount{font-weight:600;font-size:1.1em}
  
  .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:flex-start;justify-content:center;
    padding-top:10vh;z-index:100;opacity:0;visibility:hidden;transition:all .2s}
  .modal.is-visible{opacity:1;visibility:visible}
  .modal-content{background:var(--panel);border-radius:var(--radius);padding:24px;width:100%;max-width:500px;
    border:1px solid var(--border);box-shadow:0 10px 30px rgba(0,0,0,0.3)}
  .modal-content h2{margin:0 0 16px;font-size:1.3em}
  .modal-actions{display:flex;justify-content:flex-end;gap:12px;margin-top:20px}
</style>
</head>
<body>

<div class="container">
  <div class="topbar">
    <nav class="main-nav">
      <a href="#fix" class="active">Fixaufträge</a>
      <a href="#rahmen">Rahmenaufträge</a>
      <a href="#people">Personen</a>
      <a href="#log">Logbuch</a>
    </nav>
    <div class="controls">
      <input type="file" id="file-import" accept=".xlsx, .xls" onchange="handleFileImport(event)"/>
      <button class="btn secondary" onclick="document.getElementById('file-import').click()">Excel Import</button>
      <button class="btn" id="btn-new-entry">Neuer Eintrag</button>
      <button class="btn" id="btn-save-all">Alle Speichern</button>
    </div>
  </div>

  <div id="error-container" class="error" style="display:none;"></div>
  <div id="loading-indicator" class="loading">Lade Einträge...</div>
  
  <div class="entries-list" id="entries-list">
    </div>
</div>

<div id="modal-new-entry" class="modal">
  <div class="modal-content">
    <h2>Neuer Eintrag</h2>
    <div class="form-row">
      <div class="form-group" style="flex:2">
        <label for="new-title">Titel</label>
        <input type="text" id="new-title" placeholder="Projektname">
      </div>
      <div class="form-group" style="flex:1">
        <label for="new-amount">Betrag (€)</label>
        <input type="number" id="new-amount" placeholder="10000">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group" style="flex:2">
        <label for="new-client">Kunde</label>
        <input type="text" id="new-client" placeholder="Kundenname">
      </div>
      <div class="form-group" style="flex:1">
        <label for="new-projectNumber">Projektnummer</label>
        <input type="text" id="new-projectNumber" placeholder="KND-01-001">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label for="new-kv">KV-Nummer</label>
        <input type="text" id="new-kv" placeholder="KV-2025-001">
      </div>
      <div class="form-group">
        <label for="new-projectType">Typ</label>
        <select id="new-projectType">
          <option value="fix">Fixauftrag</option>
          <option value="rahmen">Rahmenauftrag</option>
        </select>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn secondary" data-close-modal>Abbrechen</button>
      <button class="btn" id="btn-create-entry">Erstellen</button>
    </div>
  </div>
</div>

<template id="entry-template">
  <div class="entry" data-id="">
    <div class="entry-header">
      <div class="header-info">
        <h2>
          <span class="title">Titel des Eintrags</span>
          <span class="client">Kunde</span>
        </h2>
      </div>
      <div class="amount">10.000,00 €</div>
    </div>
    <div class="entry-meta">
      <span class="tag kv">KV-001</span>
      <span class="tag project-number">PRJ-001</span>
      <span class="tag submitted-by">Eingereicht von...</span>
      <span class="status"></span>
    </div>
    <div class="entry-details">
      <h3>Stammdaten</h3>
      <div class="form-row">
        <div class="form-group" style="flex:2">
          <label>Titel</label>
          <input type="text" class="edit-title" data-field="title">
        </div>
        <div class="form-group" style="flex:1">
          <label>Betrag (€)</label>
          <input type="number" class="edit-amount" data-field="amount">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group" style="flex:2">
          <label>Kunde</label>
          <input type="text" class="edit-client" data-field="client">
        </div>
        <div class="form-group" style="flex:1">
          <label>Projektnummer</label>
          <input type="text" class="edit-projectNumber" data-field="projectNumber">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group" style="flex:1">
          <label>KV-Nummern (Komma-getrennt)</label>
          <input type="text" class="edit-kv" data-field="kvNummern">
        </div>
         <div class="form-group" style="flex:1">
          <label>Eingereicht von (HubSpot Owner)</label>
          <input type="text" class="edit-submittedBy" data-field="submittedBy" readonly>
        </div>
      </div>
      
      <h3>Sales-Beteiligung (<span class="split-count">0</span> Personen)</h3>
      <div class="split-list">
        </div>
      <div class="split-summary">
        <span class="total-pct">Total: 0%</span>
        <span class="total-money">Total: 0,00 €</span>
      </div>
      <button class="btn secondary btn-add-person">+ Person hinzufügen</button>
      
      <div class="transactions-container" style="display:none;">
        <h3>Transaktionen</h3>
        <ul class="transactions-list"></ul>
      </div>

      <div class="actions">
        <button class="btn warn btn-delete">Eintrag Löschen</button>
        <button class="btn btn-save">Speichern</button>
      </div>
    </div>
  </div>
</template>

<template id="split-item-template">
  <div class="split-item" data-key="">
    <div class="name">
      <select class="split-name">
        </select>
    </div>
    <div class="money">
      <input type="number" class="split-money" placeholder="Betrag (€)">
    </div>
    <div class="pct">
      <input type="number" class="split-pct" placeholder="Prozent (%)">
    </div>
    <button class="btn warn secondary btn-remove-person" style="padding: 9px 12px;">X</button>
  </div>
</template>


<script>
(function() {
  // Config
  const API_BASE = window.WORKER_BASE || '';
  const API_ENDPOINTS = {
    entries: `${API_BASE}/entries`,
    people: `${API_BASE}/people`,
    logs: `${API_BASE}/logs`,
    bulk: `${API_BASE}/entries/bulk`,
  };
  
  // State
  let allEntries = [];
  let allPeople = [];
  let dirtyEntries = new Set();
  let currentView = 'fix';
  
  // Utils
  const $ = (selector, context = document) => context.querySelector(selector);
  const $$ = (selector, context = document) => Array.from(context.querySelectorAll(selector));
  const fNum = (n) => (n || 0).toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  const fDate = (ts) => ts ? new Date(ts).toLocaleDateString('de-DE') : 'N/A';
  const debounce = (fn, delay) => {
    let timeout;
    return (...args) => {
      clearTimeout(timeout);
      timeout = setTimeout(() => fn(...args), delay);
    };
  };

  // --- API Functions ---
  
  async function api(endpoint, method = 'GET', body = null) {
    const headers = { 'Content-Type': 'application/json' };
    const options = {
      method,
      headers,
      body: body ? JSON.stringify(body) : null
    };
    try {
      const res = await fetch(endpoint, options);
      if (!res.ok) {
        const errData = await res.json().catch(() => ({ error: 'Unknown error' }));
        throw new Error(errData.message || errData.error || `HTTP error ${res.status}`);
      }
      if (res.status === 204) return null;
      return res.json();
    } catch (e) {
      showError(e.message);
      console.error('API Error:', e);
      throw e;
    }
  }

  async function loadInitialData() {
    $('#loading-indicator').style.display = 'block';
    $('#entries-list').innerHTML = '';
    try {
      const [entries, people] = await Promise.all([
        api(API_ENDPOINTS.entries),
        api(API_ENDPOINTS.people)
      ]);
      allEntries = entries.sort((a, b) => (b.ts || 0) - (a.ts || 0));
      allPeople = people.sort((a, b) => a.name.localeCompare(b.name));
      renderView();
    } catch (e) {
      // Fehler wird schon von api() angezeigt
    } finally {
      $('#loading-indicator').style.display = 'none';
    }
  }

  async function saveAllChanges() {
    const savePromises = [];
    for (const entryId of dirtyEntries) {
      const entry = allEntries.find(e => e.id === entryId);
      if (entry) {
        savePromises.push(api(`${API_ENDPOINTS.entries}/${entry.id}`, 'PUT', entry));
      }
    }
    if (savePromises.length === 0) return;
    
    console.log(`Speichere ${savePromises.length} Einträge...`);
    try {
      await Promise.all(savePromises);
      dirtyEntries.clear();
      $('#btn-save-all').classList.remove('warn');
      console.log('Speichern erfolgreich.');
    } catch (e) {
      showError(`Fehler beim Speichern: ${e.message}`);
    }
  }
  
  async function createNewEntry(entryData) {
    try {
      const newEntry = await api(API_ENDPOINTS.entries, 'POST', entryData);
      allEntries.unshift(newEntry); // Oben einfügen
      renderView();
    } catch(e) {
      showError(`Fehler beim Erstellen: ${e.message}`);
    }
  }
  
  async function deleteEntry(entryId) {
    if (!confirm('Sind Sie sicher, dass Sie diesen Eintrag löschen möchten?')) return;
    try {
      await api(`${API_ENDPOINTS.entries}/${entryId}`, 'DELETE');
      allEntries = allEntries.filter(e => e.id !== entryId);
      dirtyEntries.delete(entryId);
      renderView();
    } catch(e) {
      showError(`Fehler beim Löschen: ${e.message}`);
    }
  }
  
  // --- State & Calculations ---
  
  // ##################################################################
  // ### KORREKTUR HIER (v8.7) ###
  // ##################################################################
  // Die Logik in dieser Funktion (Zeile 428) war der Fehler.
  
  function getEntryState(entry) {
    if (!entry) return { isComplete: false, totalPct: 0, totalMoney: 0 };
    
    let totalPct = 0;
    let totalMoney = 0;
    // Wir holen die Länge der Liste
    const listLength = (entry.list && entry.list.length > 0) ? entry.list.length : 0;
    
    if (listLength > 0) {
      for (const item of entry.list) {
        totalPct += (parseFloat(item.pct) || 0);
        totalMoney += (parseFloat(item.money) || 0);
      }
    }

    totalMoney = Math.round(totalMoney * 100) / 100;
    totalPct = Math.round(totalPct * 100) / 100;
    
    const isComplete = (
      entry.projectType === 'rahmen' || 
      (Math.abs(totalPct - 100) < 0.05) || 
      (totalMoney > 0 && Math.abs(totalMoney - (entry.amount || 0)) < 0.05) ||
      // --- KORRIGIERTE BEDINGUNG ---
      // Ein 0€-Auftrag ist nur "vollständig", wenn der Betrag 0 ist
      // UND die Liste der Mitarbeiter LEER ist (listLength === 0).
      // Wenn Mitarbeiter zugewiesen sind (listLength > 0), ist er unvollständig.
      (entry.amount === 0 && totalMoney === 0 && totalPct === 0 && listLength === 0)
    );
    
    const isOver = (totalPct > 100.05) || (totalMoney > 0.05 + (entry.amount || 0));
    
    return { isComplete, isOver, totalPct, totalMoney };
  }
  
  // ##################################################################
  // ### ENDE DER KORREKTUR ###
  // ##################################################################


  // --- Rendering ---

  function renderView() {
    const listEl = $('#entries-list');
    listEl.innerHTML = '';
    
    const filteredEntries = allEntries.filter(e => {
      if (currentView === 'fix') return e.projectType !== 'rahmen';
      if (currentView === 'rahmen') return e.projectType === 'rahmen';
      return false; // Für 'people' und 'log' (noch nicht implementiert)
    });
    
    if (filteredEntries.length === 0) {
      $('#loading-indicator').textContent = 'Keine Einträge gefunden.';
      $('#loading-indicator').style.display = 'block';
      return;
    }
    
    filteredEntries.forEach(entry => {
      const el = createEntryElement(entry);
      listEl.appendChild(el);
    });
  }

  function createEntryElement(entry) {
    const template = $('#entry-template').content.cloneNode(true);
    const entryEl = template.querySelector('.entry');
    entryEl.dataset.id = entry.id;
    
    const state = getEntryState(entry);
    
    // Header
    entryEl.classList.toggle('is-complete', state.isComplete);
    entryEl.classList.toggle('is-over', state.isOver);
    $('.title', entryEl).textContent = entry.title || 'Kein Titel';
    $('.client', entryEl).textContent = entry.client || 'Kein Kunde';
    const amountEl = $('.amount', entryEl);
    amountEl.textContent = `${fNum(entry.amount)} €`;
    amountEl.classList.toggle('is-complete', state.isComplete);
    amountEl.classList.toggle('is-over', state.isOver);
    
    // Meta
    const kv = (Array.isArray(entry.kvNummern) && entry.kvNummern.length > 0) ? entry.kvNummern.join(', ') : (entry.kv || entry.kv_nummer || 'N/A');
    $('.kv', entryEl).textContent = kv;
    $('.project-number', entryEl).textContent = entry.projectNumber || 'N/A';
    
    const submittedByEl = $('.submitted-by', entryEl);
    if (entry.submittedBy) {
      submittedByEl.textContent = `Owner: ${entry.submittedBy}`;
    } else {
      submittedByEl.style.display = 'none';
    }
    
    const statusEl = $('.status', entryEl);
    if (state.isComplete) {
      statusEl.textContent = 'Vollständig';
      statusEl.className = 'status complete';
    } else if (state.isOver) {
      statusEl.textContent = `Überbucht (${state.totalPct}%)`;
      statusEl.className = 'status over';
    } else {
      statusEl.textContent = `Unvollständig (${state.totalPct}%)`;
      statusEl.className = 'status incomplete';
    }

    // Details (Stammdaten)
    $('.edit-title', entryEl).value = entry.title || '';
    $('.edit-amount', entryEl).value = entry.amount || 0;
    $('.edit-client', entryEl).value = entry.client || '';
    $('.edit-projectNumber', entryEl).value = entry.projectNumber || '';
    $('.edit-kv', entryEl).value = kv;
    $('.edit-submittedBy', entryEl).value = entry.submittedBy || (entry.source === 'hubspot' ? 'HubSpot' : '');
    
    // Details (Beteiligungsliste)
    const splitListEl = $('.split-list', entryEl);
    if (entry.list && entry.list.length > 0) {
      entry.list.forEach(item => {
        const itemEl = createSplitItemElement(item, entry);
        splitListEl.appendChild(itemEl);
      });
    }
    updateSplitSummary(entryEl, entry);
    
    // Transaktionen (für Rahmenaufträge)
    if (entry.projectType === 'rahmen') {
      $('.transactions-container', entryEl).style.display = 'block';
      const transListEl = $('.transactions-list', entryEl);
      transListEl.innerHTML = ''; // Leeren
      if (entry.transactions && entry.transactions.length > 0) {
        entry.transactions.forEach(t => {
          const li = document.createElement('li');
          li.innerHTML = `
            <div class="trans-info">
              <div class="trans-kv">${t.kv_nummer || 'N/A'}</div>
              <div class="trans-date">${fDate(t.ts)}</div>
            </div>
            <div class="trans-amount">${fNum(t.amount)} €</div>
          `;
          transListEl.appendChild(li);
        });
      } else {
        transListEl.innerHTML = '<li>Keine Transaktionen gefunden.</li>';
      }
    }

    return entryEl;
  }
  
  function createSplitItemElement(item, entry) {
    const template = $('#split-item-template').content.cloneNode(true);
    const itemEl = template.querySelector('.split-item');
    itemEl.dataset.key = item.key || `item_${Date.now()}_${Math.random()}`;
    
    const selectEl = $('.split-name', itemEl);
    selectEl.innerHTML = '<option value="">--- Bitte wählen ---</option>';
    allPeople.forEach(p => {
      const option = document.createElement('option');
      option.value = p.name;
      option.textContent = `${p.name} (${p.team})`;
      if (p.name === item.name) {
        option.selected = true;
      }
      selectEl.appendChild(option);
    });
    
    $('.split-money', itemEl).value = item.money || '';
    $('.split-pct', itemEl).value = item.pct || '';
    
    // Referenz zum Haupt-Eintrag speichern
    itemEl.closest('.entry')._entry = entry;
    
    return itemEl;
  }
  
  function updateSplitSummary(entryEl, entry) {
    const state = getEntryState(entry);
    const splitListEl = $('.split-list', entryEl);
    $('.split-count', entryEl).textContent = (entry.list || []).length;
    
    const totalPctEl = $('.total-pct', entryEl);
    totalPctEl.textContent = `Total: ${fNum(state.totalPct)}%`;
    totalPctEl.className = 'total-pct';
    if (state.isComplete) totalPctEl.classList.add('complete');
    if (state.isOver) totalPctEl.classList.add('over');
    
    const totalMoneyEl = $('.total-money', entryEl);
    totalMoneyEl.textContent = `Total: ${fNum(state.totalMoney)} €`;
    totalMoneyEl.className = 'total-money';
    if (state.isComplete) totalMoneyEl.classList.add('complete');
    if (state.isOver) totalMoneyEl.classList.add('over');
  }
  
  function showError(message) {
    const el = $('#error-container');
    el.textContent = message;
    el.style.display = 'block';
    setTimeout(() => { el.style.display = 'none'; }, 5000);
  }

  // --- Event Handlers ---
  
  function onEntryToggle(e) {
    const header = e.target.closest('.entry-header');
    if (!header) return;
    const entryEl = header.closest('.entry');
    const detailsEl = $('.entry-details', entryEl);
    detailsEl.style.display = detailsEl.style.display === 'block' ? 'none' : 'block';
  }
  
  function onEntryChange(e) {
    const target = e.target;
    const entryEl = target.closest('.entry');
    if (!entryEl) return;
    
    const entryId = entryEl.dataset.id;
    const entry = allEntries.find(e => e.id === entryId);
    if (!entry) return;
    
    // Flag als geändert markieren
    dirtyEntries.add(entryId);
    $('#btn-save-all').classList.add('warn');
    
    // Stammdaten aktualisieren
    if (target.dataset.field) {
      const field = target.dataset.field;
      if (field === 'kvNummern') {
        entry.kvNummern = target.value.split(',').map(kv => kv.trim()).filter(Boolean);
        // Auch die alten Felder für Abwärtskompatibilität aktualisieren
        entry.kv_nummer = entry.kvNummern[0] || '';
        entry.kv = entry.kv_nummer;
      } else {
        entry[field] = target.value;
      }
    }
    
    // Split-Liste aktualisieren
    if (target.classList.contains('split-name') || target.classList.contains('split-money') || target.classList.contains('split-pct')) {
      const itemEl = target.closest('.split-item');
      const key = itemEl.dataset.key;
      
      // Finde das Item in der Entry-Liste
      let item = entry.list.find(i => i.key === key);
      if (!item) { // Sollte nicht passieren, aber sicher ist sicher
        item = { key };
        entry.list.push(item);
      }
      
      // Aktualisiere das Item-Objekt
      item.name = $('.split-name', itemEl).value;
      item.money = parseFloat($('.split-money', itemEl).value) || 0;
      item.pct = parseFloat($('.split-pct', itemEl).value) || 0;
      
      // Auto-Kalkulation
      const entryAmount = parseFloat(entry.amount) || 0;
      if (target.classList.contains('split-money') && entryAmount > 0) {
        // Geld ändert Prozent
        item.pct = (item.money / entryAmount) * 100;
        $('.split-pct', itemEl).value = fNum(item.pct);
      } else if (target.classList.contains('split-pct') && entryAmount > 0) {
        // Prozent ändert Geld
        item.money = (item.pct / 100) * entryAmount;
        $('.split-money', itemEl).value = fNum(item.money);
      }
      
      updateSplitSummary(entryEl, entry);
    }
  }

  function onAddPerson(e) {
    const entryEl = e.target.closest('.entry');
    if (!entryEl) return;
    
    const entryId = entryEl.dataset.id;
    const entry = allEntries.find(e => e.id === entryId);
    if (!entry) return;
    
    if (!entry.list) entry.list = [];
    const newItem = {
      key: `new_${Date.now()}`,
      name: '',
      money: 0,
      pct: 0
    };
    entry.list.push(newItem);
    
    const itemEl = createSplitItemElement(newItem, entry);
    $('.split-list', entryEl).appendChild(itemEl);
    
    dirtyEntries.add(entryId);
    $('#btn-save-all').classList.add('warn');
    updateSplitSummary(entryEl, entry);
  }
  
  function onRemovePerson(e) {
    const itemEl = e.target.closest('.split-item');
    const entryEl = e.target.closest('.entry');
    if (!itemEl || !entryEl) return;
    
    const entryId = entryEl.dataset.id;
    const entry = allEntries.find(e => e.id === entryId);
    const key = itemEl.dataset.key;
    if (!entry || !entry.list) return;
    
    entry.list = entry.list.filter(i => i.key !== key);
    itemEl.remove();
    
    dirtyEntries.add(entryId);
    $('#btn-save-all').classList.add('warn');
    updateSplitSummary(entryEl, entry);
  }
  
  function onSaveEntry(e) {
    const entryEl = e.target.closest('.entry');
    if (!entryEl) return;
    const entryId = entryEl.dataset.id;
    
    // Manuelles Triggern des SaveAll, aber nur für dieses eine
    // (einfacher als Einzel-Save-Logik, da onEntryChange schon alles in allEntries aktualisiert hat)
    if (dirtyEntries.has(entryId)) {
      saveAllChanges();
    }
  }
  
  function onDeleteEntry(e) {
    const entryEl = e.target.closest('.entry');
    if (!entryEl) return;
    deleteEntry(entryEl.dataset.id);
  }
  
  function setupNav() {
    $$('.main-nav a').forEach(a => {
      a.addEventListener('click', e => {
        e.preventDefault();
        $$('.main-nav a').forEach(link => link.classList.remove('active'));
        a.classList.add('active');
        currentView = a.hash.substring(1);
        
        const showList = (currentView === 'fix' || currentView === 'rahmen');
        $('#entries-list').style.display = showList ? 'grid' : 'none';
        $('.controls').style.display = showList ? 'flex' : 'none';
        
        if (showList) {
          renderView();
        } else {
          // Andere Ansichten (People, Log) hier laden
          $('#loading-indicator').textContent = `${a.textContent} Ansicht noch nicht implementiert.`;
          $('#loading-indicator').style.display = 'block';
        }
      });
    });
  }
  
  function setupModal() {
    const modal = $('#modal-new-entry');
    $('#btn-new-entry').addEventListener('click', () => modal.classList.add('is-visible'));
    $$('[data-close-modal]').forEach(el => el.addEventListener('click', () => modal.classList.remove('is-visible')));
    
    $('#btn-create-entry').addEventListener('click', () => {
      const entryData = {
        title: $('#new-title').value || 'Neuer Eintrag',
        amount: parseFloat($('#new-amount').value) || 0,
        client: $('#new-client').value || '',
        projectNumber: $('#new-projectNumber').value || '',
        kvNummern: ($('#new-kv').value || '').split(',').map(kv => kv.trim()).filter(Boolean),
        projectType: $('#new-projectType').value || 'fix',
        source: 'manuell',
        ts: Date.now(),
        list: []
      };
      
      createNewEntry(entryData);
      modal.classList.remove('is-visible');
      // Formular zurücksetzen
      $('#new-title').value = '';
      $('#new-amount').value = '';
      $('#new-client').value = '';
      $('#new-projectNumber').value = '';
      $('#new-kv').value = '';
    });
  }
  
  async function handleFileImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    showError('Lese Excel-Datei...'); // Temporäre Info
    const data = await file.arrayBuffer();
    const workbook = XLSX.read(data);
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const json = XLSX.utils.sheet_to_json(worksheet, { raw: false }); // raw: false für formatierte Daten (z.B. Datum)
    
    if (!json || json.length === 0) {
      showError('Keine Daten in der Excel-Datei gefunden.');
      return;
    }
    
    // Konvertiere Excel-Spaltennamen in unsere Feldnamen
    const mappedRows = json.map(row => ({
      kv: row['KV-Nummer'] || row['KV'] || row['kv'],
      projectNumber: row['Projektnummer'] || row['Projekt-Nr.'] || '',
      title: row['Titel'] || row['Projekt'] || '',
      client: row['Kunde'] || '',
      amount: parseFloat(String(row['Betrag']).replace(/,/g, '.')) || 0, // Robustere Zahl-Konvertierung
      source: 'erp-import',
      freigabedatum: row['Freigabedatum'] ? new Date(row['Freigabedatum']).getTime() : null
    }));
    
    // Filtere leere Zeilen
    const validRows = mappedRows.filter(r => r.kv && r.amount > 0);
    
    if (validRows.length === 0) {
      showError('Keine gültigen Zeilen (mit KV-Nummer und Betrag) gefunden.');
      return;
    }

    try {
      showError(`Importiere ${validRows.length} Zeilen...`);
      const res = await api(API_ENDPOINTS.bulk, 'POST', { rows: validRows });
      showError(`Import erfolgreich: ${res.created} erstellt, ${res.updated} aktualisiert, ${res.skipped} übersprungen.`);
      // Daten neu laden, um Änderungen zu sehen
      loadInitialData();
    } catch (e) {
      showError(`Importfehler: ${e.message}`);
    } finally {
      // Input zurücksetzen, um dieselbe Datei erneut hochladen zu können
      event.target.value = null;
    }
  }
  window.handleFileImport = handleFileImport; // Global verfügbar machen
  

  // --- Init ---
  
  function init() {
    // Globale Event Listener (Event Delegation)
    const listEl = $('#entries-list');
    listEl.addEventListener('click', onEntryToggle);
    listEl.addEventListener('click', onAddPerson, { selector: '.btn-add-person' }); // polyfill selector
    listEl.addEventListener('click', onRemovePerson, { selector: '.btn-remove-person' }); // polyfill selector
    listEl.addEventListener('click', onSaveEntry, { selector: '.btn-save' }); // polyfill selector
    listEl.addEventListener('click', onDeleteEntry, { selector: '.btn-delete' }); // polyfill selector
    listEl.addEventListener('change', onEntryChange); // Für Inputs und Selects

    // Polyfill für Event Delegation (vereinfacht)
    // Überschreibt die nativen Methoden, um einen 'selector' zu unterstützen
    const originalAddEventListener = Element.prototype.addEventListener;
    Element.prototype.addEventListener = function(type, listener, options) {
      if (options && options.selector) {
        originalAddEventListener.call(this, type, e => {
          if (e.target && e.target.matches(options.selector)) {
            listener.call(this, e);
          }
        }, options);
      } else {
        originalAddEventListener.call(this, type, listener, options);
      }
    };
    
    $('#btn-save-all').addEventListener('click', saveAllChanges);
    window.addEventListener('beforeunload', e => {
      if (dirtyEntries.size > 0) {
        e.preventDefault();
        e.returnValue = 'Sie haben ungespeicherte Änderungen. Sind Sie sicher, dass Sie die Seite verlassen möchten?';
      }
    });
    
    setupNav();
    setupModal();
    loadInitialData();
  }
  
  document.addEventListener('DOMContentLoaded', init);

})();
</script>
<script>
(function() {
  const LOGBOOK2 = {
    queue: [],
    endpoint: (window.WORKER_BASE || '') + '/log',
    timer: null,
    
    add: function(logEntry) {
      this.queue.push({ ...logEntry, ts: Date.now() });
      if (!this.timer) {
        this.timer = setTimeout(() => this.flush(), 2000);
      }
    },
    
    flush: async function() {
      if (this.timer) {
        clearTimeout(this.timer);
        this.timer = null;
      }
      if (this.queue.length === 0) return;
      
      const linesToFlush = [...this.queue];
      this.queue = [];
      
      const linesByDate = {};
      linesToFlush.forEach(line => {
        const dateStr = new Date(line.ts).toISOString().slice(0, 10);
        if (!linesByDate[dateStr]) {
          linesByDate[dateStr] = [];
        }
        linesByDate[dateStr].push(JSON.stringify(line));
      });
      
      try {
        for (const [date, lines] of Object.entries(linesByDate)) {
          await fetch(this.endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ date: date, lines: lines })
          });
        }
      } catch (e) {
        console.error('Logbook v2 flush failed, re-queuing...', e);
        this.queue = [...linesToFlush, ...this.queue]; // Fehlgeschlagene zurück in die Queue
      }
    }
  };

  // Globales Fetch-Intercepting für Logging
  const originalFetch = window.fetch;
  window.fetch = async function(resource, options) {
    let res;
    try {
      res = await originalFetch(resource, options);
    } catch (e) {
      // Netzwerkfehler
      try {
        const url = new URL(String(resource));
        const method = options?.method || 'GET';
        if (url.pathname.startsWith('/entries')) {
           LOGBOOK2.add({ event:'error', reason:'network_error', detail: e.message, method, path: url.pathname });
        }
      } catch {}
      throw e;
    }

    try {
      const url = new URL(String(resource));
      const method = options?.method || 'GET';
      const isEntries = url.pathname.startsWith('/entries');
      const isTrans = url.pathname.startsWith('/transactions');

      if (isEntries || isTrans) {
        let before, after, body, id;
        
        if (method === 'PUT' || method === 'DELETE') {
          id = url.pathname.split('/').pop();
          before = window.allEntries?.find(e => e.id === id); // Annahme: allEntries ist global
        }
        if (method === 'PUT' || method === 'POST') {
          after = await res.clone().json().catch(() => null);
          body = JSON.parse(options.body || '{}');
        }
        if (method === 'DELETE') {
           body = JSON.parse(options.body || '{}');
        }

        // Finde Felder für den Log
        const fBody = window.fieldsOf ? window.fieldsOf(body) : {};
        const fBefore = window.fieldsOf ? window.fieldsOf(before) : {};
        const fAfter = window.fieldsOf ? window.fieldsOf(after) : {};
        
        const common = {
          source: (after?.source || before?.source || body?.source || (after?.hubspotId?'hubspot':'') || (before?.hubspotId?'hubspot':'')),
          kv: fAfter.kv || fBefore.kv || fBody.kv || '',
          projectNumber: fAfter.projectNumber || fBefore.projectNumber || fBody.projectNumber || '',
          title: fAfter.title || fBefore.title || fBody.title || '',
          client: fAfter.client || fBefore.client || fBody.client || '',
          entryId: id || after?.id || body?.id || ''
        };

        if (res && res.ok) {
          if (method==='POST' && isEntries) {
            LOGBOOK2.add({ event:'create', after, ...common });
          } else if (method==='PUT' && isEntries) {
            LOGBOOK2.add({ event:'update', before, after, ...common });
          } else if (method==='DELETE') {
            LOGBOOK2.add({ event:'delete', before, ...common, reason: isTrans?'delete.transaction':'delete.entry' });
          }
        } else if (method!=='GET') {
          LOGBOOK2.add({ event:'skip', before, ...common, reason:'http_error', detail:`HTTP ${res?.status||'?'}` });
        }
      }
    } catch(e) {
      console.warn('LOGBOOK2 interceptor warn', e);
    }

    return res;
  };

  // expose flush for importer batches
  window.flushLogbook = ()=> LOGBOOK2.flush();
})();
</script>
<script>
  // Setzen Sie dies auf die URL Ihres Workers
  window.WORKER_BASE = 'https://imap-sales-worker.tekin-6af.workers.dev';
</script>
</body>
</html>
