<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sales-Beteiligung</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#0a0f16; --panel:#0f1724; --panel2:#0c1320; --text:#e6ebf3; --muted:#94a3b8; --border:#213044;
    --accent:#3b82f6; --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b; --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial}
  .container{max-width:1200px;margin:28px auto;padding:0 16px}
  
  .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px; flex-wrap: wrap; gap: 14px;}
  .main-nav{display:flex;gap:10px; flex-wrap: wrap;}
  .nav-link{font-size:14px;font-weight:600;color:#cbd5e1;padding:8px 14px;border:1px solid var(--border);border-radius:999px;background:#0b1326;cursor:pointer; text-decoration: none;}
  .nav-link:hover{background-color: var(--panel2);}
  .nav-link.active{background:var(--accent); color: var(--text); border-color: var(--accent);}
  .nav-link.disabled{opacity:.45;cursor:not-allowed;filter:grayscale(35%)}

  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 12px 32px rgba(0,0,0,.35);overflow:hidden;margin-bottom:18px}
  .hd{padding:20px 22px 8px}.hd h1{margin:0 0 8px;font-size:24px}.hd p{margin:0;color:var(--muted);font-size:14px}
  .ct{padding:20px 22px 24px}
  
  .sum-display { font-size: 18px; font-weight: 600; color: var(--muted); margin-top: -8px; margin-bottom: 8px; }
  .sum-display span { color: var(--text); font-size: 20px; }

  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  label{display:block;font-weight:600;margin:8px 0 6px}
  input[type="text"],input[type="number"],input[type="date"],select{
    width:100%;background:var(--panel2);color:var(--text);border:1px solid var(--border);
    border-radius:10px;padding:12px;outline:none; font-size:15px;
  }
  input:disabled { background-color: #0a0f16; opacity: 0.6; }
  input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.35)}
  .note{color:var(--muted);font-size:13px; margin-top: 8px;}
  .info-box{background: var(--panel2); border: 1px solid var(--border); padding: 12px; border-radius: 10px; font-size: 13px; color: var(--muted); margin-bottom: 16px;}
  .actions{display:flex;gap:12px;flex-wrap:wrap;justify-content:space-between;align-items:center}
  .btn{appearance:none;border:1px solid var(--border);background:#0d1426;color:var(--text);padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:600; font-size:15px;}
  .btn.primary{background:var(--accent);border-color:transparent}
  .btn.disabled{opacity:.5;pointer-events:none}
  .btn.ok{background:var(--ok);border-color:transparent}
  .btn.danger{background:var(--bad);border-color:transparent}
  .btn.warn{background:var(--warn);border-color:transparent}
  .tag{background:#0c162b;border:1px solid var(--border);color:var(--muted);padding:8px 12px;border-radius:999px;font-size:13px}
  
  .radio-group {display:flex; gap:12px; margin-top: 8px;}
  .radio-group label {display:flex; align-items:center; gap:6px; font-weight:normal; font-size:14px;}

  .table-wrapper{width:100%;border:1px solid var(--border);border-radius:12px;overflow-x:auto;background:#0b1120}
  table{width:100%;min-width:980px;border-collapse:collapse}
  thead th{position:sticky;top:0;background:#0d162a;border-bottom:1px solid var(--border);padding:12px;text-align:left;font-size:13px}
  tbody td{border-top:1px solid var(--border);padding:10px 12px; vertical-align: middle;}
  tbody tr:hover{background:#0c1426}
  tbody tr.clickable { cursor: pointer; }
  .delrow{background:#13203b;border:1px solid #21314f;color:#cbd5e1;border-radius:8px;padding:6px 8px;cursor:pointer}

  .sumchips{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .chip{background:#0b1220;border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:12px;display:inline-flex;align-items:center;gap:8px}
  .chip .dot{width:8px;height:8px;border-radius:50%}
  .chip.ok .dot{background:var(--ok)} .chip.bad .dot{background:var(--bad)} .chip.warn .dot{background:var(--warn)}
  
  .live-result{font-size:13px; font-weight: 600; color: var(--muted);}
  .live-result .pct{color: var(--text); display: block; font-size: 15px;}
  .live-result .money{font-size: 12px;}

  .hr{height:1px;background:var(--border);margin:24px 0}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .small{font-size:12px}
  .hide{display:none !important}
  
  .search-wrapper{display:flex; gap:10px; margin-bottom:12px; align-items: center; flex-wrap: wrap;}
  .search-wrapper input {flex-grow:1;}
  .batch-actions { display: flex; gap: 10px; }

  .status{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
  .status.ok{background:rgba(34,197,94,.18);border:1px solid rgba(34,197,94,.4);color:#86efac}
  .status.bad{background:rgba(239,68,68,.18);border:1px solid rgba(239,68,68,.4);color:#fecaca}
  
  th.sortable{cursor:pointer;}
  th.sortable:hover{background-color: var(--panel2);}
  th .sort-icon{display:inline-block; width:1em; opacity:0.5;}
  th.col-check { width: 40px; padding: 12px 10px; text-align: center; }
  td.col-check { text-align: center; }
  
  .field-error {color:var(--bad); font-size:13px; font-weight:600; padding-top:4px; min-height:1.2em;}
  input.invalid-field, select.invalid-field {border-color:var(--bad) !important; box-shadow:0 0 0 3px rgba(239, 68, 68, .25) !important;}
  .checkbox-wrapper{display:flex; align-items:center; gap:8px; margin-top: 8px;}

  .iconbtn{appearance:none;border:1px solid var(--border);background:#0c1320;color:var(--text);width:36px;height:36px;border-radius:10px;display:inline-grid;place-items:center;cursor:pointer}
  .iconbtn:hover{background:var(--panel2);}
  .iconbtn svg { width: 20px; height: 20px; }
  .iconbtn[data-act="del"] svg{stroke-width:1.5;stroke:rgba(239,68,68,.8)}
  .iconbtn[data-act="edit"] svg{stroke-width:1.5}

  .chart{background:#0c1324;border:1px solid var(--border);border-radius:12px;padding:14px}
  .chart h3{margin:0 0 10px 0;font-size:15px;color:#cbd5e1}
  .chart svg{width:100%;height:auto}
  
  .analytics-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; flex-wrap: wrap; }
  .analytics-controls label { margin: 0; font-weight: 500; color: var(--muted); }
  .analytics-controls input[type="date"], .analytics-controls select { padding: 8px 10px; font-size: 14px; width: auto; }
  .analytics-controls .btn { padding: 8px 14px; font-size: 14px; }
  
  /* --- Feedback & Loader --- */
  .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--panel2);color:var(--text);padding:12px 20px;border-radius:10px;border:1px solid var(--border);box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:9999;opacity:0;transition:opacity .3s, bottom .3s;font-weight:600;}
  .toast.show{opacity:1;bottom:30px;}
  .toast.ok{background:var(--ok);border-color:transparent;}
  .toast.bad{background:var(--bad);border-color:transparent;}
  .loader{position:fixed;top:20px;right:20px;width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;z-index:10000;}
  @keyframes spin{to{transform:rotate(360deg)}}
  
  /* --- Batch Progress Bar --- */
  #batchProgress {
    position: sticky; top: 10px; z-index: 9000;
    margin: -10px auto 18px auto; max-width: 1200px; padding: 16px 22px;
  }
  #batchProgress h3 { margin: 0 0 10px; font-size: 16px; }
  #batchProgress p { margin: 0; }
  #batchProgress .note { margin-top: 6px; }
  #batchProgressBar { width: 100%; height: 10px; margin: 8px 0 4px; }

  dialog {border:1px solid var(--border); background: var(--panel); color:var(--text); border-radius: var(--radius); max-width: 90vw; }
  dialog::backdrop {background:rgba(0,0,0,.5); backdrop-filter: blur(4px);}
  dialog .hd { position: relative; }
  dialog .close-btn { position: absolute; top: 16px; right: 16px; width: 32px; height: 32px; border: 0; background: transparent; color: var(--muted); cursor: pointer; font-size: 24px; line-height: 1; padding: 0; }
  dialog .validation-summary { color: var(--warn); font-size: 13px; margin-top: -10px; margin-bottom: 10px; }


  /* --- Responsive Design --- */
  @media(max-width: 768px){
    .container{margin:16px auto; padding:0 12px;}
    .hd{padding:16px 18px 4px} .hd h1{font-size:20px} .hd p{font-size:13px}
    .ct{padding:16px 18px 20px}
    .grid-3, .grid-2 {grid-template-columns:1fr;}
    .topbar{flex-direction:column; gap:10px; align-items:flex-start;}
    .main-nav {width: 100%; justify-content: space-around;}
    .actions{flex-direction:column; align-items:stretch; gap:12px;}
    .btn{width:100%; text-align:center;}
    .form-bottom-actions{flex-direction:column; align-items:stretch !important; gap:16px !important;}
    .form-fields-group { flex-direction: column; gap: 10px !important; }
    .form-fields-group > div { width: 100%; }
    .form-fields-group input { width: 100% !important; }
    .search-wrapper { flex-direction: column; align-items: stretch; }
    .batch-actions { width: 100%; flex-direction: column; }
  }
  @media(max-width: 980px){
    table{min-width: 800px;}
  }

</style>
</head>
<body>

<div id="loader" class="loader hide"></div>
<div id="toast" class="toast"></div>

<div class="container">

  <div class="topbar">
    <div style="font-weight:700; font-size: 18px;">Sales-Beteiligung</div>
    <div class="main-nav">
      <a href="#" class="nav-link active" data-view="erfassung">Erfassung</a>
      <a href="#" class="nav-link" data-view="fixauftraege">Fixauftr√§ge</a>
      <a href="#" class="nav-link" data-view="rahmen">Rahmenvertr√§ge</a>
      <a href="#" class="nav-link" data-view="analytics">Auswertung</a>
      <a href="#" class="nav-link" data-view="admin">Admin</a>
    </div>
  </div>
  
  <div id="batchProgress" class="card hide">
    <h3 id="batchTitle">Verarbeitung l√§uft...</h3>
    <p id="batchStatusLabel">Initialisiere...</p>
    <progress id="batchProgressBar" max="100" value="0"></progress>
    <p class="note small" id="batchThrottleNotice">Gedrosselter Schreibmodus aktiv, um Server-Limits einzuhalten. Dies kann einen Moment dauern.</p>
  </div>

  <div class="card" id="viewErfassung">
    <div class="hd"><h1>Erfassung</h1><p id="erfassungSub">Neuen Auftrag oder Rahmenvertrag anlegen.</p></div>
    <div class="ct">
      <div id="abrufInfo" class="info-box hide"></div>
      <div class="grid-3">
        <div>
          <label for="auftraggeber">Auftraggeber *</label>
          <input id="auftraggeber" type="text" autocomplete="organization">
          <div class="field-error" data-validation-for="auftraggeber"></div>
        </div>
        <div>
          <label for="projekttitel">Projekttitel *</label>
          <input id="projekttitel" type="text">
          <div class="field-error" data-validation-for="projekttitel"></div>
        </div>
        <div>
          <label for="auftragswert">Auftragswert *</label>
          <input id="auftragswert" type="text" inputmode="decimal" placeholder="z. B. 120.000,00">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="auftragswertBekannt" checked>
            <label for="auftragswertBekannt" style="margin:0; font-weight:normal; font-size:13px;">Auftragswert bekannt?</label>
          </div>
          <div class="field-error" data-validation-for="auftragswert"></div>
        </div>
      </div>
      <div class="grid-3" style="margin-top:10px">
        <div>
          <label for="submittedBy">Einsch√§tzung abgegeben von *</label>
          <input id="submittedBy" type="text" list="peopleList" placeholder="Namen eintippen oder ausw√§hlen...">
          <div class="field-error" data-validation-for="submittedBy"></div>
        </div>
         <div id="projectTypeWrapper" style="grid-column: span 2;">
          <label>Projekttyp *</label>
          <div class="radio-group">
            <label><input type="radio" name="projectType" value="fix" checked> Fixauftrag</label>
            <label><input type="radio" name="projectType" value="rahmen"> Rahmenvertrag</label>
          </div>
        </div>
      </div>
      
      <div class="hr"></div>

      <div class="grid-3">
        <div>
          <label>Gewicht: Consultative Selling (%)</label>
          <input id="w_cs" type="number" min="0" max="100" step="1" value="50">
        </div>
        <div>
          <label>Gewicht: Konzepterstellung (%)</label>
          <input id="w_konzept" type="number" min="0" max="100" step="1" value="30">
        </div>
        <div>
          <label>Gewicht: Pitch (%)</label>
          <input id="w_pitch" type="number" min="0" max="100" step="1" value="20">
        </div>
      </div>
      <div class="note mono" id="w_note" style="margin-top:6px">Summe Gewichte: 100 %</div>
      <div class="field-error" data-validation-for="weights"></div>

      <div class="hr"></div>

      <div class="actions"><span class="tag">Person aus Liste w√§hlen oder frei eintippen ¬∑ 0‚Äì100 je Kategorie</span><button class="btn" id="btnAddRow" style="width:auto;">+ Zeile</button></div>
      <div class="field-error" data-validation-for="rows"></div>

      <datalist id="peopleList"></datalist>

      <div class="table-wrapper" style="margin-top:14px">
        <table>
          <thead><tr>
            <th style="width:25%">Person</th>
            <th style="width:15%">Consultative Selling</th>
            <th style="width:15%">Konzepterstellung</th>
            <th style="width:15%">Pitch</th>
            <th style="width:20%">Live-Anteil</th>
            <th style="width:10%">Aktion</th>
          </tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="sumchips" id="sumchips"></div>
      <div class="field-error" data-validation-for="categories"></div>

      <div class="hr"></div>

      <div class="form-bottom-actions" style="display:flex; justify-content:space-between; align-items:flex-end; gap:20px; flex-wrap: wrap;">
        <div class="form-fields-group" style="display:flex; gap:10px; flex-wrap: wrap;">
            <div>
              <label for="projectNumber" style="font-weight:500; font-size:13px; color: var(--muted);">Projektnummer</label>
              <input id="projectNumber" type="text" style="padding: 8px 12px; width: 170px;">
              <div class="field-error" data-validation-for="projectNumber"></div>
            </div>
            <div>
              <label for="kvNummer" style="font-weight:500; font-size:13px; color: var(--muted);">KV-Nummer</label>
              <input id="kvNummer" type="text" style="padding: 8px 12px; width: 170px;">
               <div class="field-error" data-validation-for="kvNummer"></div>
            </div>
            <div>
              <label for="freigabedatum" style="font-weight:500; font-size:13px; color: var(--muted);">Freigabedatum *</label>
              <input id="freigabedatum" type="date" style="padding: 8px 12px; width: 170px;">
               <div class="field-error" data-validation-for="freigabedatum"></div>
            </div>
        </div>
        <div style="display:flex;gap:10px; justify-content: flex-end;">
          <button class="btn primary disabled" id="btnSave">Speichern</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card hide" id="viewFixauftraege">
    <div class="hd">
        <h1>Fixauftr√§ge</h1>
        <div id="fixSumDisplay" class="sum-display">üí∞ Lade Summe...</div>
        <p>Suche, Filter & Sortierung. Export .xlsx der gefilterten Ansicht.</p>
    </div>
    <div class="ct">
      <div class="search-wrapper">
        <input id="omniSearch" type="text" placeholder="Suchen... (z.B. 'DRV Bund status:vollst√§ndig quelle:hubspot wert:>50000')">
        <div class="batch-actions">
            <button class="btn" id="btnXlsx" style="white-space:nowrap;">Export XLSX</button>
            <button class="btn warn hide" id="btnMoveToFramework">Zuweisen...</button>
            <button class="btn danger hide" id="btnBatchDelete">Markierte L√∂schen</button>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead><tr>
            <th class="col-check"><input type="checkbox" id="checkAllFix" title="Alle ausw√§hlen"></th>
            <th class="sortable" data-sort="title">Projekttitel<span class="sort-icon"></span></th>
            <th class="sortable" data-sort="client">Auftraggeber<span class="sort-icon"></span></th>
            <th class="sortable" data-sort="source">Quelle<span class="sort-icon"></span></th>
            <th style="width:14%">Status</th>
            <th class="sortable" data-sort="amount">Wert EUR<span class="sort-icon"></span></th>
            <th class="sortable" data-sort="freigabedatum">Freigabe<span class="sort-icon"></span></th>
            <th style="width:10%">Aktionen</th>
          </tr></thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div class="card hide" id="viewRahmen">
    <div class="hd">
        <h1>Rahmenvertr√§ge</h1>
        <div id="rahmenSumDisplay" class="sum-display">üí∞ Lade Summe...</div>
        <p>Werte von dynamischen Rahmenvertr√§gen aktualisieren und neue Abrufe erfassen.</p>
    </div>
    <div class="ct">
      <div class="search-wrapper">
        <input id="rahmenSearch" type="text" placeholder="Suchen nach Titel, Kunde, Person oder Hunter-Auftrag...">
      </div>
       <div class="table-wrapper">
        <table>
          <thead><tr>
            <th style="width:15%">Projektnummer</th>
            <th style="width:30%">Projekttitel</th>
            <th style="width:20%">Kunde</th>
            <th style="width:15%">Gesamtwert</th>
            <th style="width:20%">Aktionen</th>
          </tr></thead>
          <tbody id="rahmenBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div class="card hide" id="viewRahmenDetails">
    <div class="hd"><h1 id="rahmenDetailsTitle"></h1><p id="rahmenDetailsSub"></p></div>
    <div class="ct">
      <button class="btn" id="backToRahmen" style="margin-bottom: 16px;">‚Üê Zur√ºck zur √úbersicht</button>
      
      <div class="grid-2">
        <div>
          <h3>Gr√ºnder-Team (initiale Verteilung)</h3>
          <div class="table-wrapper">
            <table style="min-width:auto;">
              <thead><tr><th>Person</th><th>Anteil</th></tr></thead>
              <tbody id="rahmenFoundersBody"></tbody>
            </table>
          </div>
        </div>
        <div>
          <h3>Tats√§chliche Gesamtverteilung</h3>
          <div class="table-wrapper">
            <table style="min-width:auto;">
              <thead><tr><th>Person</th><th>Anteil</th><th>Wert</th></tr></thead>
              <tbody id="rahmenActualBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div class="hr"></div>
      <h3>Transaktions-Historie (zum Bearbeiten klicken)</h3>
       <div class="table-wrapper">
        <table style="min-width:auto;">
          <thead><tr><th>KV-Nummer</th><th>Typ</th><th>Titel</th><th>Wert</th><th>Freigabe</th><th>Aktionen</th></tr></thead>
          <tbody id="rahmenTransaktionenBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card hide" id="viewAdmin">
    <div class="hd"><h1>Admin</h1><p>Verwaltung von Personen, Teams und Datenimport.</p></div>
    <div class="ct">
      <h3>Personen & Teams</h3>
      <div class="search-wrapper">
        <input id="adminSearch" type="text" placeholder="Person oder Team suchen...">
      </div>
      <div class="grid-3">
        <div><label for="adm_name">Vor- und Nachname</label><input id="adm_name" type="text" placeholder="z. B. Max Mustermann"></div>
        <div><label for="adm_team">Team</label>
          <select id="adm_team">
            <option value="">‚Äî bitte w√§hlen ‚Äî</option>
            <option>Vielfalt+</option>
            <option>Evaluation und Beteiligung</option>
            <option>Nachhaltigkeit</option>
            <option>Sozial- und Krankenversicherungen</option>
            <option>ChangePartner</option>
            <option>Bundes- und Landesbeh√∂rden</option>
            <option>Kommunalverwaltungen</option>
            <option>Internationale Zusammenarbeit</option>
            <option>Head of Organisational Excellence</option>
            <option>Head of Public Impact</option>
          </select>
        </div>
        <div style="display:flex;align-items:flex-end"><button class="btn ok" id="adm_add">Anlegen</button></div>
      </div>
      <div class="table-wrapper" style="margin-top:14px;">
        <table>
          <thead><tr><th style="width:40%">Name</th><th style="width:40%">Team</th><th style="width:20%">Aktionen</th></tr></thead>
          <tbody id="adm_body"></tbody>
        </table>
      </div>
      <div class="hr"></div>
      <h3>ERP-Abgleich per Excel-Import</h3>
      <p class="note" style="font-size: 14px; margin-bottom: 12px;">Laden Sie hier die Excel-Datei aus dem ERP-System hoch. Das System wird bestehende Abrufe (via KV-Nummer) aktualisieren, neue Abrufe zu bestehenden Rahmenvertr√§gen (via Projektnummer) hinzuf√ºgen oder neue Fixauftr√§ge anlegen.</p>
      <div class="search-wrapper">
        <input type="file" id="erpFile" accept=".xlsx, .xls, .csv" style="padding: 10px; flex-grow: 1;">
        <button class="btn primary" id="btnErpImport">Import & Abgleich starten</button>
      </div>
      <div id="importResult" class="info-box hide" style="margin-top: 14px;"></div>
    </div>
  </div>

  <div class="card hide" id="viewAnalytics">
    <div class="hd"><h1>Auswertung</h1><p>Jahressummen, monet√§r. Basis: Fixauftr√§ge & Rahmenvertr√§ge.</p></div>
    <div class="ct">
      <div class="analytics-controls">
        <label>Jahr</label>
        <select id="anaYear" class="ipt"></select>
        <button class="btn" id="anaRefresh">Aktualisieren</button>
        <button class="btn" id="btnAnaXlsx">Export XLSX</button>
      </div>
      <div class="grid-3">
        <div class="chart" style="grid-column:1/-1">
          <h3>Top Personen (monet√§r)</h3>
          <div id="chartPersons"></div>
        </div>
        <div class="chart" style="grid-column:1/-1">
          <h3>Teams (monet√§r, aggregiert)</h3>
          <div id="chartTeams"></div>
        </div>
        <div class="chart" style="grid-column:1/-1">
          <h3>Gesamt√ºbersicht (monet√§r)</h3>
          <div id="chartTotals"></div>
        </div>
      </div>
      
      <div class="hr"></div>
      <h2>Aktivit√§t Rahmenvertr√§ge</h2>
      <div class="analytics-controls">
        <label for="anaStartDate">Von</label>
        <input type="date" id="anaStartDate">
        <label for="anaEndDate">Bis</label>
        <input type="date" id="anaEndDate">
        <button class="btn" id="btnAnaThisYear">Dieses Jahr</button>
        <button class="btn" id="btnAnaLastYear">Letztes Jahr</button>
        <button class="btn primary" id="btnAnaRangeRefresh">Laden</button>
      </div>
      <div class="grid-3">
         <div class="chart" style="grid-column:1/-1">
          <h3 id="chartActivityTitle">Aktivste Rahmenvertr√§ge</h3>
          <div id="chartActivity"></div>
        </div>
      </div>

    </div>
  </div>

</div>

<dialog id="confirmDlg">
  <div class="hd" style="padding:16px;border-bottom:1px solid var(--border)"><strong><span id="confirmDlgTitle">Eintrag l√∂schen</span></strong></div>
  <div class="ct" style="padding:16px">
    <p id="confirmDlgText">Wollen Sie den Eintrag wirklich l√∂schen?</p>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn" id="btnNo">Abbrechen</button>
      <button class="btn danger" id="btnYes">L√∂schen</button>
    </div>
  </div>
</dialog>

<dialog id="moveToFrameworkDlg" style="min-width: 500px;">
    <div class="hd">
        <h1>Auftr√§ge zuweisen</h1>
        <button class="close-btn" onclick="this.closest('dialog').close()">√ó</button>
    </div>
    <div class="ct">
        <div id="moveValidationSummary" class="validation-summary"></div>
        <p id="moveDlgCountLabel"></p>
        <div>
            <label for="moveTargetFramework">Ziel-Rahmenvertrag *</label>
            <select id="moveTargetFramework">
                <option value="">-- Bitte Rahmenvertrag w√§hlen --</option>
            </select>
        </div>
        <div style="margin-top: 16px;">
            <label>Abruf-Typ *</label>
            <div class="radio-group">
                <label><input type="radio" name="moveType" value="founder" checked> Passiver Abruf (Founder)</label>
                <label><input type="radio" name="moveType" value="hunter"> Aktiver Abruf (Hunter)</label>
            </div>
            <p class="note small" style="margin-top: 10px;">
                <b>Passiv (Founder):</b> Nur Betrag & KV-Nr. werden √ºbernommen. Die Sales-Verteilung des Fixauftrags wird verworfen und stattdessen die Founder-Verteilung des Rahmenvertrags angewendet.
                <br><br>
                <b>Aktiv (Hunter):</b> Der komplette Eintrag inkl. Sales-Verteilung wird 1:1 als "Hunter"-Abruf √ºbernommen. Dies geht nur, wenn der Fixauftrag vollst√§ndig (Status "ok") ist.
            </p>
        </div>
        <div class="hr"></div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button class="btn" onclick="document.getElementById('moveToFrameworkDlg').close()">Abbrechen</button>
            <button class="btn ok" id="btnConfirmMove">Zuweisen</button>
        </div>
    </div>
</dialog>

<dialog id="editTransactionDlg" style="min-width: 800px;">
    <div class="hd">
        <h1 id="editTransDlgTitle">Abruf bearbeiten</h1>
        <button class="close-btn" onclick="this.closest('dialog').close()">√ó</button>
    </div>
    <div class="ct">
        <div id="editTransValidationSummary" class="validation-summary"></div>
        <div id="editFounderTransView">
            <div class="grid-2">
                <div>
                    <label for="editFounderValueInput">Wert (EUR)</label>
                    <input type="text" id="editFounderValueInput" inputmode="decimal">
                </div>
                 <div>
                    <label for="editFounderKvNummer">KV-Nummer</label>
                    <input type="text" id="editFounderKvNummer">
                </div>
            </div>
             <div style="margin-top: 10px;">
                <label for="editFounderFreigabedatum">Freigabedatum</label>
                <input type="date" id="editFounderFreigabedatum">
            </div>
        </div>

        <div id="editHunterTransView" class="hide">
             <div class="grid-3">
                <div><label for="editHunterTitle">Titel</label><input type="text" id="editHunterTitle"></div>
                <div><label for="editHunterAmount">Wert (EUR)</label><input type="text" id="editHunterAmount" inputmode="decimal"></div>
                <div><label for="editHunterKvNummer">KV-Nummer</label><input type="text" id="editHunterKvNummer"></div>
            </div>
            <div style="margin-top: 10px;">
                <label for="editHunterFreigabedatum">Freigabedatum</label>
                <input type="date" id="editHunterFreigabedatum">
            </div>
            <div class="hr"></div>
            <div class="grid-3">
                <div><label>Gewicht: CS (%)</label><input type="number" id="editW_cs" value="50"></div>
                <div><label>Gewicht: Konzept (%)</label><input type="number" id="editW_konzept" value="30"></div>
                <div><label>Gewicht: Pitch (%)</label><input type="number" id="editW_pitch" value="20"></div>
            </div>
             <div class="hr"></div>
            <div class="actions"><span class="tag">Personen & Verteilung</span><button class="btn" id="editBtnAddRow" style="width:auto;">+ Zeile</button></div>
            <div class="table-wrapper" style="margin-top:14px">
                <table style="min-width:auto;">
                    <thead><tr><th>Person</th><th>CS</th><th>Konzept</th><th>Pitch</th><th>Aktion</th></tr></thead>
                    <tbody id="editTbody"></tbody>
                </table>
            </div>
        </div>
        
        <div class="hr"></div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button class="btn" onclick="document.getElementById('editTransactionDlg').close()">Abbrechen</button>
            <button class="btn ok" id="btnSaveTransaction">Speichern</button>
        </div>
    </div>
</dialog>

<dialog id="editFrameworkContractDlg" style="min-width: 800px;">
    <div class="hd">
        <h1>Rahmenvertrag bearbeiten</h1>
        <button class="close-btn" onclick="this.closest('dialog').close()">√ó</button>
    </div>
    <div class="ct">
        <div id="editFwValidationSummary" class="validation-summary"></div>
        <div class="grid-3">
            <div><label for="editFwClient">Auftraggeber</label><input type="text" id="editFwClient"></div>
            <div><label for="editFwTitle">Projekttitel</label><input type="text" id="editFwTitle"></div>
            <div><label for="editFwProjectNumber">Projektnummer</label><input type="text" id="editFwProjectNumber"></div>
        </div>
        <div class="hr"></div>
        <div class="grid-3">
            <div><label>Gewicht: CS (%)</label><input type="number" id="editFwW_cs" value="50"></div>
            <div><label>Gewicht: Konzept (%)</label><input type="number" id="editFwW_konzept" value="30"></div>
            <div><label>Gewicht: Pitch (%)</label><input type="number" id="editFwW_pitch" value="20"></div>
        </div>
        <div class="hr"></div>
        <div class="actions"><span class="tag">Gr√ºnder-Team & initiale Verteilung</span><button class="btn" id="editFwBtnAddRow" style="width:auto;">+ Zeile</button></div>
        <div class="table-wrapper" style="margin-top:14px">
            <table style="min-width:auto;">
                <thead><tr><th>Person</th><th>CS</th><th>Konzept</th><th>Pitch</th><th>Aktion</th></tr></thead>
                <tbody id="editFwTbody"></tbody>
            </table>
        </div>
        <div class="hr"></div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button class="btn" onclick="document.getElementById('editFrameworkContractDlg').close()">Abbrechen</button>
            <button class="btn ok" id="btnSaveFrameworkContract">Speichern</button>
        </div>
    </div>
</dialog>

<script>
/* ---------- Konfiguration ---------- */
const WORKER_BASE = "https://imap-sales-worker.tekin-6af.workers.dev";
const TEAMS = [
  "Vielfalt+","Evaluation und Beteiligung","Nachhaltigkeit","Sozial- und Krankenversicherungen",
  "ChangePartner","Bundes- und Landesbeh√∂rden","Kommunalverwaltungen",
  "Internationale Zusammenarbeit","Head of Organisational Excellence","Head of Public Impact"
];
const DEFAULT_WEIGHTS = { cs: 50, konzept: 30, pitch: 20 };
const CATEGORY_NAMES = {cs: "Consultative Selling", konzept: "Konzepterstellung", pitch: "Pitch"};
const FOUNDER_SHARE_PCT = 20;
const THROTTLE_MS = 400; // Latenz f√ºr Batch-Prozesse
const RETRY_LIMIT = 2;
const RETRY_BACKOFF_MS = 3000;


/* ---------- Hilfsfunktionen & UI-Feedback ---------- */
const loader = document.getElementById('loader');
const toast = document.getElementById('toast');
const batchProgress = document.getElementById('batchProgress');
const batchTitle = document.getElementById('batchTitle');
const batchStatusLabel = document.getElementById('batchStatusLabel');
const batchProgressBar = document.getElementById('batchProgressBar');
let hasUnsavedChanges = false;
let isBatchRunning = false;

function showLoader(){ loader.classList.remove('hide'); }
function hideLoader(){ loader.classList.add('hide'); }
function showToast(msg, type='ok', duration=3000){
  toast.textContent = msg;
  toast.className = `toast show ${type}`;
  setTimeout(() => { toast.className = 'toast'; }, duration);
}

function showBatchProgress(title, totalItems) {
    isBatchRunning = true;
    batchTitle.textContent = title;
    batchProgressBar.max = totalItems;
    batchProgressBar.value = 0;
    batchStatusLabel.textContent = `Starte... (0 / ${totalItems})`;
    batchProgress.classList.remove('hide');
    window.scrollTo(0, 0);
}
function updateBatchProgress(currentItem, totalItems) {
    batchProgressBar.value = currentItem;
    batchStatusLabel.textContent = `Verarbeite ${currentItem} / ${totalItems}...`;
}
function hideBatchProgress() {
    isBatchRunning = false;
    batchProgress.classList.add('hide');
}

/* ---------- Formatter ---------- */
const fmtPct   = new Intl.NumberFormat('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2});
const fmtInt   = new Intl.NumberFormat('de-DE',{maximumFractionDigits:0});
// *** KORREKTUR HIER ***
const fmtCurr2 = new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR',minimumFractionDigits:2,maximumFractionDigits:2});
const fmtCurr0 = new Intl.NumberFormat('de-DE',{style:'currency',currency:'EUR',minimumFractionDigits:0,maximumFractionDigits:0});
const formatAmountInput = (v) => new Intl.NumberFormat('de-DE',{minimumFractionDigits:2,maximumFractionDigits:2}).format((+v)||0);
const getTodayDate = () => new Date().toISOString().split('T')[0];
const formatDateForInput = (ts) => {
    if (!ts) return '';
    try { return new Date(ts).toISOString().split('T')[0]; }
    catch(e) { return ''; }
};

function clamp01(x){return Math.max(0,Math.min(100,x));}
function toInt0(v){const n=Math.round(Number(String(v??'0').replace(',','.')));return Number.isFinite(n)?n:0;}
function parseAmountInput(str) {
  if (!str) return 0;
  str = String(str).trim();

  // 1. Entferne W√§hrungs- und Leerzeichen
  str = str.replace(/[‚Ç¨\s]/g, '');

  // 2. Pr√ºfe, welches Trennzeichen zuletzt vorkommt (Dezimaltrennzeichen)
  const lastComma = str.lastIndexOf(',');
  const lastDot = str.lastIndexOf('.');

  let normalized;
  if (lastComma > lastDot) {
    // deutsches Format: 212.532,57 -> 212532.57
    normalized = str.replace(/\./g, '').replace(',', '.');
  } else {
    // englisches Format: 212,532.57 -> 212532.57
    normalized = str.replace(/,/g, '');
  }

  const n = Number(normalized);
  return Number.isFinite(n) ? n : 0;
}

const LS_KEY="sales_state_v1";
function saveState(st){localStorage.setItem(LS_KEY, JSON.stringify(st));}
function loadState(){try{const s=localStorage.getItem(LS_KEY);return s?JSON.parse(s):null;}catch{return null;}}

/* ---------- API Helper mit Retry/Latenz ---------- */
async function throttle() {
    await new Promise(resolve => setTimeout(resolve, THROTTLE_MS));
}

async function fetchWithRetry(url, options, retryCount = 0) {
    try {
        const response = await fetch(url, options);
        if (response.ok) {
            return response;
        }
        // Nur bei 429 (Too Many Requests) oder 5xx (Server Error) erneut versuchen
        if ((response.status === 429 || response.status >= 500) && retryCount < RETRY_LIMIT) {
            showToast(`Serverfehler ${response.status}. Versuche erneut in ${RETRY_BACKOFF_MS / 1000}s...`, 'warn', RETRY_BACKOFF_MS);
            await new Promise(resolve => setTimeout(resolve, RETRY_BACKOFF_MS));
            return fetchWithRetry(url, options, retryCount + 1);
        }
        // Bei anderen Client-Fehlern (z.B. 404, 400) nicht erneut versuchen
        throw new Error(`HTTP-Fehler ${response.status}: ${await response.text()}`);
    } catch (e) {
        // Bei Netzwerkfehlern ebenfalls erneut versuchen
        if (retryCount < RETRY_LIMIT) {
            showToast(`Netzwerkfehler. Versuche erneut in ${RETRY_BACKOFF_MS / 1000}s...`, 'warn', RETRY_BACKOFF_MS);
            await new Promise(resolve => setTimeout(resolve, RETRY_BACKOFF_MS));
            return fetchWithRetry(url, options, retryCount + 1);
        }
        throw e; // Finaler Fehler nach Retries
    }
}

/* ---------- Navigation ---------- */
const views = { erfassung: document.getElementById('viewErfassung'), fixauftraege: document.getElementById('viewFixauftraege'), rahmen: document.getElementById('viewRahmen'), rahmenDetails: document.getElementById('viewRahmenDetails'), admin: document.getElementById('viewAdmin'), analytics: document.getElementById('viewAnalytics') };
const navLinks = document.querySelectorAll('.nav-link');

function showView(viewName) {
  if (isBatchRunning) {
      showToast('Bitte warten Sie, bis die aktuelle Verarbeitung abgeschlossen ist.', 'bad');
      return;
  }
  Object.values(views).forEach(v => v.classList.add('hide'));
  navLinks.forEach(l => l.classList.remove('active'));
  hideBatchProgress();
  
  if (views[viewName]) {
    views[viewName].classList.remove('hide');
    const activeLink = document.querySelector(`.nav-link[data-view="${viewName}"]`);
    if (activeLink) activeLink.classList.add('active');
  }
  window.scrollTo(0,0);
}

navLinks.forEach(link => {
  link.addEventListener('click', (e) => {
    e.preventDefault();
    if (isBatchRunning) {
        showToast('Bitte warten Sie, bis die aktuelle Verarbeitung abgeschlossen ist.', 'bad');
        return;
    }
    const viewName = e.target.getAttribute('data-view');
    
    if (viewName === 'fixauftraege') {
      loadHistory().then(() => showView('fixauftraege'));
    } else if (viewName === 'rahmen') {
      loadHistory().then(() => { renderFrameworkContracts(); showView('rahmen'); });
    } else if (viewName === 'analytics') {
      loadHistory().then(() => { initAnalytics(); showView('analytics'); });
    } else if (viewName === 'admin') {
      handleAdminClick();
    } else if (viewName === 'erfassung') {
      if (hasUnsavedChanges && !document.querySelector('#viewErfassung').classList.contains('hide')) {
        if(confirm('M√∂chten Sie eine neue Erfassung starten? Ungespeicherte √Ñnderungen gehen verloren.')) {
          clearInputFields();
          initFromState();
          showView('erfassung');
        }
      } else {
        clearInputFields();
        initFromState();
        showView('erfassung');
      }
    }
  });
});

async function handleAdminClick() {
  try { 
    showLoader();
    await loadPeople(); 
    renderPeopleAdmin(); 
    showView('admin'); 
  }
  catch(e){ 
    console.error('Admin init failed', e); 
    showToast('Konnte Admin-Daten nicht laden.', 'bad'); 
  }
  finally { 
    hideLoader(); 
  }
}

  try { 
    showLoader();
    await loadPeople(); 
    renderPeopleAdmin(); 
    showView('admin'); 
  }
  catch(e){ console.error('Admin init failed',e); showToast('Konnte Admin-Daten nicht laden.', 'bad'); }
  finally { hideLoader(); }
}


/* ---------- People ---------- */
let people = [];
const peopleList = document.getElementById('peopleList');
async function loadPeople(){
  showLoader();
  try{ const r=await fetch(`${WORKER_BASE}/people`); people = r.ok? await r.json(): []; }
  catch{ people=[]; showToast('Personenliste konnte nicht geladen werden.', 'bad');}
  finally { hideLoader(); }
  people.sort((a,b)=>{ const lastA=a.name.split(' ').pop(); const lastB=b.name.split(' ').pop(); return lastA.localeCompare(lastB, 'de'); });
  
  if (peopleList){
    peopleList.innerHTML='';
    people.forEach(p=>{ 
      const o = document.createElement('option'); 
      o.value=p.name; 
      peopleList.appendChild(o);
    });
  }
}
function findPersonByName(name){ return people.find(p=>p.name.toLowerCase()===String(name||'').toLowerCase()); }

/* ---------- Erfassung ---------- */
const tbody = document.getElementById('tbody');
const sumchips = document.getElementById('sumchips');
const auftraggeber = document.getElementById('auftraggeber');
const projekttitel = document.getElementById('projekttitel');
const auftragswert = document.getElementById('auftragswert');
const auftragswertBekannt = document.getElementById('auftragswertBekannt');
const submittedBy  = document.getElementById('submittedBy');
const projectNumber = document.getElementById('projectNumber');
const kvNummer = document.getElementById('kvNummer');
const freigabedatum = document.getElementById('freigabedatum');
const w_cs = document.getElementById('w_cs');
const w_konzept = document.getElementById('w_konzept');
const w_pitch = document.getElementById('w_pitch');
const w_note = document.getElementById('w_note');
const btnAddRow = document.getElementById('btnAddRow');
const btnSave = document.getElementById('btnSave');

function rowTemplate(){
  const tr=document.createElement('tr');
  tr.innerHTML=`
    <td><input type="text" class="name" placeholder="Namen eintippen oder ausw√§hlen..." list="peopleList"></td>
    <td><input type="number" class="cs" min="0" max="100" step="1" value="0"></td>
    <td><input type="number" class="konzept" min="0" max="100" step="1" value="0"></td>
    <td><input type="number" class="pitch" min="0" max="100" step="1" value="0"></td>
    <td><div class="live-result"><span class="pct">- %</span><span class="money">- ‚Ç¨</span></div></td>
    <td><button class="delrow">Entfernen</button></td>`;
  return tr;
}
function bindRow(tr){
  tr.addEventListener('input',(ev)=>{
    hasUnsavedChanges = true;
    if (ev.target.matches('input[type="number"]')) ev.target.value=String(clamp01(toInt0(ev.target.value)));
    if (ev.target.classList.contains('name')){
      const p=findPersonByName(ev.target.value);
      if(p) ev.target.dataset.personId=p.id; else delete ev.target.dataset.personId;
    }
    saveCurrentInputState();
    recalc();
  });
  tr.querySelector('.delrow').addEventListener('click',()=>{tr.remove(); hasUnsavedChanges = true; saveCurrentInputState(); recalc();});
}
function addRow(focus=false){const tr=rowTemplate();tbody.appendChild(tr);bindRow(tr);if(focus)tr.querySelector('.name').focus();saveCurrentInputState(); recalc();}
function readRows(tbodySelector = '#tbody'){
  const rows=[]; document.querySelector(tbodySelector).querySelectorAll('tr').forEach(tr=>{
    rows.push({
      personId: tr.querySelector('.name').dataset.personId || null,
      name: (tr.querySelector('.name').value||'').trim(),
      cs: toInt0(tr.querySelector('.cs').value),
      konzept: toInt0(tr.querySelector('.konzept').value),
      pitch: toInt0(tr.querySelector('.pitch').value),
    });
  }); return rows;
}
function totals(rows){ return rows.reduce((a,r)=>{a.cs+=r.cs;a.konzept+=r.konzept;a.pitch+=r.pitch;return a;},{cs:0,konzept:0,pitch:0}); }
function renderChips(t){
  sumchips.innerHTML='';
  [["cs","Consultative Selling"],["konzept","Konzepterstellung"],["pitch","Pitch"]].forEach(([k,label])=>{
    const x=t[k]; const div=document.createElement('div');div.className='chip';
    const dot=document.createElement('span');dot.className='dot';
    const txt=document.createElement('span');txt.innerHTML=`<strong>${label}</strong> &nbsp; ${fmtInt.format(x)} / 100`;
    if(x===0 || x===100) div.classList.add('ok'); else if(x>100) div.classList.add('bad'); else div.classList.add('warn');
    div.appendChild(dot);div.appendChild(txt);sumchips.appendChild(div);
  });
}
function currentWeights(){return[{key:'cs',weight:clamp01(toInt0(w_cs.value))},{key:'konzept',weight:clamp01(toInt0(w_konzept.value))},{key:'pitch',weight:clamp01(toInt0(w_pitch.value))}]}
function updateWeightNote(){const ws=currentWeights();const sum=ws.reduce((a,c)=>a+Number(c.weight||0),0);w_note.textContent=`Summe Gewichte: ${sum} %`;}

function validateInput(forLive = false) {
    const errors = {};
    const st = loadState() || {};
    if (!forLive) {
        if (!auftraggeber.value.trim() && !st.isAbrufMode) errors.auftraggeber = 'Auftraggeber ist erforderlich.';
        if (!projekttitel.value.trim()) errors.projekttitel = st.isAbrufMode ? 'Titel des Abrufs ist erforderlich' : 'Projekttitel ist erforderlich.';
        if (!submittedBy.value) errors.submittedBy = 'Einsch√§tzung von ist erforderlich.';
        if (!freigabedatum.value) errors.freigabedatum = 'Freigabedatum ist erforderlich.';
        
        if (st.isAbrufMode && !kvNummer.value.trim()) {
            errors.kvNummer = 'KV-Nummer ist f√ºr Abrufe erforderlich.';
        }

        if (!readRows().some(r => r.cs + r.konzept + r.pitch > 0)) errors.rows = 'Mindestens eine Person mit Punkten erfassen.';
        if (auftragswertBekannt.checked && parseAmountInput(auftragswert.value) <= 0) errors.auftragswert = 'Ein Auftragswert > 0 ist erforderlich.';
    }

    const t = totals(readRows());
    const weights = currentWeights();
    let categoryErrors = [];
    weights.forEach(w => {
        if (forLive) {
            if (t[w.key] > 100) categoryErrors.push(`${CATEGORY_NAMES[w.key]} > 100`);
        } else {
            if (w.weight > 0 && t[w.key] !== 100) {
                categoryErrors.push(`F√ºr ${CATEGORY_NAMES[w.key]} (${w.weight}%) m√ºssen 100 Punkte vergeben werden (aktuell ${t[w.key]}).`);
            }
            if (w.weight === 0 && t[w.key] > 0 && t[w.key] < 100) {
                 categoryErrors.push(`F√ºr ${CATEGORY_NAMES[w.key]} (0%) m√ºssen die Punkte 0 oder 100 sein.`);
            }
        }
    });
    if (categoryErrors.length > 0) errors.categories = categoryErrors.join(' | ');

    const sumW = weights.reduce((a, c) => a + Number(c.weight || 0), 0);
    if (!forLive && sumW !== 100) errors.weights = `Gewichtungs-Summe muss 100 sein (aktuell ${sumW}).`;
    if (forLive && sumW === 0) errors.weights = 'Gewichte d√ºrfen nicht 0 sein f√ºr Live-Berechnung.';
    
    return errors;
}

function clearValidation(){
    document.querySelectorAll('.field-error').forEach(el => el.textContent = '');
    document.querySelectorAll('.invalid-field').forEach(el => el.classList.remove('invalid-field'));
}

function displayValidation(errors){
    clearValidation();
    Object.keys(errors).forEach(key => {
        const el = document.querySelector(`[data-validation-for="${key}"]`);
        if (el) el.textContent = errors[key];
        
        const input = document.getElementById(key);
        if(input) input.classList.add('invalid-field');
    });
}

function recalc(){
  const liveErrors = validateInput(true);
  const liveAmount = parseAmountInput(auftragswert.value);
  if (Object.keys(liveErrors).length === 0) {
    const result = compute(readRows(), currentWeights(), liveAmount, true);
    updateLiveResults(result.list);
  } else {
    updateLiveResults([]);
  }
  
  const finalErrors = validateInput(false);
  displayValidation(finalErrors);
  renderChips(totals(readRows()));

  if (Object.keys(finalErrors).length === 0) { 
    btnSave.classList.remove('disabled'); 
    btnSave.removeAttribute('aria-disabled'); 
  } else { 
    btnSave.classList.add('disabled'); 
    btnSave.setAttribute('aria-disabled', 'true'); 
  }
}

function updateLiveResults(resultList) {
  const resultByKey = new Map(resultList.map(item => [item.key, item]));
  document.querySelectorAll('#tbody tr').forEach((tr, index) => {
    const name = tr.querySelector('.name').value.trim();
    const resultEl = tr.querySelector('.live-result');
    const key = name || `_temp_${index}`;
    const resultData = resultByKey.get(key);

    if (resultData && auftragswertBekannt.checked) {
      resultEl.querySelector('.pct').textContent = `${fmtPct.format(resultData.pct)} %`;
      resultEl.querySelector('.money').textContent = `${fmtCurr0.format(resultData.money)}`;
    } else if (resultData) {
      resultEl.querySelector('.pct').textContent = `${fmtPct.format(resultData.pct)} %`;
      resultEl.querySelector('.money').textContent = `- ‚Ç¨`;
    }
    else {
      resultEl.querySelector('.pct').textContent = `- %`;
      resultEl.querySelector('.money').textContent = `- ‚Ç¨`;
    }
  });
}

function saveCurrentInputState() {
    const stPrev = loadState() || {};
    const currentInput = {
        client: auftraggeber.value.trim(),
        title: projekttitel.value.trim(),
        amount: parseAmountInput(auftragswert.value),
        amountKnown: auftragswertBekannt.checked,
        projectType: document.querySelector('input[name="projectType"]:checked').value,
        rows: readRows(),
        weights: currentWeights(),
        submittedBy: submittedBy.value,
        projectNumber: projectNumber.value.trim(),
        kvNummer: kvNummer.value.trim(),
        freigabedatum: freigabedatum.value || getTodayDate()
    };
    saveState({ ...stPrev, input: currentInput });
}

[auftraggeber, projekttitel, auftragswert, submittedBy, projectNumber, kvNummer, freigabedatum].forEach(el => { el.addEventListener('input', () => { hasUnsavedChanges=true; saveCurrentInputState(); recalc(); }); });
document.querySelectorAll('input[name="projectType"]').forEach(radio => radio.addEventListener('change', () => { hasUnsavedChanges=true; saveCurrentInputState(); recalc(); }));
auftragswertBekannt.addEventListener('change', () => {
    auftragswert.disabled = !auftragswertBekannt.checked;
    if(!auftragswertBekannt.checked) auftragswert.value = '';
    hasUnsavedChanges = true;
    saveCurrentInputState();
    recalc();
});

auftragswert.addEventListener('blur',()=>{
    const raw=parseAmountInput(auftragswert.value);
    auftragswert.value=raw > 0 ? formatAmountInput(raw) : '';
    saveCurrentInputState(); recalc();
});
[w_cs,w_konzept,w_pitch].forEach(el=>el.addEventListener('input',()=>{
    el.value=String(clamp01(toInt0(el.value)));
    hasUnsavedChanges=true; updateWeightNote(); saveCurrentInputState(); recalc();
}));
btnAddRow.addEventListener('click',()=>addRow(true));

btnSave.addEventListener('click', async () => {
  const errors = validateInput(); 
  if (Object.keys(errors).length > 0) {
    displayValidation(errors);
    return;
  }
  hasUnsavedChanges = false;
  
  const st = loadState(); if(!st?.input) return;

  if (st.isAbrufMode) {
    // Save as a "Hunter" transaction on a framework contract
    await saveHunterAbruf(st);
  } else {
    // Save as a new Fixauftrag or Rahmenvertrag
    await saveNewEntry(st);
  }
});

async function saveNewEntry(st) {
  const finalAmount = auftragswertBekannt.checked ? st.input.amount : 0;
  const resultData = compute(st.input.rows, st.input.weights, finalAmount);
  const isComplete=!!(st.input.client && st.input.title && finalAmount > 0 && st.input.rows.some(r=>r.cs+r.konzept+r.pitch>0));
  const date = new Date(st.input.freigabedatum).getTime();
  const ts = st.editingId ? (st.input.ts || Date.now()) : Date.now(); // Preserve original ts on edit

  const payload={
    source:st.source||'manuell', complete:isComplete, client:st.input.client||'',
    title:st.input.title||'', amount:finalAmount, 
    projectType: st.input.projectType || 'fix',
    rows: st.input.rows || [],
    list:resultData.list||[],
    totals:resultData.totals||{}, weights:resultData.effectiveWeights||[], submittedBy:st.input.submittedBy||'',
    projectNumber: st.input.projectNumber || '', kv_nummer: st.input.kvNummer, 
    freigabedatum: date,
    ts: ts,
    modified: st.editingId ? Date.now() : undefined, // Only set modified on update
    id:st.editingId||undefined,
    transactions: st.input.projectType === 'rahmen' ? [] : undefined
  };
  showLoader();
  try{
    const method = st.editingId ? 'PUT' : 'POST';
    const url = st.editingId ? `${WORKER_BASE}/entries/${encodeURIComponent(st.editingId)}` : `${WORKER_BASE}/entries`;
    const r = await fetchWithRetry(url, {method, headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    if(!r.ok) throw new Error(await r.text());
    showToast(`Eintrag ${st.editingId?'aktualisiert':'gespeichert'}.`, 'ok');
    clearInputFields();
    if(payload.projectType === 'rahmen') {
        loadHistory().then(() => { renderFrameworkContracts(); showView('rahmen'); });
    } else {
        loadHistory().then(()=>showView('fixauftraege'));
    }
  }catch(e){ showToast('Speichern fehlgeschlagen.', 'bad'); console.error(e); }
  finally{ hideLoader(); }
}


function loadInputForm(inputData, isEditing = false) {
    const st = loadState() || {};
    const abrufInfo = document.getElementById('abrufInfo');
    const erfsfassungSub = document.getElementById('erfassungSub');
    const projectTypeWrapper = document.getElementById('projectTypeWrapper');
    
    // Reset all fields first
    auftraggeber.disabled = false;
    projectNumber.disabled = true;
    kvNummer.disabled = true;
    freigabedatum.disabled = false;
    freigabedatum.value = inputData.freigabedatum ? formatDateForInput(inputData.freigabedatum) : getTodayDate();

    if (st.isAbrufMode && st.parentEntry) {
        // Hunter Abruf
        erfsfassungSub.textContent = "Neuen aktiven Abruf erfassen.";
        projectTypeWrapper.classList.add('hide');
        auftraggeber.value = st.parentEntry.client;
        auftraggeber.disabled = true;
        projekttitel.value = inputData.title || '';
        projectNumber.value = inputData.projectNumber || '';
        projectNumber.disabled = true;
        kvNummer.value = inputData.kvNummer || '';
        kvNummer.disabled = false;
        kvNummer.placeholder = 'KV-Nummer des Abrufs';
        freigabedatum.value = inputData.freigabedatum ? formatDateForInput(inputData.freigabedatum) : getTodayDate();

    } else {
        // Neue Erfassung oder Bearbeitung
        erfsfassungSub.textContent = isEditing ? 'Eintrag bearbeiten' : "Neuen Auftrag oder Rahmenvertrag anlegen.";
        projectTypeWrapper.classList.remove('hide');
        auftraggeber.value = inputData.client || '';
        projekttitel.value = inputData.title || '';
        projectNumber.value = inputData.projectNumber || '';
        kvNummer.value = inputData.kvNummer || '';

        projectNumber.disabled = !isEditing;
        kvNummer.disabled = !isEditing;
        // Freigabedatum sollte editierbar sein, au√üer bei Erstellung eines Rahmenvertrags (da noch keine Abrufe)
        freigabedatum.disabled = (!isEditing && inputData.projectType === 'rahmen'); 
        
        projectNumber.placeholder = isEditing ? 'Projektnummer eintragen' : 'Wird sp√§ter vergeben';
        kvNummer.placeholder = isEditing ? 'KV-Nummer eintragen' : 'Wird sp√§ter vergeben';
    }

    auftragswertBekannt.checked = inputData.amountKnown !== false;
    auftragswert.disabled = !auftragswertBekannt.checked;
    auftragswert.value = inputData.amount > 0 ? formatAmountInput(inputData.amount) : '';
    submittedBy.value = inputData.submittedBy || '';
    document.querySelector(`input[name="projectType"][value="${inputData.projectType || 'fix'}"]`).checked = true;

    const weights = inputData.weights || [{key:'cs',weight:DEFAULT_WEIGHTS.cs},{key:'konzept',weight:DEFAULT_WEIGHTS.konzept},{key:'pitch',weight:DEFAULT_WEIGHTS.pitch}];
    const m = Object.fromEntries(weights.map(w=>[w.key,w.weight]));
    w_cs.value = String(clamp01(toInt0(m.cs??DEFAULT_WEIGHTS.cs)));
    w_konzept.value = String(clamp01(toInt0(m.konzept??DEFAULT_WEIGHTS.konzept)));
    w_pitch.value = String(clamp01(toInt0(m.pitch??DEFAULT_WEIGHTS.pitch)));
    tbody.innerHTML = '';
    const rows = Array.isArray(inputData.rows) ? inputData.rows : [];
    if(rows.length > 0){
      rows.forEach(r=>{
        const tr=rowTemplate(); tbody.appendChild(tr); bindRow(tr);
        const nm=r.name||''; tr.querySelector('.name').value=nm; 
        const person=findPersonByName(nm); if(person) tr.querySelector('.name').dataset.personId=person.id;
        tr.querySelector('.cs').value=String(clamp01(toInt0(r.cs||0)));
        tr.querySelector('.konzept').value=String(clamp01(toInt0(r.konzept||0)));
        tr.querySelector('.pitch').value=String(clamp01(toInt0(r.pitch||0)));
      });
    } else { addRow(true); addRow(false); }
    hasUnsavedChanges = false;
    recalc();
}

function clearInputFields() {
    saveState({ source: 'manuell' });
    loadInputForm({}, false);
}

/* ---------- Berechnungslogik ---------- */
function compute(rows, weights, amount, forLive=false){
  const t = totals(rows); 
  const usedKeys = Object.entries(t).filter(([k,v])=>v>0).map(([k])=>k);
  const effWeights = (weights&&weights.length?weights:[{key:'cs',weight:DEFAULT_WEIGHTS.cs},{key:'konzept',weight:DEFAULT_WEIGHTS.konzept},{key:'pitch',weight:DEFAULT_WEIGHTS.pitch}]);
  
  const calcWeights = forLive ? effWeights : normalizeWeightsForUsed(effWeights, usedKeys);
  
  const map=new Map();
  rows.forEach((r, index)=>{
    const act=r.cs+r.konzept+r.pitch>0;
    const key = r.name.trim() || `_temp_${index}`;
    if (!r.name.trim() && !act) return;

    const cur=map.get(key) || { name: r.name, cs:0, konzept:0, pitch:0 };
    cur.cs+=r.cs; cur.konzept+=r.konzept; cur.pitch+=r.pitch;
    map.set(key,cur);
  });
  
  const wIdx = Object.fromEntries(calcWeights.map(w=>[w.key, w.weight / 100])); 
  const list=[];

  for(const [key, p] of map.entries()){
    let pct=0;
    const divCS = forLive ? 100 : (t.cs || 1);
    const divKonzept = forLive ? 100 : (t.konzept || 1);
    const divPitch = forLive ? 100 : (t.pitch || 1);

    if(usedKeys.includes('cs') && t.cs > 0) pct += wIdx.cs * (p.cs / divCS);
    if(usedKeys.includes('konzept') && t.konzept > 0) pct += wIdx.konzept * (p.konzept / divKonzept);
    if(usedKeys.includes('pitch') && t.pitch > 0) pct += wIdx.pitch * (p.pitch / divPitch);
    list.push({ key, name: p.name, pct: pct * 100 });
  }
  
  list.sort((a,b)=>b.pct-a.pct); 
  if(!forLive) {
      const sum=list.reduce((a,x)=>a+x.pct,0),resid=100-sum; 
      if(list.length&&Math.abs(resid)>1e-9) list[0].pct+=resid;
  }
  
  list.forEach(x=>{if(x.pct<0)x.pct=0;});
  const withMoney=list.map(x=>({ ...x, money: Math.round((amount>0?amount:0)*x.pct/100) }));
  return { totals:t, usedKeys, effectiveWeights: calcWeights, list:withMoney };
}

function normalizeWeightsForUsed(allWeights, usedKeys){
  const used=allWeights.filter(w=>usedKeys.includes(w.key)); const sum=used.reduce((a,w)=>a+w.weight,0);
  if(sum<=0) return allWeights.map(w=>({key:w.key,weight:w.weight}));
  const factor=100/sum;
  const out=allWeights.map(w=> usedKeys.includes(w.key)?{key:w.key,weight:w.weight*factor}:{key:w.key,weight:0});
  const rem=100-out.reduce((a,w)=>a+Math.round(w.weight),0); if(rem!==0){const ix=out.findIndex(x=>usedKeys.includes(x.key)); if(ix>=0) out[ix].weight+=rem;}
  return out.map(w=>({key:w.key,weight:Math.round(w.weight)}));
}


/* ---------- √úbersicht & Rahmenvertr√§ge ---------- */
const historyBody=document.getElementById('historyBody');
const omniSearch = document.getElementById('omniSearch');
const rahmenSearch = document.getElementById('rahmenSearch');
const btnXlsx=document.getElementById('btnXlsx');
const btnBatchDelete=document.getElementById('btnBatchDelete');
const btnMoveToFramework=document.getElementById('btnMoveToFramework');
const checkAllFix=document.getElementById('checkAllFix');
let entries=[]; 
let pendingDelete = { id: null, type: 'entry' }; // { id, ids?, type: 'entry'|'transaction'|'batch-entry', parentId? }
let currentSort = { key: 'freigabedatum', direction: 'desc' };

async function loadHistory(){ showLoader(); try{const r=await fetch(`${WORKER_BASE}/entries`); entries=r.ok?await r.json():[];} catch{entries=[]; showToast('Daten konnten nicht geladen werden.', 'bad');} finally{hideLoader();} renderHistory(); return entries; }
function autoComplete(e){ return !!(e.client && e.title && (e.amount > 0) && Array.isArray(e.list) && e.list.length > 0); }

function filtered(type = 'fix'){
  let arr = entries.filter(e => (e.projectType || 'fix') === type);
  const query = omniSearch.value.trim().toLowerCase();
  
  if (query) {
      const terms = query.split(/\s+/);
      const filters = [];
      const searchTerms = [];

      terms.forEach(term => {
        if (term.includes(':')) {
          const [key, ...value] = term.split(':');
          if (value.length > 0) {
            filters.push({ key, value: value.join(':') });
          }
        } else {
          searchTerms.push(term);
        }
      });

      const searchText = searchTerms.join(' ');
      if (searchText) {
        arr = arr.filter(e => 
          String(e.title || '').toLowerCase().includes(searchText) || 
          String(e.client || '').toLowerCase().includes(searchText)
        );
      }

      filters.forEach(({ key, value }) => {
        if (key === 'status') {
          const wantOk = value.startsWith('v') || value.startsWith('o');
          arr = arr.filter(e => wantOk ? autoComplete(e) : !autoComplete(e));
        }
        if (key === 'quelle' || key === 'source') {
          arr = arr.filter(e => (e.source || '').toLowerCase().startsWith(value));
        }
        if ((key === 'wert' || key === 'amount') && (value.startsWith('>') || value.startsWith('<'))) {
          const num = parseFloat(value.substring(1));
          if (!isNaN(num)) {
            if (value.startsWith('>')) arr = arr.filter(e => (e.amount || 0) > num);
            if (value.startsWith('<')) arr = arr.filter(e => (e.amount || 0) < num);
          }
        }
      });
  }

  arr.sort((a,b) => {
    let valA, valB;
    if (currentSort.key === 'ts') { 
        valA = a.modified || a.ts || 0; 
        valB = b.modified || b.ts || 0; 
    } else if (currentSort.key === 'freigabedatum') {
        valA = a.freigabedatum || a.ts || 0;
        valB = b.freigabedatum || b.ts || 0;
    } else {
        valA = a[currentSort.key] || '';
        valB = b[currentSort.key] || '';
    }
    
    let comparison = 0;
    if (typeof valA === 'string' && typeof valB === 'string') {
      comparison = valA.localeCompare(valB, 'de');
    } else {
      comparison = (valA || 0) - (valB || 0);
    }
    return currentSort.direction === 'asc' ? comparison : -comparison;
  });

  return arr;
}

function renderHistory(){
  historyBody.innerHTML=''; 
  updateSortIcons();
  const arr = filtered('fix');
  let totalSum = 0;
  
  for(const e of arr){
    const ok = autoComplete(e); 
    totalSum += (e.amount || 0);
    const status=`<span class="status ${ok?'ok':'bad'}">${ok?'vollst√§ndig':'unvollst√§ndig'}</span>`;
    const datum = e.freigabedatum ? new Date(e.freigabedatum).toLocaleDateString('de-DE') : (e.ts ? new Date(e.ts).toLocaleDateString('de-DE') : '‚Äì');
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td class="col-check"><input type="checkbox" class="row-check" data-id="${e.id}"></td>
      <td>${e.title||'‚Äì'}</td><td>${e.client||'‚Äì'}</td><td>${e.source||'‚Äì'}</td><td>${status}</td>
      <td>${e.amount?fmtCurr2.format(e.amount):'‚Äì'}</td><td>${datum}</td>
      <td style="display:flex;gap:8px;align-items:center">
        <button class="iconbtn" data-act="edit" data-id="${e.id}" title="Bearbeiten"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
        <button class="iconbtn" data-act="del" data-id="${e.id}" title="L√∂schen"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
      </td>`;
    historyBody.appendChild(tr);
  }
  
  document.getElementById('fixSumDisplay').innerHTML = `üí∞ <span>${fmtCurr0.format(totalSum)}</span> (gefilterte Ansicht)`;
  updateBatchButtons();
}
omniSearch.addEventListener('input', renderHistory);
rahmenSearch.addEventListener('input', renderFrameworkContracts);

function getSelectedFixIds() {
    return Array.from(document.querySelectorAll('#historyBody .row-check:checked')).map(cb => cb.dataset.id);
}

function updateBatchButtons() {
    const selectedIds = getSelectedFixIds();
    if (selectedIds.length > 0) {
        btnBatchDelete.classList.remove('hide');
        btnMoveToFramework.classList.remove('hide');
        btnBatchDelete.textContent = `Markierte L√∂schen (${selectedIds.length})`;
        btnMoveToFramework.textContent = `Zuweisen... (${selectedIds.length})`;
    } else {
        btnBatchDelete.classList.add('hide');
        btnMoveToFramework.classList.add('hide');
    }
    checkAllFix.checked = selectedIds.length > 0 && selectedIds.length === document.querySelectorAll('#historyBody .row-check').length;
}

checkAllFix.addEventListener('change', () => {
    document.querySelectorAll('#historyBody .row-check').forEach(cb => {
        cb.checked = checkAllFix.checked;
    });
    updateBatchButtons();
});

historyBody.addEventListener('change', (ev) => {
    if (ev.target.classList.contains('row-check')) {
        updateBatchButtons();
    }
});

document.querySelectorAll('#viewFixauftraege th.sortable').forEach(th => {
  th.addEventListener('click', () => {
    const key = th.dataset.sort;
    if (currentSort.key === key) {
      currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
      currentSort.key = key;
      // Default sort direction based on column type
      currentSort.direction = (key === 'title' || key === 'client' || key === 'source') ? 'asc' : 'desc';
    }
    renderHistory();
  });
});

function updateSortIcons() {
  document.querySelectorAll('#viewFixauftraege th.sortable .sort-icon').forEach(icon => {icon.textContent = ''; icon.style.opacity=0.5;});
  const activeTh = document.querySelector(`#viewFixauftraege th[data-sort="${currentSort.key}"] .sort-icon`);
  if (activeTh) {
    activeTh.textContent = currentSort.direction === 'asc' ? '‚ñ≤' : '‚ñº';
    activeTh.style.opacity = 1;
  }
}

// PASSWORTFREI: Einzel-L√∂schung
function handleDeleteClick(id, type = 'entry', parentId = null) {
  // Passwortabfrage entfernt
  pendingDelete = { id, type, parentId };
  document.getElementById('confirmDlgTitle').textContent = `Eintrag l√∂schen`;
  document.getElementById('confirmDlgText').textContent =
    `Wollen Sie den ${type === 'transaction' ? 'Abruf' : 'Eintrag'} wirklich l√∂schen?`;
  document.getElementById('confirmDlg').showModal();
}

// PASSWORTFREI: Batch-L√∂schung
btnBatchDelete.addEventListener('click', () => {
  const selectedIds = getSelectedFixIds();
  if (selectedIds.length === 0) return;

  // Passwortabfrage entfernt
  pendingDelete = { ids: selectedIds, type: 'batch-entry' };
  document.getElementById('confirmDlgTitle').textContent = `Eintr√§ge l√∂schen`;
  document.getElementById('confirmDlgText').textContent =
    `Wollen Sie die ${selectedIds.length} markierten Eintr√§ge wirklich l√∂schen?`;
  document.getElementById('confirmDlg').showModal();
});


historyBody.addEventListener('click', async(ev)=>{
  const btn=ev.target.closest('button[data-act]'); if(!btn) return;
  const id=btn.getAttribute('data-id'); const act=btn.getAttribute('data-act');
  if(act==='edit'){
    editEntry(id);
  } else if(act==='del'){ 
    handleDeleteClick(id, 'entry'); 
  }
});

function editEntry(id) {
  const e=entries.find(x=>x.id===id); if(!e) return;
  const st={ source:e.source||'manuell', editingId:e.id,
    input:{ client:e.client||'', title:e.title||'', amount:e.amount||0, amountKnown: e.amount > 0, projectType: e.projectType || 'fix', submittedBy:e.submittedBy||'', projectNumber:e.projectNumber||'', kvNummer: e.kv_nummer || '',
            freigabedatum: formatDateForInput(e.freigabedatum || e.ts), ts: e.ts,
            rows:Array.isArray(e.rows)&&e.rows.length? e.rows : (Array.isArray(e.list)? e.list.map(x=>({name:x.name, cs:0, konzept:0, pitch:0})):[]),
            weights:Array.isArray(e.weights)? e.weights : [{key:'cs',weight:DEFAULT_WEIGHTS.cs},{key:'konzept',weight:DEFAULT_WEIGHTS.konzept},{key:'pitch',weight:DEFAULT_WEIGHTS.pitch}] }};
  saveState(st); initFromState(true);
  showView('erfassung');
}

document.getElementById('btnNo').addEventListener('click',()=>document.getElementById('confirmDlg').close());
document.getElementById('btnYes').addEventListener('click',async()=>{
    const { id, ids, type, parentId } = pendingDelete;
    document.getElementById('confirmDlg').close();
    
    showLoader();
    try {
        if (type === 'entry') {
            if (!id) return;
            const r = await fetchWithRetry(`${WORKER_BASE}/entries/${encodeURIComponent(id)}`, { method: 'DELETE' });
            if (!r.ok) throw new Error(await r.text());
            showToast('Eintrag gel√∂scht.', 'ok');
            entries = entries.filter(x => x.id !== id);
            renderHistory();
            renderFrameworkContracts();
        } else if (type === 'batch-entry') {
            if (!ids || ids.length === 0) return;
            hideLoader(); // Hide small loader, show batch progress
            showBatchProgress('L√∂sche Eintr√§ge...', ids.length);
            let count = 0;
            for (const entryId of ids) {
                count++;
                updateBatchProgress(count, ids.length);
                const r = await fetchWithRetry(`${WORKER_BASE}/entries/${encodeURIComponent(entryId)}`, { method: 'DELETE' });
                if (!r.ok) throw new Error(`Fehler beim L√∂schen von ${entryId}: ${await r.text()}`);
                await throttle();
            }
            showToast(`${count} Eintr√§ge gel√∂scht.`, 'ok');
            await loadHistory(); // Reload all data
            renderHistory();
        } else if (type === 'transaction') {
            if (!id || !parentId) return;
            const entry = entries.find(e => e.id === parentId);
            if (!entry || !Array.isArray(entry.transactions)) throw new Error('Parent entry or transactions not found');
            const originalTransactions = JSON.parse(JSON.stringify(entry.transactions));
            entry.transactions = entry.transactions.filter(t => t.id !== id);
            entry.modified = Date.now();
            const r = await fetchWithRetry(`${WORKER_BASE}/entries/${encodeURIComponent(parentId)}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(entry)
            });
            if (!r.ok) {
              entry.transactions = originalTransactions; // rollback on fail
              throw new Error(await r.text());
            }
            showToast('Abruf gel√∂scht.', 'ok');
            renderRahmenDetails(parentId);
        }
    } catch (e) {
        showToast('Aktion fehlgeschlagen.', 'bad');
        console.error(e);
    } finally {
        hideLoader();
        hideBatchProgress();
        pendingDelete = { id: null, type: 'entry' };
    }
});


/* Export XLSX */
btnXlsx.addEventListener('click',()=>{
  const arr=filtered('fix').map(e=>({
    Projektnummer: e.projectNumber||'', Titel: e.title||'', Auftraggeber: e.client||'', Quelle: e.source||'',
    Status: autoComplete(e)?'vollst√§ndig':'unvollst√§ndig', Wert_EUR: e.amount||0,
    Freigabedatum: e.freigabedatum? new Date(e.freigabedatum).toISOString().split('T')[0] : (e.ts? new Date(e.ts).toISOString().split('T')[0]:'')
  }));
  const ws=XLSX.utils.json_to_sheet(arr);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Fixauftr√§ge");
  XLSX.writeFile(wb, "fixauftraege_export.xlsx");
});

/* Rahmenvertr√§ge */
const rahmenBody = document.getElementById('rahmenBody');
let currentFrameworkEntryId = null;
let editingTransactionId = null;

function filteredFrameworks() {
    let arr = entries.filter(e => e.projectType === 'rahmen');
    const query = rahmenSearch.value.trim().toLowerCase();
    if (!query) return arr.sort((a, b) => (b.modified || b.ts) - (a.modified || a.ts));

    return arr.filter(e => {
      if (String(e.title || '').toLowerCase().includes(query)) return true;
      if (String(e.client || '').toLowerCase().includes(query)) return true;
      if ((e.list || []).some(p => String(p.name || '').toLowerCase().includes(query))) return true;

      if (Array.isArray(e.transactions)) {
        for (const trans of e.transactions) {
          if (trans.type === 'hunter') {
            if (String(trans.title || '').toLowerCase().includes(query)) return true;
            if ((trans.list || []).some(p => String(p.name || '').toLowerCase().includes(query))) return true;
          }
        }
      }
      return false;
    }).sort((a, b) => (b.modified || b.ts) - (a.modified || a.ts));
}

function renderFrameworkContracts() {
  rahmenBody.innerHTML = '';
  const rahmenEntries = filteredFrameworks();
  let totalSum = 0;
  for (const e of rahmenEntries) {
    const tr = document.createElement('tr');
    tr.classList.add('clickable');
    tr.dataset.id = e.id;
    const totalValue = (e.transactions || []).reduce((sum, trans) => sum + trans.amount, 0);
    totalSum += totalValue;
    tr.innerHTML = `
      <td>${e.projectNumber || '‚Äì'}</td>
      <td>${e.title || '‚Äì'}</td>
      <td>${e.client || '‚Äì'}</td>
      <td>${fmtCurr2.format(totalValue)}</td>
      <td style="display:flex;gap:8px;align-items:center">
        <button class="btn ok" data-act="founder-plus" data-id="${e.id}" title="Passiver Abruf">+ Founder</button>
        <button class="btn primary" data-act="hunter-plus" data-id="${e.id}" title="Aktiver Abruf">+ Hunter</button>
        <button class="iconbtn" data-act="details" data-id="${e.id}" title="Details anzeigen"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24" fill="currentColor"><path d="M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-72q-45 0-76.5-31.5T372-500q0-45 31.5-76.5T480-608q45 0 76.5 31.5T588-500q0 45-31.5 76.5T480-392Zm0 192q-146 0-266-81.5T40-500q54-137 174-218.5T480-800q146 0 266 81.5T920-500q-54 137-174 218.5T480-200Zm0-300Zm0 220q113 0 207.5-59.5T832-500q-50-101-144.5-160.5T480-720q-113 0-207.5 59.5T128-500q50 101 144.5 160.5T480-280Z"/></svg></button>
        <button class="iconbtn" data-act="del" data-id="${e.id}" title="L√∂schen"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18m-2 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
      </td>
    `;
    rahmenBody.appendChild(tr);
  }
  document.getElementById('rahmenSumDisplay').innerHTML = `üí∞ <span>${fmtCurr0.format(totalSum)}</span> (Summe aller Abrufe)`;
}

rahmenBody.addEventListener('click', (e) => {
  const btn = e.target.closest('button[data-act]');
  if (btn) {
    e.stopPropagation(); // Stop click from bubbling to the row
    const act = btn.dataset.act;
    const id = btn.dataset.id;
    const entry = entries.find(en => en.id === id);
    if (!entry) return;
    
    if (act === 'founder-plus') {
      openEditTransactionModal({type:'founder'}, entry);
    } else if (act === 'hunter-plus') {
      saveState({ source: 'manuell', isAbrufMode: true, parentEntry: entry, input:{ projectNumber: entry.projectNumber || '', freigabedatum: getTodayDate() } });
      initFromState();
      showView('erfassung');
    } else if (act === 'details') {
      renderRahmenDetails(id);
      showView('rahmenDetails');
    } else if (act === 'del') {
      handleDeleteClick(id, 'entry');
    }
    return;
  }

  const row = e.target.closest('tr.clickable');
  if (row) {
    const id = row.dataset.id;
    const entry = entries.find(en => en.id === id);
    if (entry) openEditFrameworkContractModal(entry);
  }
});


async function saveHunterAbruf(st) {
    const parentEntry = entries.find(e => e.id === st.parentEntry.id);
    if (!parentEntry) { return showToast('Rahmenvertrag nicht gefunden.', 'bad'); }
    
    const abrufAmount = auftragswertBekannt.checked ? st.input.amount : 0;
    const resultData = compute(st.input.rows, st.input.weights, abrufAmount * (1 - (FOUNDER_SHARE_PCT / 100)));

    if (!Array.isArray(parentEntry.transactions)) { parentEntry.transactions = []; }
    const date = new Date(st.input.freigabedatum).getTime();

    const newTransaction = {
        id: `trans_${Date.now()}_${st.input.kvNummer.replace(/\s/g,'')}`, 
        kv_nummer: st.input.kvNummer,
        type: 'hunter', 
        title: st.input.title, 
        amount: abrufAmount, 
        ts: Date.now(),
        freigabedatum: date,
        submittedBy: st.input.submittedBy, 
        rows: st.input.rows, 
        list: resultData.list, 
        weights: resultData.effectiveWeights
    };
    
    parentEntry.transactions.push(newTransaction);
    parentEntry.modified = Date.now();

    showLoader();
    try {
        const r = await fetchWithRetry(`${WORKER_BASE}/entries/${encodeURIComponent(parentEntry.id)}`, {
            method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(parentEntry)
        });
        if (!r.ok) throw new Error(await r.text());
        showToast(`Aktiver Abruf hinzugef√ºgt`, 'ok');
        clearInputFields();
        loadHistory().then(() => { // Reload data after save
          renderFrameworkContracts();
          showView('rahmen');
        });
    } catch (e) {
        showToast('Speichern des Abrufs fehlgeschlagen.', 'bad');
        console.error(e);
    } finally {
        hideLoader();
    }
}

/* Rahmenvertrag Details */
const rahmenTransaktionenBody = document.getElementById('rahmenTransaktionenBody');
const rahmenActualBody = document.getElementById('rahmenActualBody');
document.getElementById('backToRahmen').addEventListener('click', () => showView('rahmen'));

function calculateActualDistribution(entry, startDate = 0, endDate = Infinity) {
    const personTotals = new Map();
    const transactions = (entry.transactions || []).filter(t => {
        const d = t.freigabedatum || t.ts || 0;
        // Make sure start and end are valid numbers
        const validStart = Number.isFinite(startDate) ? startDate : 0;
        const validEnd = Number.isFinite(endDate) ? endDate : Infinity;
        return d >= validStart && d <= validEnd;
    });
    let totalVolume = 0;

    transactions.forEach(trans => {
        totalVolume += trans.amount;
        if (trans.type === 'founder') {
            (entry.list || []).forEach(founder => {
                const money = trans.amount * (founder.pct / 100);
                personTotals.set(founder.name, (personTotals.get(founder.name) || 0) + money);
            });
        } else if (trans.type === 'hunter') {
            const founderShareAmount = trans.amount * (FOUNDER_SHARE_PCT / 100);
            (entry.list || []).forEach(founder => {
                const money = founderShareAmount * (founder.pct / 100);
                personTotals.set(founder.name, (personTotals.get(founder.name) || 0) + money);
            });
            (trans.list || []).forEach(hunter => {
                personTotals.set(hunter.name, (personTotals.get(hunter.name) || 0) + hunter.money);
            });
        }
    });
    
    if (totalVolume === 0) return { list: [], total: 0 };
    
    const list = Array.from(personTotals, ([name, money]) => ({
        name,
        money,
        pct: (money / totalVolume) * 100
    })).sort((a, b) => b.money - a.money);
    
    return { list, total: totalVolume };
}

function renderRahmenDetails(id) {
    const entry = entries.find(e => e.id === id);
    if (!entry) return;
    currentFrameworkEntryId = id;

    document.getElementById('rahmenDetailsTitle').textContent = entry.title;
    
    const { list: actualDistribution, total: totalValue } = calculateActualDistribution(entry); // Calculate total based on ALL transactions
    document.getElementById('rahmenDetailsSub').textContent = `${entry.client} | ${entry.projectNumber || ''} | Gesamtwert: ${fmtCurr0.format(totalValue)}`;
    
    const foundersBody = document.getElementById('rahmenFoundersBody');
    foundersBody.innerHTML = '';
    (entry.list || []).forEach(founder => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${founder.name}</td><td>${fmtPct.format(founder.pct)} %</td>`;
        foundersBody.appendChild(tr);
    });
    
    rahmenActualBody.innerHTML = '';
    actualDistribution.forEach(person => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${person.name}</td><td>${fmtPct.format(person.pct)} %</td><td>${fmtCurr0.format(person.money)}</td>`;
        rahmenActualBody.appendChild(tr);
    });

    rahmenTransaktionenBody.innerHTML = '';
    (entry.transactions || []).sort((a,b) => (b.freigabedatum || b.ts) - (a.freigabedatum || a.ts)).forEach(trans => {
        const tr = document.createElement('tr');
        tr.classList.add('clickable');
        tr.dataset.transId = trans.id;
        const datum = trans.freigabedatum ? new Date(trans.freigabedatum).toLocaleDateString('de-DE') : (trans.ts ? new Date(trans.ts).toLocaleDateString('de-DE') : '‚Äì');
        tr.innerHTML = `
            <td>${trans.kv_nummer || '‚Äì'}</td>
            <td>${trans.type === 'founder' ? 'Passiv' : 'Aktiv'}</td>
            <td>${trans.title || '‚Äì'}</td>
            <td>${fmtCurr2.format(trans.amount)}</td>
            <td>${datum}</td>
            <td style="display:flex;gap:8px;align-items:center">
                <button class="iconbtn" data-act="del-trans" data-id="${trans.id}" title="L√∂schen"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
            </td>
        `;
        rahmenTransaktionenBody.appendChild(tr);
    });
}

rahmenTransaktionenBody.addEventListener('click', (ev) => {
    const row = ev.target.closest('tr.clickable');
    const delBtn = ev.target.closest('button[data-act="del-trans"]');
    
    if (delBtn) {
        ev.stopPropagation();
        const transId = delBtn.dataset.id;
        handleDeleteClick(transId, 'transaction', currentFrameworkEntryId);
        return;
    }

    if (row) {
        const transId = row.dataset.transId;
        const parentEntry = entries.find(e => e.id === currentFrameworkEntryId);
        if (!parentEntry) return;
        const transaction = (parentEntry.transactions || []).find(t => t.id === transId);
        if (!transaction) return;
        openEditTransactionModal(transaction, parentEntry);
    }
});

/* ---------- Move Fix-Order Modal ---------- */
const moveToFrameworkDlg = document.getElementById('moveToFrameworkDlg');
const moveValidationSummary = document.getElementById('moveValidationSummary');
const moveTargetFramework = document.getElementById('moveTargetFramework');

btnMoveToFramework.addEventListener('click', () => {
    const selectedIds = getSelectedFixIds();
    if (selectedIds.length === 0) return;

    moveValidationSummary.textContent = '';
    document.getElementById('moveDlgCountLabel').textContent = `Sie sind dabei, ${selectedIds.length} Auftrag/Auftr√§ge zuzuweisen.`;
    
    const rahmenEntries = entries.filter(e => e.projectType === 'rahmen').sort((a,b) => a.title.localeCompare(b.title));
    moveTargetFramework.innerHTML = '<option value="">-- Bitte Rahmenvertrag w√§hlen --</option>';
    rahmenEntries.forEach(e => {
        const opt = document.createElement('option');
        opt.value = e.id;
        opt.textContent = `${e.title} (${e.client})`;
        moveTargetFramework.appendChild(opt);
    });
    
    moveToFrameworkDlg.showModal();
});

document.getElementById('btnConfirmMove').addEventListener('click', async () => {
    const selectedIds = getSelectedFixIds();
    const targetFrameworkId = moveTargetFramework.value;
    const moveType = document.querySelector('input[name="moveType"]:checked').value;
    
    moveValidationSummary.textContent = '';
    if (!targetFrameworkId) {
        moveValidationSummary.textContent = 'Bitte einen Ziel-Rahmenvertrag ausw√§hlen.';
        return;
    }
    
    const targetFramework = entries.find(e => e.id === targetFrameworkId);
    if (!targetFramework) {
        moveValidationSummary.textContent = 'Ziel-Rahmenvertrag nicht gefunden.';
        return;
    }

    const fixEntriesToMove = entries.filter(e => selectedIds.includes(e.id));
    
    // Pre-check for Hunter type
    if (moveType === 'hunter') {
        const incompleteEntries = fixEntriesToMove.filter(e => !autoComplete(e));
        if (incompleteEntries.length > 0) {
            moveValidationSummary.innerHTML = `<b>Fehler:</b> F√ºr "Aktive Abrufe" m√ºssen alle Eintr√§ge vollst√§ndig sein (Status "ok").<br>Folgende Eintr√§ge sind unvollst√§ndig: ${incompleteEntries.map(e => e.title).join(', ')}. <br>Bitte bearbeiten Sie diese Eintr√§ge zuerst.`;
            return;
        }
    }
    
    moveToFrameworkDlg.close();
    showBatchProgress(`Verschiebe Auftr√§ge...`, selectedIds.length);
    
    let count = 0;
    try {
        for (const entry of fixEntriesToMove) {
            count++;
            updateBatchProgress(count, selectedIds.length);
            
            // 1. Create new transaction
            let newTransaction;
            if (moveType === 'founder') {
                newTransaction = {
                    id: `trans_${Date.now()}_${entry.kv_nummer.replace(/\W/g, '')}`,
                    kv_nummer: entry.kv_nummer,
                    type: 'founder',
                    amount: entry.amount,
                    ts: Date.now(),
                    freigabedatum: entry.freigabedatum || entry.ts
                };
            } else { // hunter
                // Create a clean copy for the transaction, removing framework-specific fields if they exist
                const { id, projectType, transactions, ...restOfEntry } = entry;
                newTransaction = {
                    ...restOfEntry, // copy relevant data
                    id: `trans_${Date.now()}_${entry.kv_nummer.replace(/\W/g, '')}`,
                    type: 'hunter',
                    ts: Date.now() // new internal timestamp
                    // freigabedatum is already part of 'restOfEntry'
                };
            }
            
             // Ensure targetFramework.transactions exists and is an array
            if (!Array.isArray(targetFramework.transactions)) {
                targetFramework.transactions = [];
            }
            targetFramework.transactions.push(newTransaction);
            targetFramework.modified = Date.now();
            
            // 2. Save target framework
            const rPut = await fetchWithRetry(`${WORKER_BASE}/entries/${encodeURIComponent(targetFramework.id)}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(targetFramework)
            });
            if (!rPut.ok) throw new Error(`Fehler beim Speichern von Rahmenvertrag ${targetFramework.id}: ${await rPut.text()}`);
            
            // 3. Delete original fix order
            const rDel = await fetchWithRetry(`${WORKER_BASE}/entries/${encodeURIComponent(entry.id)}`, { method: 'DELETE' });
            if (!rDel.ok) throw new Error(`Fehler beim L√∂schen von Fixauftrag ${entry.id}: ${await rDel.text()}`);

            await throttle();
        }
        
        showToast(`${count} Eintr√§ge erfolgreich verschoben.`, 'ok');
    } catch (e) {
        showToast(`Fehler nach ${count} Eintr√§gen: ${e.message}`, 'bad');
        console.error(e);
    } finally {
        hideBatchProgress();
        await loadHistory(); // Reload all data
        renderHistory();
        renderFrameworkContracts();
    }
});


/* ---------- Edit Modals ---------- */
const editTransactionDlg = document.getElementById('editTransactionDlg');
const editFounderTransView = document.getElementById('editFounderTransView');
const editHunterTransView = document.getElementById('editHunterTransView');
const editTransDlgTitle = document.getElementById('editTransDlgTitle');
const editFounderValueInput = document.getElementById('editFounderValueInput');
const editFounderKvNummer = document.getElementById('editFounderKvNummer');
const editFounderFreigabedatum = document.getElementById('editFounderFreigabedatum');
const editHunterTitle = document.getElementById('editHunterTitle');
const editHunterAmount = document.getElementById('editHunterAmount');
const editHunterKvNummer = document.getElementById('editHunterKvNummer');
const editHunterFreigabedatum = document.getElementById('editHunterFreigabedatum');
const editW_cs = document.getElementById('editW_cs');
const editW_konzept = document.getElementById('editW_konzept');
const editW_pitch = document.getElementById('editW_pitch');
const editTbody = document.getElementById('editTbody');
const editFrameworkContractDlg = document.getElementById('editFrameworkContractDlg');

function openEditTransactionModal(transaction, parentEntry) {
    currentFrameworkEntryId = parentEntry.id;
    editingTransactionId = transaction.id || null; // null for new founder transaction
    
    document.getElementById('editTransValidationSummary').textContent = '';
    
    if (transaction.type === 'founder') {
        editTransDlgTitle.textContent = editingTransactionId ? "Passiven Abruf bearbeiten" : "Passiven Abruf hinzuf√ºgen";
        editFounderValueInput.value = editingTransactionId ? formatAmountInput(transaction.amount) : '';
        editFounderKvNummer.value = editingTransactionId ? transaction.kv_nummer : '';
        editFounderFreigabedatum.value = formatDateForInput(transaction.freigabedatum || transaction.ts || getTodayDate());
        editFounderTransView.classList.remove('hide');
        editHunterTransView.classList.add('hide');
    } else { // hunter
        editTransDlgTitle.textContent = "Aktiven Abruf bearbeiten";
        editHunterTitle.value = transaction.title || '';
        editHunterAmount.value = formatAmountInput(transaction.amount);
        editHunterKvNummer.value = transaction.kv_nummer || '';
        editHunterFreigabedatum.value = formatDateForInput(transaction.freigabedatum || transaction.ts || getTodayDate());
        
        const weights = transaction.weights || [{key:'cs',weight:DEFAULT_WEIGHTS.cs},{key:'konzept',weight:DEFAULT_WEIGHTS.konzept},{key:'pitch',weight:DEFAULT_WEIGHTS.pitch}];
        const m = Object.fromEntries(weights.map(w=>[w.key,w.weight]));
        editW_cs.value = m.cs ?? DEFAULT_WEIGHTS.cs;
        editW_konzept.value = m.konzept ?? DEFAULT_WEIGHTS.konzept;
        editW_pitch.value = m.pitch ?? DEFAULT_WEIGHTS.pitch;
        
        editTbody.innerHTML = '';
        (transaction.rows || []).forEach(r => addEditRow(r, '#editTbody'));

        editHunterTransView.classList.remove('hide');
        editFounderTransView.classList.add('hide');
    }
    editTransactionDlg.showModal();
}

function addEditRow(rowData = {}, tbodySelector) {
    const tbodyEl = document.querySelector(tbodySelector);
    if (!tbodyEl) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td><input type="text" class="name" value="${rowData.name || ''}" list="peopleList"></td>
        <td><input type="number" class="cs" value="${rowData.cs || 0}"></td>
        <td><input type="number" class="konzept" value="${rowData.konzept || 0}"></td>
        <td><input type="number" class="pitch" value="${rowData.pitch || 0}"></td>
        <td><button class="delrow">X</button></td>
    `;
    tr.querySelector('.delrow').addEventListener('click', () => tr.remove());
    tbodyEl.appendChild(tr);
}
document.getElementById('editBtnAddRow').addEventListener('click', () => addEditRow({}, '#editTbody'));

document.getElementById('btnSaveTransaction').addEventListener('click', async () => {
    const parentEntry = entries.find(e => e.id === currentFrameworkEntryId);
    if (!parentEntry) return;

    const transIndex = editingTransactionId ? parentEntry.transactions.findIndex(t => t.id === editingTransactionId) : -1;
    
    let transaction = (transIndex > -1) ? JSON.parse(JSON.stringify(parentEntry.transactions[transIndex])) : {}; // Deep copy to avoid modifying original on error
    let validationError = '';

    if (!editHunterTransView.classList.contains('hide')) { // Saving a Hunter transaction
        const rows = readRows('#editTbody');
        const weights = [
            {key:'cs', weight: toInt0(editW_cs.value)},
            {key:'konzept', weight: toInt0(editW_konzept.value)},
            {key:'pitch', weight: toInt0(editW_pitch.value)}
        ];
        
        const errors = validateModalInput(rows, weights);
        if (Object.keys(errors).length > 0) {
            document.getElementById('editTransValidationSummary').innerHTML = Object.values(errors).join('<br>');
            return;
        }
        if (!editHunterFreigabedatum.value) validationError = 'Freigabedatum ist erforderlich.';

        const amount = parseAmountInput(editHunterAmount.value);
        const hunterShareAmount = amount * (1 - (FOUNDER_SHARE_PCT / 100));
        const resultData = compute(rows, weights, hunterShareAmount);
        
        transaction = { ...transaction, title: editHunterTitle.value.trim(), amount, rows, weights, list: resultData.list, kv_nummer: editHunterKvNummer.value.trim(), freigabedatum: new Date(editHunterFreigabedatum.value).getTime() };

    } else { // Saving a Founder transaction
        if(!editFounderKvNummer.value) validationError = 'KV-Nummer ist erforderlich.';
        if(!editFounderFreigabedatum.value) validationError = 'Freigabedatum ist erforderlich.';
        
        transaction.amount = parseAmountInput(editFounderValueInput.value);
        transaction.kv_nummer = editFounderKvNummer.value.trim();
        transaction.freigabedatum = new Date(editFounderFreigabedatum.value).getTime();
    }
    
    if (validationError) {
        document.getElementById('editTransValidationSummary').innerHTML = validationError;
        return;
    }
    
    if (transIndex === -1) { // New founder transaction
        transaction.id = `trans_${Date.now()}_${transaction.kv_nummer.replace(/\s/g,'')}`;
        transaction.ts = Date.now();
        transaction.type = 'founder';
        if (!Array.isArray(parentEntry.transactions)) parentEntry.transactions = []; // Ensure array exists
        parentEntry.transactions.push(transaction);
    } else {
        parentEntry.transactions[transIndex] = transaction;
    }
    
    parentEntry.modified = Date.now();
    showLoader();
    try {
        const r = await fetchWithRetry(`${WORKER_BASE}/entries/${encodeURIComponent(parentEntry.id)}`, {
            method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(parentEntry)
        });
        if (!r.ok) throw new Error(await r.text());
        showToast('Abruf aktualisiert', 'ok');
        editTransactionDlg.close();
        loadHistory().then(() => { // Reload data after saving
            renderRahmenDetails(currentFrameworkEntryId);
            renderFrameworkContracts(); // Update list view sum
        });
    } catch (e) {
        showToast('Update fehlgeschlagen', 'bad'); console.error(e);
    } finally {
        hideLoader();
    }
});

const editFwClient = document.getElementById('editFwClient');
const editFwTitle = document.getElementById('editFwTitle');
const editFwProjectNumber = document.getElementById('editFwProjectNumber');
const editFwTbody = document.getElementById('editFwTbody');
const editFwW_cs = document.getElementById('editFwW_cs');
const editFwW_konzept = document.getElementById('editFwW_konzept');
const editFwW_pitch = document.getElementById('editFwW_pitch');
document.getElementById('editFwBtnAddRow').addEventListener('click', () => addEditRow({}, '#editFwTbody'));

function openEditFrameworkContractModal(entry) {
    currentFrameworkEntryId = entry.id;
    document.getElementById('editFwValidationSummary').textContent = '';
    editFwClient.value = entry.client || '';
    editFwTitle.value = entry.title || '';
    editFwProjectNumber.value = entry.projectNumber || '';

    const weights = entry.weights || [{key:'cs',weight:DEFAULT_WEIGHTS.cs},{key:'konzept',weight:DEFAULT_WEIGHTS.konzept},{key:'pitch',weight:DEFAULT_WEIGHTS.pitch}];
    const m = Object.fromEntries(weights.map(w=>[w.key,w.weight]));
    editFwW_cs.value = m.cs ?? DEFAULT_WEIGHTS.cs;
    editFwW_konzept.value = m.konzept ?? DEFAULT_WEIGHTS.konzept;
    editFwW_pitch.value = m.pitch ?? DEFAULT_WEIGHTS.pitch;

    editFwTbody.innerHTML = '';
    (entry.rows || []).forEach(r => addEditRow(r, '#editFwTbody'));
    editFrameworkContractDlg.showModal();
}

document.getElementById('btnSaveFrameworkContract').addEventListener('click', async () => {
    const entry = entries.find(e => e.id === currentFrameworkEntryId);
    if (!entry) return;

    const rows = readRows('#editFwTbody');
    const weights = [
        {key:'cs', weight: toInt0(editFwW_cs.value)},
        {key:'konzept', weight: toInt0(editFwW_konzept.value)},
        {key:'pitch', weight: toInt0(editFwW_pitch.value)}
    ];

    const errors = validateModalInput(rows, weights);
     if (rows.length === 0 || rows.every(r => r.name === '' && r.cs === 0 && r.konzept === 0 && r.pitch === 0)) {
        errors.rows = 'Mindestens eine Person muss dem Gr√ºnder-Team zugewiesen sein.';
    }
    if (Object.keys(errors).length > 0) {
        document.getElementById('editFwValidationSummary').innerHTML = Object.values(errors).join('<br>');
        return;
    }
    
    // Recalculate founder list based on new rows/weights (amount doesn't matter here)
    const resultData = compute(rows, weights, 100); // Amount 100 to get percentages

    entry.client = editFwClient.value.trim();
    entry.title = editFwTitle.value.trim();
    entry.projectNumber = editFwProjectNumber.value.trim();
    entry.rows = rows; // Save the raw input rows
    entry.weights = resultData.effectiveWeights; // Save the potentially normalized weights
    entry.list = resultData.list.map(({key, name, pct}) => ({key, name, pct})); // Save only pct, not money
    entry.modified = Date.now();

    showLoader();
    try {
        const r = await fetchWithRetry(`${WORKER_BASE}/entries/${encodeURIComponent(entry.id)}`, {
            method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(entry)
        });
        if (!r.ok) throw new Error(await r.text());
        showToast('Rahmenvertrag aktualisiert', 'ok');
        editFrameworkContractDlg.close();
        loadHistory().then(() => { // Reload data
            renderFrameworkContracts();
            if(document.getElementById('viewRahmenDetails').classList.contains('hide') === false) {
                 renderRahmenDetails(currentFrameworkEntryId); // Update details if visible
            }
        });
    } catch (e) {
        showToast('Update fehlgeschlagen', 'bad'); console.error(e);
    } finally {
        hideLoader();
    }
});

function validateModalInput(rows, weights) {
    const errors = {};
    const t = totals(rows);
    let categoryErrors = [];
    weights.forEach(w => {
        if (w.weight > 0 && t[w.key] !== 100) {
            categoryErrors.push(`F√ºr ${CATEGORY_NAMES[w.key]} (${w.weight}%) m√ºssen 100 Punkte vergeben werden (aktuell ${t[w.key]}).`);
        }
         if (w.weight === 0 && t[w.key] > 0 && t[w.key] < 100) {
             categoryErrors.push(`F√ºr ${CATEGORY_NAMES[w.key]} (0%) m√ºssen die Punkte 0 oder 100 sein.`);
        }
    });
    if (categoryErrors.length > 0) errors.categories = categoryErrors.join(' | ');

    const sumW = weights.reduce((a, c) => a + Number(c.weight || 0), 0);
    if (sumW !== 100) errors.weights = `Gewichtungs-Summe muss 100 sein (aktuell ${sumW}).`;
    
    return errors;
}

/* ---------- Admin ---------- */
const admName=document.getElementById('adm_name'), admTeam=document.getElementById('adm_team'), admBody=document.getElementById('adm_body'), adminSearch=document.getElementById('adminSearch');
document.getElementById('adm_add').onclick = () => adminCreate();
admName.addEventListener('keydown',(e)=>{ if(e.key==='Enter') adminCreate(); });
adminSearch.addEventListener('input', renderPeopleAdmin);

function renderPeopleAdmin(){
  admBody.innerHTML='';
  const query = adminSearch.value.toLowerCase();
  const filteredPeople = people.filter(p => p.name.toLowerCase().includes(query) || (p.team||'').toLowerCase().includes(query));

  filteredPeople.forEach(p=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td><input type="text" value="${p.name}"></td>
      <td><select>${TEAMS.map(t=>`<option value="${t}" ${p.team===t?'selected':''}>${t}</option>`).join('')}</select></td>
      <td style="display:flex;gap:8px">
        <button class="iconbtn" data-act="save" data-id="${p.id}" title="Speichern"><svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></button>
        <button class="iconbtn" data-act="del" data-id="${p.id}" title="L√∂schen"><svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
      </td>`;
    admBody.appendChild(tr);
  });
}
admBody.addEventListener('click',async(ev)=>{
  const btn=ev.target.closest('button[data-act]'); if(!btn) return;
  const id=btn.getAttribute('data-id'); const act=btn.getAttribute('data-act'); const tr=btn.closest('tr');
  showLoader();
  try{
    if(act==='save'){
      const name=tr.querySelector('td:nth-child(1) input').value.trim();
      const team=tr.querySelector('td:nth-child(2) select').value;
      if(!name) { showToast('Name darf nicht leer sein.', 'bad'); return; }
      const r = await fetchWithRetry(`${WORKER_BASE}/people`,{method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id,name,team})});
      if(!r.ok) throw new Error(await r.text());
      showToast('Person gespeichert.', 'ok'); await loadPeople(); renderPeopleAdmin();
    } else if(act==='del'){
      const r = await fetchWithRetry(`${WORKER_BASE}/people`,{method:'DELETE', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id, _delete:true})});
      if(!r.ok) throw new Error(await r.text());
      showToast('Person gel√∂scht.', 'ok'); await loadPeople(); renderPeopleAdmin();
    }
  } catch(e){ showToast('Aktion fehlgeschlagen.', 'bad'); console.error(e); } finally { hideLoader(); }
});
async function adminCreate(){
  const name=admName.value.trim(); const team=admTeam.value;
  if(!name || !team){ showToast('Bitte Name und Team ausf√ºllen.', 'bad'); return; }
  showLoader();
  try{
    const r = await fetchWithRetry(`${WORKER_BASE}/people`,{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id:`p_${Date.now()}`,name,team})});
    if(!r.ok) throw new Error(await r.text());
    showToast('Person angelegt.', 'ok'); admName.value=''; admTeam.value=''; await loadPeople(); renderPeopleAdmin();
  }catch(err){ showToast('Anlegen fehlgeschlagen.', 'bad'); console.error('Network error',err); } finally { hideLoader(); }
}

/* ---------- ERP Import ---------- */
const btnErpImport = document.getElementById('btnErpImport');
btnErpImport.addEventListener('click', handleErpImport);

function getVal(row, keyName) {
    const normalizedKeyName = keyName.toLowerCase().replace(/[^a-z0-9]/g, '');
    const keys = Object.keys(row);
    // Finde den Schl√ºssel, der am besten passt (enth√§lt statt exakt)
    const foundKey = keys.find(k => k.toLowerCase().replace(/[^a-z0-9]/g, '').includes(normalizedKeyName));
    return foundKey ? row[foundKey] : undefined;
}

// Hilfsfunktion zum Parsen von Excel-Datumsangaben
function parseExcelDate(excelDate) {
    if (typeof excelDate === 'number') {
        // (excelDate - 25569) * 86400 * 1000 = Konvertierung von Excel-Datum (Zahl) zu JS-Timestamp
        // F√§ngt auch ung√ºltige Excel-Daten ab (z.B. 0)
        if (excelDate > 0) {
            return new Date((excelDate - 25569) * 86400 * 1000);
        }
    }
    if (typeof excelDate === 'string') {
        // Versucht, ein Standard-Datumsformat zu parsen (ISO, locale etc.)
        const d = new Date(excelDate);
        if (!isNaN(d.getTime())) {
            return d;
        }
        // Versuch, DD.MM.YYYY oder MM/DD/YYYY zu parsen
        const parts = excelDate.match(/(\d{1,2})[.\/](\d{1,2})[.\/](\d{4})/);
        if (parts) {
            // Annahme: DD.MM.YYYY zuerst (europ√§isch)
            let d = new Date(parts[3], parts[2] - 1, parts[1]);
            if (!isNaN(d.getTime())) return d;
            // Annahme: MM/DD/YYYY (amerikanisch)
            d = new Date(parts[3], parts[1] - 1, parts[2]);
            if (!isNaN(d.getTime())) return d;
        }
    }
    return null; // Ung√ºltiges Format oder Wert
}


async function handleErpImport() {
    const fileInput = document.getElementById('erpFile');
    const importResult = document.getElementById('importResult');
    if (fileInput.files.length === 0) {
        showToast('Bitte eine Datei ausw√§hlen.', 'bad');
        return;
    }
    const file = fileInput.files[0];
    showLoader();
    importResult.classList.add('hide');
    
    try {
        await loadHistory(); // Ensure we have the latest data
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const sheetName = workbook.SheetNames[0];
        const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

        let updatedCount = 0;
        let addedToFrameworkCount = 0;
        let newFixCount = 0;
        let skippedCount = 0;

        // Erstelle eine tiefe Kopie, um Seiteneffekte w√§hrend der Schleife zu managen
        const allEntriesCopy = JSON.parse(JSON.stringify(entries));
        const changesToPush = [];
        
        // Erstelle einen schnellen Index f√ºr KV-Nummern aus der Kopie
        const kvIndex = new Map();
        allEntriesCopy.forEach(entry => {
            if (entry.kv_nummer) {
                kvIndex.set(entry.kv_nummer, { type: 'fix', entry: entry });
            }
            if (entry.projectType === 'rahmen' && Array.isArray(entry.transactions)) {
                entry.transactions.forEach(trans => {
                    if (trans.kv_nummer) {
                        kvIndex.set(trans.kv_nummer, { type: 'transaction', entry: entry, transaction: trans });
                    }
                });
            }
        });
        
        // Erstelle einen Index f√ºr Projektnummern von Rahmenvertr√§gen aus der Kopie
        const frameworkProjectIndex = new Map();
        allEntriesCopy.forEach(entry => {
            if (entry.projectType === 'rahmen' && entry.projectNumber) {
                frameworkProjectIndex.set(entry.projectNumber, entry);
            }
        });

        for (const row of rows) {
            const kvNummer = String(getVal(row, 'KV-Nummer') || '').trim();
            if (!kvNummer) {
                skippedCount++;
                continue;
            }

            const projektNummer = String(getVal(row, 'Projekt Projektnummer') || '').trim();
            // Versucht, verschiedene Formate zu parsen (mit Komma als Dezimaltrenner)
            const amountRaw = getVal(row, 'Agenturleistung netto');
            const amount = parseAmountInput(amountRaw); 
            
            const clientName = getVal(row, 'Projekt Etat Kunde Name') || '';
            const title = getVal(row, 'Titel') || '';
            
            let freigabeTimestamp = Date.now(); // Fallback auf Import-Datum
            const excelDate = getVal(row, 'Freigabedatum'); // Suche nach Freigabedatum
            if (excelDate) {
                const parsedDate = parseExcelDate(excelDate);
                if (parsedDate) {
                    freigabeTimestamp = parsedDate.getTime();
                } else {
                     console.warn(`Ung√ºltiges Freigabedatum in Zeile mit KV ${kvNummer}: ${excelDate}`);
                }
            } else {
                 console.warn(`Kein Freigabedatum in Zeile mit KV ${kvNummer} gefunden, verwende Importdatum.`);
            }

            const existing = kvIndex.get(kvNummer);

            if (existing) { // Fall A: KV-Nummer wurde gefunden
                let currentAmount;
                if (existing.type === 'transaction') {
                    currentAmount = existing.transaction.amount;
                } else {
                    currentAmount = existing.entry.amount;
                }

                // Vergleiche Betr√§ge mit kleiner Toleranz f√ºr Flie√ükomma-Ungenauigkeiten
                if (Math.abs(currentAmount - amount) > 0.001) {
                    if (existing.type === 'transaction') {
                        existing.transaction.amount = amount;
                        // Optional: Freigabedatum aktualisieren, falls es sich ge√§ndert hat?
                        // existing.transaction.freigabedatum = freigabeTimestamp; 
                    } else {
                        existing.entry.amount = amount;
                         // Optional: Freigabedatum aktualisieren?
                        // existing.entry.freigabedatum = freigabeTimestamp;
                    }
                    existing.entry.modified = Date.now();
                    // Stelle sicher, dass der Eintrag nur einmal in changesToPush landet
                    if (!changesToPush.some(item => item.id === existing.entry.id)) {
                        changesToPush.push(existing.entry);
                    }
                    updatedCount++;
                } else {
                    skippedCount++;
                }
            } else { // Fall B: KV-Nummer ist neu
                const parentFramework = frameworkProjectIndex.get(projektNummer);
                
                if (parentFramework) { // Fall B1: Rahmenvertrag gefunden
                    if (!Array.isArray(parentFramework.transactions)) {
                        parentFramework.transactions = [];
                    }
                     // Pr√ºfen ob die Transaktion (KV) nicht doch schon da ist (Sicherheitsnetz)
                    if (!parentFramework.transactions.some(t => t.kv_nummer === kvNummer)) {
                        parentFramework.transactions.push({
                            id: `trans_${Date.now()}_${kvNummer.replace(/\W/g, '')}`,
                            kv_nummer: kvNummer,
                            type: 'founder', // Standard auf 'founder' (passiv)
                            amount: amount,
                            ts: Date.now(),
                            freigabedatum: freigabeTimestamp
                        });
                        parentFramework.modified = Date.now();
                         if (!changesToPush.some(item => item.id === parentFramework.id)) {
                            changesToPush.push(parentFramework);
                        }
                        addedToFrameworkCount++;
                    } else {
                         skippedCount++; // KV schon im RV vorhanden, aber nicht im Index (sollte nicht passieren)
                         console.warn(`KV ${kvNummer} bereits in Rahmenvertrag ${parentFramework.id} gefunden, obwohl nicht im Index.`);
                    }
                } else { // Fall B2: Neuer Fixauftrag
                    const newFixEntry = {
                        id: `entry_${Date.now()}_${kvNummer.replace(/\W/g, '')}`,
                        source: 'erp-import',
                        projectType: 'fix',
                        client: clientName,
                        title: title,
                        projectNumber: projektNummer,
                        kv_nummer: kvNummer,
                        amount: amount,
                        list: [],
                        rows: [],
                        weights: [],
                        ts: Date.now(),
                        freigabedatum: freigabeTimestamp,
                        complete: false // Ist unvollst√§ndig, da Verteilung fehlt
                    };
                    allEntriesCopy.push(newFixEntry); // F√ºge zur lokalen Kopie hinzu f√ºr sp√§tere Index-Checks
                    kvIndex.set(kvNummer, {type: 'fix', entry: newFixEntry}); // F√ºge zum Index hinzu
                    changesToPush.push(newFixEntry);
                    newFixCount++;
                }
            }
        }

        // Keine Notwendigkeit mehr f√ºr uniqueChanges, da wir es jetzt direkt beim Pushen pr√ºfen
        
        hideLoader();
        if (changesToPush.length > 0) {
            showBatchProgress('Speichere Import-√Ñnderungen...', changesToPush.length);
            let count = 0;
            for (const entry of changesToPush) {
                count++;
                updateBatchProgress(count, changesToPush.length);
                
// *** KORREKTUR HIER: Pr√ºfe gegen den *urspr√ºnglichen* entries-Array ***
                const originalEntryExists = entries.some(originalEntry => originalEntry.id === entry.id);
                const url = !originalEntryExists ? `${WORKER_BASE}/entries` : `${WORKER_BASE}/entries/${encodeURIComponent(entry.id)}`;
                const method = !originalEntryExists ? 'POST' : 'PUT';

                // Stelle sicher, dass f√ºr PUT eine ID vorhanden ist
                if(method === 'PUT' && !entry.id) {
                     throw new Error(`Versuch, Eintrag ohne ID zu aktualisieren (KV: ${entry.kv_nummer || 'unbekannt'})`);
                }

                console.log(`Sending ${method} request to ${url} for KV ${entry.kv_nummer}`); // Debugging-Ausgabe

                const r = await fetchWithRetry(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(entry)
                });
                if (!r.ok) throw new Error(`Fehler (${method} ${url}) f√ºr Eintrag ${entry.id || ('(neu mit KV '+entry.kv_nummer+')')}: ${await r.text()}`);
                await throttle();
            }
        }

        const resultMsg = `Import abgeschlossen: ${updatedCount} Eintr√§ge aktualisiert, ${addedToFrameworkCount} neue Abrufe zu Rahmenvertr√§gen hinzugef√ºgt, ${newFixCount} neue Fixauftr√§ge erstellt. ${skippedCount} Zeilen √ºbersprungen (keine √Ñnderungen oder fehlende KV-Nummer).`;
        importResult.innerHTML = resultMsg;
        importResult.classList.remove('hide');
        showToast('ERP-Daten erfolgreich importiert', 'ok');
        await loadHistory(); // Lade die finale Version vom Server

    } catch (e) {
        showToast('Fehler beim Importieren der Datei.', 'bad');
        console.error(e);
        importResult.textContent = 'Fehler: ' + e.message;
        importResult.classList.remove('hide');
    } finally {
        hideLoader();
        hideBatchProgress();
    }
}



/* ---------- Auswertung ---------- */
const anaYear = document.getElementById('anaYear');
const anaStartDate = document.getElementById('anaStartDate');
const anaEndDate = document.getElementById('anaEndDate');
const btnAnaThisYear = document.getElementById('btnAnaThisYear');
const btnAnaLastYear = document.getElementById('btnAnaLastYear');
const btnAnaRangeRefresh = document.getElementById('btnAnaRangeRefresh');

function initAnalytics() {
    // F√ºlle Jahres-Dropdown (f√ºr Top-Listen)
    const currentYear = new Date().getFullYear();
    anaYear.innerHTML = '';
    for (let y = 2022; y <= currentYear + 1; y++) {
      const o = document.createElement('option'); o.value = String(y); o.textContent = String(y); anaYear.appendChild(o);
    }
    anaYear.value = String(currentYear);
    
    // Setze Standard-Datum (f√ºr Aktivit√§ts-Chart)
    setAnaDateRange('thisYear');
    
    // F√ºhre beide Render-Funktionen aus
    renderAnalytics(); // J√§hrliche Auswertung
    renderActivityAnalytics(); // Zeitintervall-Auswertung
}

function setAnaDateRange(rangeType) {
    const now = new Date();
    let start, end;
    if (rangeType === 'thisYear') {
        start = new Date(now.getFullYear(), 0, 1); // 1. Jan
        end = now; // Heute
    } else { // lastYear
        const lastYear = now.getFullYear() - 1;
        start = new Date(lastYear, 0, 1); // 1. Jan letztes Jahr
        end = new Date(lastYear, 11, 31); // 31. Dez letztes Jahr
    }
    anaStartDate.value = formatDateForInput(start.getTime());
    anaEndDate.value = formatDateForInput(end.getTime());
}

btnAnaThisYear.addEventListener('click', () => {
    setAnaDateRange('thisYear');
    renderActivityAnalytics();
});
btnAnaLastYear.addEventListener('click', () => {
    setAnaDateRange('lastYear');
    renderActivityAnalytics();
});
btnAnaRangeRefresh.addEventListener('click', renderActivityAnalytics);

document.getElementById('anaRefresh').addEventListener('click', renderAnalytics); // J√§hrliche Auswertung
const btnAnaXlsx = document.getElementById('btnAnaXlsx');

let analyticsData = { persons: [], teams: [], totals: [] };

// Helper to get timestamp, ensuring it's a valid number or 0
function getTimestamp(dateStr) {
    try {
        const d = new Date(dateStr);
        return isNaN(d.getTime()) ? 0 : d.getTime();
    } catch { return 0; }
}

// J√§hrliche Top-Listen und Gesamt√ºbersicht
function renderAnalytics() {
  const year = Number(anaYear.value);
  // Definiere Start- und End-Timestamp f√ºr das gew√§hlte Jahr (UTC oder lokale Zeitzone beachten?)
  // Annahme: Lokale Zeitzone basierend auf formatDateForInput
  const startOfYear = getTimestamp(`${year}-01-01`);
  const endOfYear   = getTimestamp(`${year}-12-31T23:59:59.999`);

  const per = new Map();
  let fixTotal = 0;
  let rahmenTotal = 0;
  
  entries.forEach(e => {
    const datum = e.freigabedatum || e.ts || 0; // Verwende Freigabedatum prim√§r
    
    if(e.projectType === 'fix') {
        // Pr√ºfe, ob das Datum im gew√§hlten Jahr liegt
        if (!(datum >= startOfYear && datum <= endOfYear)) return;
        
        const amount = e.amount || 0; if (amount <= 0) return;
        fixTotal += amount;
        // Z√§hle Personenbeitr√§ge nur, wenn der Auftrag in diesem Jahr freigegeben wurde
        if (Array.isArray(e.list)) {
          e.list.forEach(x => { const key = x.name || 'Unbekannt'; per.set(key, (per.get(key) || 0) + (x.money || 0)); });
        }
    } else if (e.projectType === 'rahmen') {
        // Berechne die Verteilung basierend auf Abrufen *innerhalb* des Jahres
        const { list: actualDistribution, total: totalValueInYear } = calculateActualDistribution(e, startOfYear, endOfYear);
        rahmenTotal += totalValueInYear;
        actualDistribution.forEach(p => {
            per.set(p.name, (per.get(p.name) || 0) + p.money);
        });
    }
  });
  
  const perArr = Array.from(per, ([name, val]) => ({ name, val })).filter(x => x.val > 0).sort((a, b) => b.val - a.val).slice(0, 20);
  drawBars('chartPersons', perArr);
  analyticsData.persons = perArr;

  const byNameTeam = new Map(people.map(p => [p.name, p.team || '']));
  const teamMap = new Map();
  per.forEach((val, name) => {
    const team = byNameTeam.get(name) || 'Ohne Team';
    teamMap.set(team, (teamMap.get(team) || 0) + val);
  });
  const teamArr = Array.from(teamMap, ([name, val]) => ({ name, val })).filter(x => x.val > 0).sort((a, b) => b.val - a.val);
  drawBars('chartTeams', teamArr);
  analyticsData.teams = teamArr;
  
  const totalArr = [
    { name: 'Fixauftr√§ge', val: fixTotal },
    { name: 'Rahmenvertr√§ge', val: rahmenTotal },
    { name: 'Gesamt', val: fixTotal + rahmenTotal }
  ];
  drawBars('chartTotals', totalArr);
  analyticsData.totals = totalArr;
}

// Zeitintervall-basierte Aktivit√§t der Rahmenvertr√§ge
function renderActivityAnalytics() {
    const start = getTimestamp(anaStartDate.value);
    // Ende des Tages f√ºr das Enddatum nehmen
    const end = getTimestamp(anaEndDate.value + 'T23:59:59.999'); 
    
    if (!start || !end || end < start) {
        showToast('Ung√ºltiger Datumsbereich', 'bad');
        drawBars('chartActivity', [], false); // Leere Grafik anzeigen
        document.getElementById('chartActivityTitle').textContent = 'Aktivste Rahmenvertr√§ge (ung√ºltiger Zeitraum)';
        return;
    }
    
    const rahmenMap = new Map();
    entries.filter(e => e.projectType === 'rahmen').forEach(e => {
        let total = 0;
        let count = 0;
        (e.transactions || []).forEach(t => {
            const datum = t.freigabedatum || t.ts || 0; // Freigabedatum prim√§r
            if (datum >= start && datum <= end) {
                total += (t.amount || 0);
                count++;
            }
        });
        if (total > 0) {
            // Speichere ID, um Duplikate zu vermeiden, falls Titel nicht eindeutig
            rahmenMap.set(e.id, { id: e.id, name: e.title, val: total, count: count });
        }
    });
    
    const rahmenArr = Array.from(rahmenMap.values()).sort((a,b) => b.val - a.val).slice(0, 10);
    const title = `Aktivste Rahmenvertr√§ge (${new Date(start).toLocaleDateString('de-DE')} - ${new Date(end).toLocaleDateString('de-DE')})`;
    document.getElementById('chartActivityTitle').textContent = title;
    drawBars('chartActivity', rahmenArr, true); // showCount = true
}


function drawBars(hostId, items, showCount = false) {
  const host = document.getElementById(hostId);
  host.innerHTML = ''; // Clear previous chart
  const max = items.reduce((m, x) => Math.max(m, x.val), 0) || 1; // Avoid division by zero
  const barH = 30, gap = 8, w = 1060; // Fixed width
  const h = items.length > 0 ? (items.length * (barH + gap) + 10) : 50; // Dynamic height or fixed minimum
  const svgNS = "http://www.w3.org/2000/svg";
  const svg = document.createElementNS(svgNS, 'svg');
  svg.setAttribute('viewBox', `0 0 ${w} ${h}`);
  svg.setAttribute('preserveAspectRatio', 'xMinYMin meet'); // Ensure it scales correctly if container width changes
  
  let y = 10;
  const textWidth = 240, barStartX = textWidth;
  const valueOffset = 100; // Space for value label at the end

  items.forEach(it => {
    // Calculate bar length based on available space minus text label and value offset
    const len = Math.max(4, Math.round((it.val / max) * (w - barStartX - valueOffset)));
    const g = document.createElementNS(svgNS, 'g');
    
    const titleText = `${it.name}: ${fmtCurr0.format(it.val)}` + (showCount && it.count ? ` (${it.count} Abrufe)` : '');
    const title = document.createElementNS(svgNS, 'title');
    title.textContent = titleText;
    g.appendChild(title);

    const rect = document.createElementNS(svgNS, 'rect');
    rect.setAttribute('x', String(barStartX)); rect.setAttribute('y', String(y));
    rect.setAttribute('rx', '6'); rect.setAttribute('ry', '6');
    rect.setAttribute('width', String(len)); rect.setAttribute('height', String(barH));
    rect.setAttribute('fill', '#3b82f6');

    const labelL = document.createElementNS(svgNS, 'text');
    labelL.setAttribute('x', '10'); labelL.setAttribute('y', String(y + barH * 0.68));
    labelL.setAttribute('fill', '#cbd5e1'); labelL.setAttribute('font-size', '14');
    labelL.textContent = it.name.length > 30 ? it.name.substring(0,28)+'...' : it.name;

    const labelV = document.createElementNS(svgNS, 'text');
    labelV.setAttribute('y', String(y + barH * 0.68));
    labelV.setAttribute('font-weight', '700');
    labelV.setAttribute('font-size', '14');
    // Add count if requested
    const valueText = fmtCurr0.format(it.val) + (showCount && it.count ? ` (${it.count})` : '');
    labelV.textContent = valueText;
    
    // Position value label inside or outside based on bar length
    const valueTextLengthEstimate = valueText.length * 8; // Rough estimate
    if(len < valueTextLengthEstimate + 10) { // Place outside if bar is too short
      labelV.setAttribute('x', String(barStartX + len + 8));
      labelV.setAttribute('fill', '#cbd5e1');
    } else { // Place inside
      labelV.setAttribute('x', String(barStartX + 10));
      labelV.setAttribute('fill', '#0a0f16');
    }

    g.appendChild(rect); g.appendChild(labelL); g.appendChild(labelV);
    svg.appendChild(g);
    y += barH + gap;
  });
  
  // Display message if no data
  if (items.length === 0) {
      const noData = document.createElementNS(svgNS, 'text');
      noData.setAttribute('x', '10'); noData.setAttribute('y', '30');
      noData.setAttribute('fill', '#cbd5e1'); noData.setAttribute('font-size', '14');
      noData.textContent = 'F√ºr diesen Zeitraum/dieses Jahr liegen keine Daten vor.';
      svg.appendChild(noData);
  }
  host.appendChild(svg);
}

btnAnaXlsx.addEventListener('click', () => {
    const year = anaYear.value;
    const wb = XLSX.utils.book_new();
    
    // Ensure data exists before creating sheets
    if (analyticsData.persons && analyticsData.persons.length > 0) {
        const ws1Arr = analyticsData.persons.map(p => ({ Name: p.name, Betrag_EUR: p.val }));
        const ws1 = XLSX.utils.json_to_sheet(ws1Arr);
        XLSX.utils.book_append_sheet(wb, ws1, "Top Personen");
    }
    if (analyticsData.teams && analyticsData.teams.length > 0) {
        const ws2Arr = analyticsData.teams.map(t => ({ Team: t.name, Betrag_EUR: t.val }));
        const ws2 = XLSX.utils.json_to_sheet(ws2Arr);
        XLSX.utils.book_append_sheet(wb, ws2, "Teams Aggregiert");
    }
     if (analyticsData.totals && analyticsData.totals.length > 0) {
        const ws3Arr = analyticsData.totals.map(t => ({ Typ: t.name, Betrag_EUR: t.val }));
        const ws3 = XLSX.utils.json_to_sheet(ws3Arr);
        XLSX.utils.book_append_sheet(wb, ws3, "Gesamt");
    }
    
    // Add activity data if available (simple export of the current view)
    const activityChart = document.getElementById('chartActivity');
    if(activityChart && activityChart.innerHTML !== '') {
         const start = anaStartDate.value;
         const end = anaEndDate.value;
         const activityItems = Array.from(document.querySelectorAll('#chartActivity g')).map(g => {
             const name = g.querySelector('text[x="10"]').textContent;
             const valueText = g.querySelector('text[font-weight="700"]').textContent;
             const amountMatch = valueText.match(/([\d.]+,\d+)\s‚Ç¨/); // Extract amount
             const amount = amountMatch ? parseAmountInput(amountMatch[1]) : 0;
             const countMatch = valueText.match(/\((\d+)\)/); // Extract count
             const count = countMatch ? parseInt(countMatch[1]) : null;
             return { Rahmenvertrag: name, Betrag_EUR: amount, Abrufe: count };
         });
         if(activityItems.length > 0) {
             const ws4 = XLSX.utils.json_to_sheet(activityItems);
             XLSX.utils.book_append_sheet(wb, ws4, `Aktivit√§t ${start}-${end}`);
         }
    }

    if(wb.SheetNames.length > 0) {
      XLSX.writeFile(wb, `auswertung_${year}_export.xlsx`);
    } else {
        showToast('Keine Daten zum Exportieren vorhanden.', 'warn');
    }
});

/* ---------- Init & Window Events ---------- */
function initFromState(isEditing = false){
  const st=loadState();
  if(st?.input){
    const isEditFromHistory = !!st.editingId;
    loadInputForm(st.input, isEditFromHistory);
  } else {
    loadInputForm({}, false); // Ensure default freigabedatum is set
  }
  updateWeightNote(); 
}

// Warnung bei ungespeicherten √Ñnderungen oder laufendem Batch
window.addEventListener('beforeunload', (e) => {
  if (hasUnsavedChanges || isBatchRunning) {
    const msg = isBatchRunning ? 'Eine Batch-Verarbeitung l√§uft noch. Sind Sie sicher, dass Sie die Seite verlassen wollen?' : 'Ungespeicherte √Ñnderungen gehen verloren. Sind Sie sicher?';
    e.preventDefault(); // Standard f√ºr die meisten Browser
    e.returnValue = msg; // F√ºr √§ltere Browser / Electron
    return msg; // F√ºr manche Browser
  }
});

// Initialisierung nach Laden der Personenliste
loadPeople().then(()=>{ 
    initFromState(); 
    showView('erfassung'); 
    // Setze initialen Fokus (optional)
    // document.getElementById('auftraggeber').focus(); 
});

// Deep Link zu Admin (optional)
if (location.hash === '#admin') { 
    // Warte kurz, damit die UI bereit ist, bevor der Pw-Prompt kommt
    setTimeout(handleAdminClick, 100); 
}

// Verhindere Standard-Enter-Verhalten in Inputs au√üerhalb von Admin
document.addEventListener('keydown',(e)=>{ 
    if(e.key==='Enter' && e.target?.tagName==='INPUT' && !e.target.closest('#viewAdmin')) {
        e.preventDefault(); 
        // Optional: Springe zum n√§chsten Feld oder l√∂se Button aus? Eher nicht, kann verwirren.
    }
});
</script>
</body>
</html>
