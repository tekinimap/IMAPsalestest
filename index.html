<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>dock</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#0a0f16; --panel:#0f1724; --panel2:#0c1320; --text:#e6ebf3; --muted:#94a3b8; --border:#213044;
    --accent:#3b82f6; --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b; --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial}
  .container{max-width:1380px;margin:28px auto;padding:0 20px}
  
  .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px; flex-wrap: wrap; gap: 14px;}
  .topbar-brand{display:flex;align-items:center;gap:12px;}
  .app-logo{
    display:block;
    width:auto;
    height:auto;
    max-height:42px;
    background-color:transparent;
  }
  .main-nav{display:flex;gap:10px; flex-wrap: wrap;}
  .nav-link{font-size:14px;font-weight:600;color:#cbd5e1;padding:8px 14px;border:1px solid var(--border);border-radius:999px;background:#0b1326;cursor:pointer; text-decoration: none;}
  .nav-link:hover{background-color: var(--panel2);}
  .nav-link.active{background:var(--accent); color: var(--text); border-color: var(--accent);}
  .nav-link.disabled{opacity:.45;cursor:not-allowed;filter:grayscale(35%)}

  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 12px 32px rgba(0,0,0,.35);overflow:hidden;margin-bottom:18px}
  .hd{padding:20px 22px 8px}.hd h1{margin:0 0 8px;font-size:24px}.hd p{margin:0;color:var(--muted);font-size:14px}
  .ct{padding:20px 22px 24px}
  
  .sum-display { font-size: 18px; font-weight: 600; color: var(--muted); margin-top: -8px; margin-bottom: 8px; }
  .sum-display span { color: var(--text); font-size: 20px; }

  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
  .grid-admin{display:grid;grid-template-columns:minmax(0,1.4fr) minmax(0,1.2fr) minmax(0,1.4fr) auto;gap:16px;align-items:end;}
  @media (max-width: 960px){
    .grid-admin{grid-template-columns:1fr;}
    .grid-admin>div{width:100%;}
    .grid-admin>div:last-child{justify-self:flex-start;}
  }
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  label{display:block;font-weight:600;margin:8px 0 6px}
  input[type="text"],input[type="number"],input[type="date"],select{
    width:100%;background:var(--panel2);color:var(--text);border:1px solid var(--border);
    border-radius:10px;padding:12px;outline:none; font-size:15px;
  }
  input:disabled { background-color: #0a0f16; opacity: 0.6; }
  input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.35)}
  .note{color:var(--muted);font-size:13px; margin-top: 8px;}
  .info-box{background: var(--panel2); border: 1px solid var(--border); padding: 12px; border-radius: 10px; font-size: 13px; color: var(--muted); margin-bottom: 16px;}
  .actions{display:flex;gap:12px;flex-wrap:wrap;justify-content:space-between;align-items:center}
  .btn{appearance:none;border:1px solid var(--border);background:#0d1426;color:var(--text);padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:600; font-size:15px;}
  .btn.primary{background:var(--accent);border-color:transparent}
  .btn.disabled{opacity:.5;pointer-events:none}
  .btn.ok{background:var(--ok);border-color:transparent}
  .btn.danger{background:var(--bad);border-color:transparent}
  .btn.warn{background:var(--warn);border-color:transparent}
  .tag{background:#0c162b;border:1px solid var(--border);color:var(--muted);padding:8px 12px;border-radius:999px;font-size:13px}

  .dock-toolbar{display:flex;flex-wrap:wrap;align-items:flex-end;justify-content:space-between;gap:16px;margin-bottom:24px}
  .dock-filters{display:flex;flex-wrap:wrap;align-items:flex-end;gap:16px}
  .dock-filter{display:flex;flex-direction:column;gap:6px;min-width:160px}
  .dock-filter label{font-size:11px;text-transform:uppercase;letter-spacing:0.08em;color:rgba(148,163,184,.8)}
  .dock-actions{display:flex;flex-wrap:wrap;align-items:center;gap:10px}
  .dock-board{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px;margin-bottom:20px}
  .dock-column{background:var(--panel2);border:1px solid var(--border);border-radius:var(--radius);padding:16px;display:flex;flex-direction:column;gap:12px;min-height:240px}
  .dock-column-header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
  .dock-column-header h2{margin:0;font-size:16px}
  .dock-column-header p{margin:6px 0 0;font-size:12px;color:var(--muted)}
  .dock-column-count{font-size:12px;color:var(--muted);background:#0b1326;border:1px solid var(--border);padding:4px 10px;border-radius:999px;white-space:nowrap}
  .dock-column-body{display:flex;flex-direction:column;gap:12px}
  .dock-card{background:var(--panel);border:1px solid rgba(59,130,246,.25);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:8px;box-shadow:0 10px 24px rgba(8,15,28,.35)}
  .dock-card.is-selected{border-color:var(--accent);box-shadow:0 0 0 2px rgba(59,130,246,.35);}
  .dock-card-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
  .dock-card-headline{display:flex;align-items:flex-start;gap:8px;flex:1;min-width:0;}
  .dock-card-title{margin:0;font-size:15px;font-weight:600;color:var(--text);line-height:1.25;word-break:break-word;display:flex;align-items:center;gap:6px;}
  .dock-card-title-text{display:inline;flex:1 1 auto;}
  .dock-card-flag{display:inline-flex;align-items:center;justify-content:center;font-size:14px;line-height:1;height:1em;}
  .dock-card-actions{display:flex;align-items:center;gap:6px;}
  .dock-card-select{display:inline-flex;align-items:center;gap:6px;opacity:0;pointer-events:none;transition:opacity .15s ease;}
  .dock-card:hover .dock-card-select,.dock-card.is-selected .dock-card-select,.dock-card-select:focus-within{opacity:1;pointer-events:auto;}
  .dock-card-select input{appearance:none;width:18px;height:18px;border:1px solid rgba(148,163,184,.5);border-radius:6px;background:#0b1326;display:inline-grid;place-items:center;cursor:pointer;}
  .dock-card-select input:checked{background:var(--accent);border-color:var(--accent);}
  .dock-card-select input:checked::after{content:'‚úì';color:#fff;font-size:12px;font-weight:700;}
  .dock-card-select input:focus-visible{outline:2px solid rgba(59,130,246,.6);outline-offset:2px;}
  .dock-card-edit{appearance:none;border:1px solid var(--border);background:#0c1320;color:var(--text);width:32px;height:32px;border-radius:10px;display:inline-grid;place-items:center;cursor:pointer;transition:background .15s;}
  .dock-card-edit:hover{background:var(--panel2);}
  .dock-card-edit svg{width:18px;height:18px;stroke-width:1.6;stroke:var(--text);fill:none;}
  .dock-card-meta{margin:0;font-size:13px;color:var(--muted);display:flex;flex-direction:column;gap:4px;line-height:1.25;}
  .dock-card-meta-row{display:flex;align-items:center;gap:8px;}
  .dock-card-meta-row strong{color:var(--text);font-weight:600;min-width:120px;}
  .dock-card-meta-row .status-icon{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:6px;font-size:12px;font-weight:700;}
  .dock-card-meta-row.ok .status-icon{background:rgba(34,197,94,.18);color:#bbf7d0;}
  .dock-card-meta-row.missing .status-icon{background:rgba(245,158,11,.18);color:#fcd34d;}
  .dock-card-meta-row.missing strong{color:#fcd34d;}
  .dock-card-meta-row.missing{color:#facc15;}
  .dock-badge-row{display:flex;flex-wrap:wrap;gap:6px}
  .dock-pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-size:11px;font-weight:600;background:#0b1326;border:1px solid var(--border);color:var(--muted)}
  .dock-pill.accent{background:rgba(59,130,246,.18);border-color:rgba(59,130,246,.35);color:#bfdbfe}
  .dock-pill.ok{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.35);color:#bbf7d0}
  .dock-pill.warn{background:rgba(245,158,11,.18);border-color:rgba(245,158,11,.4);color:#fde68a}
  .dock-card-footer{display:flex;flex-wrap:wrap;gap:6px;margin-top:2px;align-items:center}
  .dock-card-footer .btn.tight{padding:6px 12px;font-size:12px;border-radius:10px}
  .dock-card-footer .btn.compact{padding:6px 10px;font-size:12px;border-radius:10px}
  .dock-card-hint{border:1px solid rgba(148,163,184,.25);border-radius:10px;padding:10px 12px;background:rgba(11,17,26,.75);display:flex;flex-direction:column;gap:8px;font-size:12px;}
  .dock-card-hint-text{margin:0;color:var(--text);line-height:1.35;}
  .dock-card-hint.hint-warn{border-color:rgba(245,158,11,.4);background:rgba(245,158,11,.12);}
  .dock-card-hint.hint-bad{border-color:rgba(239,68,68,.45);background:rgba(239,68,68,.12);}
  .dock-card-hint strong{color:var(--text);}
  .dock-card-hint-actions{display:flex;flex-wrap:wrap;gap:6px;}
  .dock-card-hint-actions .btn.tight{padding:6px 10px;font-size:12px;}
  .dock-empty{background:var(--panel2);border:1px dashed var(--border);border-radius:var(--radius);padding:24px;text-align:center;color:var(--muted);margin-bottom:24px}
  .dock-empty-note{margin-top:6px;}
  .dock-manual{border:1px solid rgba(148,163,184,.25);border-radius:var(--radius);background:rgba(11,17,26,.65);backdrop-filter:blur(6px);padding:20px;margin-top:12px;box-shadow:0 12px 24px rgba(8,15,28,.35)}
  .dock-manual-header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
  .dock-manual-header h2{margin:0;font-size:18px}
  .dock-manual-header p{margin:4px 0 0;font-size:13px;color:var(--muted)}
  .dock-manual-actions{display:flex;gap:10px;align-items:center}
  .dock-manual label{margin:6px 0 4px}
  .dock-manual .grid-3{gap:12px}
  .dock-manual .dock-compact-row{margin-top:8px}
  .dock-manual input[type="text"],
  .dock-manual input[type="number"],
  .dock-manual input[type="date"],
  .dock-manual select{padding:8px 10px;font-size:13px}
  .dock-manual .checkbox-wrapper{margin-top:4px}
  .dock-manual .checkbox-wrapper label{margin:0;font-weight:500;font-size:12px;color:var(--muted)}
  .dock-manual .hr{margin:18px 0}
  .dock-manual .actions{margin-top:10px}
  .dock-manual .table-wrapper{margin-top:10px}
  .dock-manual table{min-width:0}
  .dock-manual thead th{padding:8px 10px;font-size:12px}
  .dock-manual tbody td{padding:6px 10px;font-size:12px}
  .dock-manual tbody td .delrow{padding:6px 10px;font-size:12px}
  .dock-manual .live-result{display:flex;align-items:center;gap:6px}
  .dock-manual .live-result .pct{display:inline;font-size:13px}
  .dock-manual .live-result .money{display:inline;font-size:11px}
  .dock-manual .note{margin-top:4px}
  .dock-manual .form-bottom-actions{margin-top:16px}
  .dock-manual .meta-edit-section{padding:12px 14px}
  .dock-manual .meta-edit-section .meta-edit-summary{gap:6px 12px}
  .dock-manual .meta-summary-value{font-size:12px}

  #btnDockBatchDelete{background:#ef4444;border-color:transparent;}
  #btnDockBatchDelete:disabled{opacity:.45;cursor:not-allowed;}
  #btnDockBatchDelete:not(:disabled):hover{filter:brightness(1.05);}
  #dockEntryDialog{border:1px solid rgba(59,130,246,.35);background:rgba(11,18,30,.98);color:var(--text);border-radius:14px;padding:0;max-width:1100px;width:96vw;}
  #dockEntryDialog::backdrop{background:rgba(8,15,25,.65);backdrop-filter:blur(4px);}
  .dock-modal-layout{display:flex;gap:0;max-height:80vh;}
  #dockManualPanel{flex:1 1 auto;max-height:80vh;overflow-y:auto;}
  @media (max-width:980px){
    .dock-modal-layout{flex-direction:column;max-height:none;}
    #dockManualPanel{max-height:none;}
  }

  @media (max-width:768px){
    .dock-board{grid-template-columns:1fr}
    .dock-filter{min-width:100%}
    .dock-toolbar{flex-direction:column;align-items:stretch}
    .dock-filters{flex-direction:column;align-items:stretch}
    .dock-column{min-height:200px}
  }
  
  .radio-group {display:flex; gap:12px; margin-top: 8px;}
  .radio-group label {display:flex; align-items:center; gap:6px; font-weight:normal; font-size:14px;}

  .table-wrapper{width:100%;border:1px solid var(--border);border-radius:12px;overflow-x:auto;background:#0b1120}
  table{width:100%;min-width:980px;border-collapse:collapse}
  thead th{position:sticky;top:0;background:#0d162a;border-bottom:1px solid var(--border);padding:12px;text-align:left;font-size:13px}
  tbody td{border-top:1px solid var(--border);padding:10px 12px; vertical-align: middle;}
  tbody tr:hover{background:#0c1426}
  tbody tr.clickable { cursor: pointer; }
  .delrow{background:#13203b;border:1px solid #21314f;color:#cbd5e1;border-radius:8px;padding:6px 8px;cursor:pointer}

  .sumchips{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .chip{background:#0b1220;border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:12px;display:inline-flex;align-items:center;gap:8px}
  .chip .dot{width:8px;height:8px;border-radius:50%}
  .chip.ok .dot{background:var(--ok)} .chip.bad .dot{background:var(--bad)} .chip.warn .dot{background:var(--warn)}
  
  .live-result{font-size:13px; font-weight: 600; color: var(--muted);}
  .live-result .pct{color: var(--text); display: block; font-size: 15px;}
  .live-result .money{font-size: 12px;}

  .hr{height:1px;background:var(--border);margin:24px 0}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .small{font-size:12px}
  .hide{display:none !important}
  
  .search-wrapper{display:flex; gap:10px; margin-bottom:12px; align-items: center; flex-wrap: wrap;}
  .search-wrapper input {flex-grow:1;}
  .batch-actions { display: flex; gap: 10px; }
  .merge-suggestions { background:#0b1220; border:1px solid var(--border); border-radius:12px; padding:12px 14px; margin-bottom:14px; }
  .merge-suggestions-title { margin:0 0 8px; font-weight:600; font-size:13px; color:var(--muted); }
  .merge-suggestions-list { display:flex; flex-direction:column; gap:8px; }
  .merge-suggestion-item { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; background:#0d162a; border:1px solid rgba(148,163,184,.25); border-radius:10px; padding:10px 12px; }
  .merge-suggestion-text { display:flex; flex-direction:column; gap:2px; font-size:13px; color:var(--text); }
  .merge-suggestion-text strong { font-size:14px; }
  .merge-suggestion-text span { color:var(--muted); font-size:12px; }
  .merge-suggestion-detail { color:var(--muted); font-size:12px; }
  .btn.tight { padding:8px 12px; font-size:13px; white-space:nowrap; }
  #historyBody tr.merge-suggestion-highlight { outline:1px solid var(--accent); box-shadow:0 0 0 2px rgba(59,130,246,.35); }

  th.sortable{cursor:pointer;}
  th.sortable:hover{background-color: var(--panel2);}
  th .sort-icon{display:inline-block; width:1em; opacity:0.5;}
  th.col-check { width: 40px; padding: 12px 10px; text-align: center; }
  td.col-check { text-align: center; }
  
  .field-error {color:var(--bad); font-size:13px; font-weight:600; padding-top:4px; min-height:1.2em;}
  input.invalid-field, select.invalid-field {border-color:var(--bad) !important; box-shadow:0 0 0 3px rgba(239, 68, 68, .25) !important;}
  .checkbox-wrapper{display:flex; align-items:center; gap:8px; margin-top: 8px;}

  .iconbtn{appearance:none;border:1px solid var(--border);background:#0c1320;color:var(--text);width:36px;height:36px;border-radius:10px;display:inline-grid;place-items:center;cursor:pointer}
  .iconbtn:hover{background:var(--panel2);}
  .iconbtn svg { width: 20px; height: 20px; }
  .iconbtn[data-act="del"] svg{stroke-width:1.5;stroke:rgba(239,68,68,.8)}
  .iconbtn[data-act="edit"] svg{stroke-width:1.5}
  .form-bottom-actions{display:flex;gap:16px;align-items:center;justify-content:flex-end;flex-wrap:wrap;margin-top:18px;}
  .form-bottom-buttons{display:flex;gap:10px;}
  .meta-edit-section{position:relative;margin-right:auto;display:flex;flex-direction:column;gap:10px;min-width:0;width:auto;max-width:100%;padding:12px 14px;border-radius:12px;background:rgba(11,17,26,.65);border:1px solid rgba(148,163,184,.18);box-shadow:0 8px 18px rgba(8,15,28,.3);backdrop-filter:blur(6px);}
  .meta-edit-section .meta-edit-header{display:flex;justify-content:space-between;align-items:center;gap:8px;}
  .meta-edit-section .meta-edit-title{display:flex;flex-direction:column;gap:2px;min-width:0;}
  .meta-edit-section .meta-edit-eyebrow{font-size:10px;font-weight:600;letter-spacing:0.08em;text-transform:uppercase;color:rgba(148,163,184,.75);}
  .meta-edit-section .meta-edit-title h3{margin:0;font-size:13px;font-weight:600;color:#dbe4f3;}
  .meta-edit-section .meta-edit-header .btn{width:auto;padding:6px 12px;font-size:12px;border-radius:999px;}
  .meta-edit-section .meta-edit-header .hide{display:none;}
  .meta-edit-section .meta-edit-summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:6px 14px;padding-top:0;align-items:flex-start;}
  .meta-summary-row{display:flex;flex-direction:column;gap:2px;min-width:0;}
  .meta-summary-label{font-size:10px;font-weight:600;letter-spacing:0.02em;text-transform:uppercase;color:rgba(148,163,184,.7);}
  .meta-summary-value{font-size:13px;font-weight:600;color:#f8fafc;word-break:break-word;}
  .meta-edit-section .meta-edit-fields{display:none;gap:10px;flex-wrap:wrap;}
  .meta-edit-section .meta-edit-fields .meta-field{display:flex;flex-direction:column;gap:4px;flex:1 1 160px;min-width:150px;}
  .meta-edit-section .meta-edit-fields label{font-weight:600;font-size:11px;color:rgba(203,213,225,.8);text-transform:uppercase;letter-spacing:0.03em;}
  .meta-edit-section .meta-edit-fields input{padding:8px 10px;font-size:13px;border-radius:9px;background:rgba(11,17,32,.85);border:1px solid rgba(51,65,85,.55);width:100%;}
  .meta-edit-section .meta-edit-fields input:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(59,130,246,.25);}
  .meta-edit-section .meta-edit-fields .field-error{min-height:0;}
  .meta-edit-section.is-editing,.meta-edit-section.meta-edit-inline{border-color:rgba(59,130,246,.35);box-shadow:0 10px 22px rgba(12,20,34,.45);}
  .meta-edit-section.meta-edit-available:not(.is-editing){border-color:rgba(59,130,246,.25);}
  .meta-edit-section.is-editing .meta-edit-summary,.meta-edit-section.meta-edit-inline .meta-edit-summary{display:none;}
  .meta-edit-section.is-editing .meta-edit-fields,.meta-edit-section.meta-edit-inline .meta-edit-fields{display:flex;}
  @media (max-width:768px){
    .meta-edit-section{width:100%;margin-right:0;}
    .form-bottom-actions{flex-direction:column;align-items:stretch;}
    .form-bottom-actions .btn.primary{width:100%;}
  }

  /* Fixauftr√§ge ‚Äì kompaktere Tabelle */
  #viewFixauftraege .table-wrapper{overflow-x:auto;}
  #viewFixauftraege table{min-width:0;table-layout:fixed;}
  #viewFixauftraege thead th{font-size:11px;padding:9px 10px;white-space:normal;}
  #viewFixauftraege tbody td{padding:7px 10px;font-size:12px;white-space:normal;word-break:break-word;}
  #viewFixauftraege th.col-check,#viewFixauftraege td.col-check{width:42px;padding-left:8px;padding-right:8px;}
  #viewFixauftraege th[data-sort="projectNumber"],#viewFixauftraege td:nth-child(2){width:12%;}
  #viewFixauftraege th[data-sort="title"],#viewFixauftraege td:nth-child(3){width:20%;}
  #viewFixauftraege th[data-sort="client"],#viewFixauftraege td:nth-child(4){width:14%;}
  #viewFixauftraege th[data-sort="source"],#viewFixauftraege td:nth-child(5){width:10%;}
  #viewFixauftraege th[data-sort="submittedBy"],#viewFixauftraege td:nth-child(6){width:16%;}
  #viewFixauftraege th.col-amount,#viewFixauftraege td.col-amount{width:9%;white-space:nowrap;text-align:right;}
  #viewFixauftraege th.col-date,#viewFixauftraege td.col-date{width:9%;white-space:nowrap;text-align:right;}
  #viewFixauftraege td.col-amount,#viewFixauftraege td.col-date{font-variant-numeric:tabular-nums;}
  #viewFixauftraege th:last-child{width:10%;}
  #viewFixauftraege td .status-wrapper{display:flex;align-items:center;}
  #viewFixauftraege td .status-wrapper .status-indicator{flex:none;}
  #viewFixauftraege td .status-wrapper span:last-child{flex:1;min-width:0;display:block;}
  #viewFixauftraege td.cell-actions{display:flex;gap:6px;flex-wrap:wrap;align-items:center;}
  #viewFixauftraege td.cell-actions .iconbtn{width:32px;height:32px;}
  #viewFixauftraege .history-section-header td{
    padding:16px 12px 6px;
    background:transparent;
    border-top:1px solid var(--border);
  }
  #viewFixauftraege .history-section-header .section-tag{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 14px;
    border-radius:999px;
    font-size:12px;
    font-weight:700;
    letter-spacing:0.01em;
    text-transform:none;
  }
  #viewFixauftraege .history-section-header .section-tag .section-title{
    display:inline-flex;
    align-items:center;
  }
  #viewFixauftraege .history-section-header .section-tag .section-count{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:26px;
    padding:3px 8px;
    border-radius:999px;
    font-size:11px;
    font-weight:600;
    letter-spacing:normal;
  }
  #viewFixauftraege .history-section-header .section-tag.bad{
    background:rgba(239,68,68,.18);
    border:1px solid rgba(239,68,68,.35);
    color:#fecaca;
  }
  #viewFixauftraege .history-section-header .section-tag.bad .section-count{
    background:rgba(239,68,68,.35);
    color:#fff;
  }
  #viewFixauftraege .history-section-header .section-tag.ok{
    background:rgba(34,197,94,.16);
    border:1px solid rgba(34,197,94,.32);
    color:#bbf7d0;
  }
  #viewFixauftraege .history-section-header .section-tag.ok .section-count{
    background:rgba(34,197,94,.32);
    color:#052e16;
  }
  #viewFixauftraege .history-section-header .section-tag .section-icon{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:18px;
    height:18px;
    border-radius:50%;
    background:rgba(15,23,36,.45);
    font-size:12px;
  }
  #viewFixauftraege .history-section-header .section-tag.bad .section-icon{background:rgba(127,29,29,.65);color:#fff;}
  #viewFixauftraege .history-section-header .section-tag.ok .section-icon{background:rgba(20,83,45,.65);color:#fff;}
  #viewFixauftraege .status-indicator{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:18px;
    height:18px;
    border-radius:999px;
    font-size:12px;
    font-weight:700;
    margin-right:6px;
  }
  #viewFixauftraege .status-indicator.ok{
    background:rgba(34,197,94,.18);
    border:1px solid rgba(34,197,94,.4);
    color:#86efac;
  }
  #viewFixauftraege .status-indicator.bad{
    background:rgba(239,68,68,.18);
    border:1px solid rgba(239,68,68,.4);
    color:#fecaca;
  }
  #viewFixauftraege th[data-sort="submittedBy"],#viewFixauftraege td:nth-child(6){width:14%;}
  #viewFixauftraege th:nth-child(7),#viewFixauftraege td:nth-child(7){width:8%;}
  #viewFixauftraege th[data-sort="amount"],#viewFixauftraege td:nth-child(8){width:7%;}
  #viewFixauftraege th[data-sort="freigabedatum"],#viewFixauftraege td:nth-child(9){width:7%;}
  #viewFixauftraege th:last-child{width:8%;}
  #viewFixauftraege td.cell-actions{display:flex;gap:6px;flex-wrap:wrap;align-items:center;}
  #viewFixauftraege td.cell-actions .iconbtn{width:32px;height:32px;}
  #viewFixauftraege .history-section-header td{
    padding:9px 10px;
    font-size:11px;
    font-weight:700;
    color:#cbd5e1;
    background:#111a2d;
    text-transform:uppercase;
    letter-spacing:0.04em;
  }
  #viewFixauftraege .history-section-header td span{
    color:var(--muted);
    font-weight:600;
    text-transform:none;
    letter-spacing:normal;
  }
  #viewFixauftraege .filter-group{display:flex;flex-direction:column;gap:4px;min-width:220px;}
  #viewFixauftraege .filter-group label{font-size:12px;font-weight:600;color:var(--muted);margin:0;}
  #viewFixauftraege select#personFilter{width:auto;min-width:220px;max-width:260px;padding:8px 12px;font-size:13px;}

  .chart{background:#0c1324;border:1px solid var(--border);border-radius:12px;padding:14px}
  .chart h3{margin:0 0 10px 0;font-size:15px;color:#cbd5e1}
  .chart svg{width:100%;height:auto}
  
  .analytics-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; flex-wrap: wrap; }
  .analytics-controls label { margin: 0; font-weight: 500; color: var(--muted); }
  .analytics-controls input[type="date"], .analytics-controls select { padding: 8px 10px; font-size: 14px; width: auto; }
  .analytics-controls .btn { padding: 8px 14px; font-size: 14px; }
  .metrics-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin:16px 0;}
  .metric-card{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:14px 16px;min-height:96px;display:flex;flex-direction:column;justify-content:center;}
  .metric-card .label{color:var(--muted);font-size:12px;font-weight:600;letter-spacing:0.02em;text-transform:uppercase;}
  .metric-card .value{font-size:20px;font-weight:700;margin-top:6px;color:var(--text);}
  .metric-card .sub{color:var(--muted);font-size:13px;margin-top:4px;}
  .chart-canvas{min-height:220px;}
  .log-metrics-empty{color:var(--muted);font-size:14px;padding:10px;}
  
  /* --- Feedback & Loader --- */
  .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--panel2);color:var(--text);padding:12px 20px;border-radius:10px;border:1px solid var(--border);box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:9999;opacity:0;transition:opacity .3s, bottom .3s;font-weight:600;}
  .toast.show{opacity:1;bottom:30px;}
  .toast.ok{background:var(--ok);border-color:transparent;}
  .toast.bad{background:var(--bad);border-color:transparent;}
  .loader{position:fixed;top:20px;right:20px;width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;z-index:10000;}
  @keyframes spin{to{transform:rotate(360deg)}}
  
  /* --- Batch Progress Bar --- */
  #batchProgress {
    position: sticky; top: 10px; z-index: 9000;
    margin: -10px auto 18px auto; max-width: 1200px; padding: 16px 22px;
  }
  #batchProgress h3 { margin: 0 0 10px; font-size: 16px; }
  #batchProgress p { margin: 0; }
  #batchProgress .note { margin-top: 6px; }
  #batchProgressBar { width: 100%; height: 10px; margin: 8px 0 4px; }

  dialog {border:1px solid var(--border); background: var(--panel); color:var(--text); border-radius: var(--radius); max-width: 90vw; position:relative; overflow:visible;}
  dialog::backdrop {background:rgba(0,0,0,.5); backdrop-filter: blur(4px);}
  dialog .hd { position: relative; }
  .dialog-close {
    position:absolute;
    top:-18px;
    right:-18px;
    width:40px;
    height:40px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,.45);
    background:rgba(11,18,30,.95);
    color:var(--muted);
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:20px;
    line-height:1;
    padding:0;
    cursor:pointer;
    box-shadow:0 12px 28px rgba(8,15,28,.45);
    transition:background .2s ease, color .2s ease, border-color .2s ease, transform .2s ease;
    z-index:10;
  }
  .dialog-close:hover {
    background:var(--accent);
    border-color:var(--accent);
    color:#fff;
    transform:translateY(-1px);
  }
  .dialog-close:focus-visible {
    outline:3px solid rgba(59,130,246,.45);
    outline-offset:2px;
  }
  dialog .validation-summary { color: var(--warn); font-size: 13px; margin-top: -10px; margin-bottom: 10px; }


  /* --- Responsive Design --- */
  @media(max-width: 768px){
    .container{margin:16px auto; padding:0 12px;}
    .hd{padding:16px 18px 4px} .hd h1{font-size:20px} .hd p{font-size:13px}
    .ct{padding:16px 18px 20px}
    .grid-3, .grid-2 {grid-template-columns:1fr;}
    .topbar{flex-direction:column; gap:10px; align-items:flex-start;}
    .main-nav {width: 100%; justify-content: space-around;}
    .actions{flex-direction:column; align-items:stretch; gap:12px;}
    .btn{width:100%; text-align:center;}
    .form-bottom-actions{flex-direction:column; align-items:stretch !important; gap:16px !important;}
    .form-fields-group { flex-direction: column; gap: 10px !important; }
    .form-fields-group > div { width: 100%; }
    .form-fields-group input { width: 100% !important; }
    .search-wrapper { flex-direction: column; align-items: stretch; }
    .batch-actions { width: 100%; flex-direction: column; }
  }
  @media(max-width: 980px){
    table{min-width: 800px;}
  }

</style>

<style>
  /* LOGBOOK v2 additions */
  #btnLogbookFloat { display:none !important; } /* hide old floating button globally */
  dialog#logbookDlgV2 { border:1px solid #213044; background:#0f1724; color:#e6ebf3; border-radius:14px; padding:16px; min-width:920px; }
  #logbookV2 .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom: 10px; }
  #logbookV2 .controls input[type="date"],
  #logbookV2 .controls input[type="text"],
  #logbookV2 .controls select { padding:8px 10px; font-size:14px; }
  #logbookV2 table { width:100%; border-collapse:collapse; min-width:900px; }
  #logbookV2 th { text-align:left; border-bottom:1px solid #213044; padding:8px; }
  #logbookV2 td { padding:6px 8px; font-size:12px; border-bottom:1px dashed #213044; }
  .status.ev-ok { background: rgba(34,197,94,.18); border:1px solid rgba(34,197,94,.4); color:#86efac; padding:2px 6px; border-radius:8px;}
  .status.ev-skip { background: rgba(245,158,11,.18); border:1px solid rgba(245,158,11,.4); color:#fde68a; padding:2px 6px; border-radius:8px;}
  .status.ev-err { background: rgba(239,68,68,.18); border:1px solid rgba(239,68,68,.4); color:#fecaca; padding:2px 6px; border-radius:8px;}
  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .small { font-size: 12px; }
  .btn { background:#3b82f6; color:white; border:none; border-radius:10px; padding:8px 12px; cursor:pointer; }
  .btn:hover { filter:brightness(1.05); }
  .iconbtn.small { padding:6px 10px; border-radius:8px; font-size:12px; }
</style>

</head>
<body>

<div id="loader" class="loader hide"></div>
<div id="toast" class="toast"></div>

<div class="container">

  <div class="topbar">
    <div class="topbar-brand">
      <img src="public/dock_png_original.png" alt="dock Logo" loading="lazy" class="app-logo">
    </div>
    <div class="main-nav">
      <a href="#" class="nav-link active" data-view="erfassung">Dock</a>
      <a href="#" class="nav-link" data-view="fixauftraege">Fixauftr√§ge</a>
      <a href="#" class="nav-link" data-view="rahmen">Rahmenvertr√§ge</a>
      <a href="#" class="nav-link" data-view="analytics">Auswertung</a>
      <a href="#" class="nav-link" data-view="admin">Admin</a>
    </div>
  </div>
  
  <div id="batchProgress" class="card hide">
    <h3 id="batchTitle">Verarbeitung l√§uft...</h3>
    <p id="batchStatusLabel">Initialisiere...</p>
    <progress id="batchProgressBar" max="100" value="0"></progress>
    <p class="note small" id="batchThrottleNotice">Gedrosselter Schreibmodus aktiv, um Server-Limits einzuhalten. Dies kann einen Moment dauern.</p>
  </div>

  <div class="card" id="viewErfassung">
    <div class="hd">
      <h1>Dock</h1>
      <p id="erfassungSub">Im Dock landen alle neuen HubSpot-Deals zur Pr√ºfung. Die Karten wandern automatisch durch drei Phasen ‚Äì von der Ankunft √ºber die vollst√§ndige Datenerfassung und BU-Freigabe bis zur finalen Zuordnung in Fixauftr√§ge, neue Rahmenvertr√§ge oder Abrufe. Nutze die Filter f√ºr Business Units, Market Teams und &bdquo;Einsch√§tzung abzugeben von&ldquo;, um schnell deinen Verantwortungsbereich zu sehen. Manuelle Deals legen ausschlie√ülich Sales-Mitarbeitende √ºber den Button &bdquo;Deal manuell erstellen&ldquo; an.</p>
    </div>
    <div class="ct">
      <div class="dock-toolbar">
        <div class="dock-filters">
          <div class="dock-filter">
            <label for="dockFilterBu">Business Unit</label>
            <select id="dockFilterBu">
              <option value="">Alle Business Units</option>
              <option value="Public Impact">Public Impact</option>
              <option value="Organisational Excellence">Organisational Excellence</option>
            </select>
          </div>
          <div class="dock-filter">
            <label for="dockFilterMarketTeam">Market Team</label>
            <select id="dockFilterMarketTeam">
              <option value="">Alle Market Teams</option>
            </select>
          </div>
          <div class="dock-filter">
            <label for="dockFilterAssessment">Einsch√§tzung abzugeben von</label>
            <select id="dockFilterAssessment">
              <option value="">Alle Personen</option>
            </select>
          </div>
          <div class="dock-filter">
            <label for="dockSearch">Suche</label>
            <input type="text" id="dockSearch" placeholder="Titel, Kunde, KV...">
          </div>
        </div>
        <div class="dock-actions">
          <button class="btn danger" id="btnDockBatchDelete" type="button" disabled>Markierte L√∂schen</button>
          <button class="btn warn" id="btnManualDeal" type="button">Deal manuell erstellen</button>
        </div>
      </div>

      <div class="dock-board" id="dockBoard"></div>
      <div class="dock-empty hide" id="dockEmptyState">
        <strong>Aktuell gibt es keine offenen Deals im Dock.</strong>
        <div class="dock-empty-note">Sobald neue HubSpot-Deals eintreffen oder Freigaben anstehen, erscheinen sie hier wieder.</div>
      </div>

      <dialog id="dockEntryDialog">
        <button class="dialog-close" id="btnCloseManualDeal" type="button" aria-label="Modal schlie√üen">√ó</button>
        <div class="dock-modal-layout">
          <div id="dockManualPanel" class="dock-manual">
            <div class="dock-manual-header">
              <div>
                <h2>Deal bearbeiten oder anlegen</h2>
                <p>Nur Sales-Mitarbeitende legen Deals manuell an. Der Standardprozess l√§uft √ºber HubSpot.</p>
              </div>
            </div>
            <div id="abrufInfo" class="info-box hide"></div>
            <div class="grid-3">
              <div>
                <label for="auftraggeber">Auftraggeber *</label>
                <input id="auftraggeber" type="text" autocomplete="organization">
                <div class="field-error" data-validation-for="auftraggeber"></div>
              </div>
              <div>
                <label for="projekttitel">Projekttitel *</label>
                <input id="projekttitel" type="text">
                <div class="field-error" data-validation-for="projekttitel"></div>
              </div>
              <div>
                <label for="auftragswert">Auftragswert *</label>
                <input id="auftragswert" type="text" inputmode="decimal" placeholder="z. B. 120.000,00">
                <div class="checkbox-wrapper">
                  <input type="checkbox" id="auftragswertBekannt" checked>
                  <label for="auftragswertBekannt">Auftragswert bekannt?</label>
                </div>
                <div class="field-error" data-validation-for="auftragswert"></div>
              </div>
            </div>
            <div class="grid-3 dock-compact-row">
              <div>
                <label for="submittedBy">Einsch√§tzung abgegeben von *</label>
                <input id="submittedBy" type="text" list="peopleList" placeholder="Namen eintippen oder ausw√§hlen...">
                <div class="field-error" data-validation-for="submittedBy"></div>
              </div>
              <div id="projectTypeWrapper" style="grid-column: span 2;">
                <label>Projekttyp *</label>
                <div class="radio-group">
                  <label><input type="radio" name="projectType" value="fix" checked> Fixauftrag</label>
                  <label><input type="radio" name="projectType" value="rahmen"> Rahmenvertrag</label>
                </div>
              </div>
            </div>

            <div class="hr"></div>

            <div class="grid-3">
              <div>
                <label>Gewicht: Consultative Selling (%)</label>
                <input id="w_cs" type="number" min="0" max="100" step="1" value="50">
              </div>
              <div>
                <label>Gewicht: Konzepterstellung (%)</label>
                <input id="w_konzept" type="number" min="0" max="100" step="1" value="30">
              </div>
              <div>
                <label>Gewicht: Pitch (%)</label>
                <input id="w_pitch" type="number" min="0" max="100" step="1" value="20">
              </div>
            </div>
            <div class="note mono" id="w_note" style="margin-top:6px">Summe Gewichte: 100 %</div>
            <div class="field-error" data-validation-for="weights"></div>

            <div class="hr"></div>

            <div class="actions"><span class="tag">Person aus Liste w√§hlen oder frei eintippen ¬∑ 0‚Äì100 je Kategorie</span><button class="btn" id="btnAddRow">+ Zeile</button></div>
            <div class="field-error" data-validation-for="rows"></div>

            <datalist id="peopleList"></datalist>

            <div class="table-wrapper">
              <table>
                <thead><tr>
                  <th style="width:25%">Person</th>
                  <th style="width:15%">Consultative Selling</th>
                  <th style="width:15%">Konzepterstellung</th>
                  <th style="width:15%">Pitch</th>
                  <th style="width:20%">Live-Anteil</th>
                  <th style="width:10%">Aktion</th>
                </tr></thead>
                <tbody id="tbody"></tbody>
              </table>
            </div>

            <div class="sumchips" id="sumchips"></div>
            <div class="field-error" data-validation-for="categories"></div>

            <div class="hr"></div>

            <div class="form-bottom-actions">
              <div class="meta-edit-section" id="metaEditSection">
                <div class="meta-edit-header">
                  <div class="meta-edit-title">
                    <span class="meta-edit-eyebrow">Diese Felder sind auszuf√ºllen von Corporate Functions.</span>
                    <h3>Projektnummer, KV-Nummer &amp; Abschlussdatum</h3>
                  </div>
                  <button class="btn hide" id="btnMetaEditToggle" type="button">Bearbeiten</button>
                </div>
                <div class="meta-edit-summary" id="metaSummary">
                  <div class="meta-summary-row">
                    <span class="meta-summary-label">Projektnummer</span>
                    <span class="meta-summary-value" data-meta-field="projectNumber">‚Äì</span>
                  </div>
                  <div class="meta-summary-row">
                    <span class="meta-summary-label">KV-Nummer</span>
                    <span class="meta-summary-value" data-meta-field="kvNummer">‚Äì</span>
                  </div>
                  <div class="meta-summary-row">
                    <span class="meta-summary-label">Abschlussdatum</span>
                    <span class="meta-summary-value" data-meta-field="freigabedatum">‚Äì</span>
                  </div>
                </div>
                <div class="meta-edit-fields">
                  <div class="meta-field">
                    <label for="projectNumber">Projektnummer</label>
                    <input id="projectNumber" type="text" placeholder="Projektnummer eintragen">
                    <div class="field-error" data-validation-for="projectNumber"></div>
                  </div>
                  <div class="meta-field">
                    <label for="kvNummer">KV-Nummer</label>
                    <input id="kvNummer" type="text" placeholder="KV-Nummer eintragen">
                    <div class="field-error" data-validation-for="kvNummer"></div>
                  </div>
                  <div class="meta-field">
                    <label for="freigabedatum">Abschlussdatum</label>
                    <input id="freigabedatum" type="date">
                    <div class="field-error" data-validation-for="freigabedatum"></div>
                  </div>
                </div>
              </div>
              <div class="form-bottom-buttons">
                <button class="btn primary disabled" id="btnSave">Speichern</button>
              </div>
            </div>
          </div>
        </div>
      </dialog>
    </div>
  </div>

  <div class="card hide" id="viewFixauftraege">
    <div class="hd">
        <h1>Fixauftr√§ge</h1>
        <div id="fixSumDisplay" class="sum-display">üí∞ Lade Summe...</div>
        <p>Suche, Filter & Sortierung. Export .xlsx der gefilterten Ansicht.</p>
    </div>
    <div class="ct">
      <div class="search-wrapper">
        <input id="omniSearch" type="text" placeholder="Suchen... (z.B. 'DRV Bund status:vollst√§ndig quelle:hubspot wert:>50000')">
        <div class="filter-group">
          <label for="personFilter">Einsch√§tzung abgegeben oder abzugeben von:</label>
          <select id="personFilter">
            <option value="">Alle Personen</option>
          </select>
        </div>
        <div class="batch-actions">
            <button class="btn" id="btnXlsx" style="white-space:nowrap;">Export XLSX</button>
            <button class="btn warn hide" id="btnMoveToFramework">Zuweisen...</button>
            <button class="btn hide" id="btnMergeFixEntries">Auftr√§ge zusammenf√ºhren</button>
            <button class="btn danger hide" id="btnBatchDelete">Markierte L√∂schen</button>
        </div>
      </div>

      <div id="mergeSuggestions" class="merge-suggestions hide"></div>

      <div class="table-wrapper">
        <table>
          <thead><tr>
            <th class="col-check"><input type="checkbox" id="checkAllFix" title="Alle ausw√§hlen"></th>
            <th class="sortable" data-sort="projectNumber">Projektnummer<span class="sort-icon"></span></th>
            <th class="sortable" data-sort="title">Projekttitel<span class="sort-icon"></span></th>
            <th class="sortable" data-sort="client">Auftraggeber<span class="sort-icon"></span></th>
            <th class="sortable" data-sort="source">Quelle<span class="sort-icon"></span></th>
            <th class="sortable" data-sort="submittedBy">Einsch√§tzung abgegeben von<span class="sort-icon"></span></th>
            <th class="sortable col-amount" data-sort="amount">Wert EUR<span class="sort-icon"></span></th>
            <th class="sortable col-date" data-sort="freigabedatum">Abschluss<span class="sort-icon"></span></th>
            <th style="width:10%">Aktionen</th>
          </tr></thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div class="card hide" id="viewRahmen">
    <div class="hd">
        <h1>Rahmenvertr√§ge</h1>
        <div id="rahmenSumDisplay" class="sum-display">üí∞ Lade Summe...</div>
        <p>Werte von dynamischen Rahmenvertr√§gen aktualisieren und neue Abrufe erfassen.</p>
    </div>
    <div class="ct">
      <div class="search-wrapper">
        <input id="rahmenSearch" type="text" placeholder="Suchen nach Titel, Kunde, Person oder Hunter-Auftrag...">
      </div>
       <div class="table-wrapper">
        <table>
          <thead><tr>
            <th style="width:15%">Projektnummer</th>
            <th style="width:30%">Projekttitel</th>
            <th style="width:20%">Kunde</th>
            <th style="width:15%">Gesamtwert</th>
            <th style="width:20%">Aktionen</th>
          </tr></thead>
          <tbody id="rahmenBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div class="card hide" id="viewRahmenDetails">
    <div class="hd"><h1 id="rahmenDetailsTitle"></h1><p id="rahmenDetailsSub"></p></div>
    <div class="ct">
      <button class="btn" id="backToRahmen" style="margin-bottom: 16px;">‚Üê Zur√ºck zur √úbersicht</button>
      
      <div class="grid-2">
        <div>
          <h3>Gr√ºnder-Team (initiale Verteilung)</h3>
          <div class="table-wrapper">
            <table style="min-width:auto;">
              <thead><tr><th>Person</th><th>Anteil</th></tr></thead>
              <tbody id="rahmenFoundersBody"></tbody>
            </table>
          </div>
        </div>
        <div>
          <h3>Tats√§chliche Gesamtverteilung</h3>
          <div class="table-wrapper">
            <table style="min-width:auto;">
              <thead><tr><th>Person</th><th>Anteil</th><th>Wert</th></tr></thead>
              <tbody id="rahmenActualBody"></tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div class="hr"></div>
      <h3>Transaktions-Historie (zum Bearbeiten klicken)</h3>
       <div class="table-wrapper">
        <table style="min-width:auto;">
          <thead><tr><th>KV-Nummer</th><th>Typ</th><th>Titel</th><th>Wert</th><th>Abschluss</th><th>Aktionen</th></tr></thead>
          <tbody id="rahmenTransaktionenBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card hide" id="viewAdmin">
    <div class="hd"><h1>Admin</h1><p>Verwaltung von Personen, Teams und Datenimport.</p></div>
    <div class="ct">
      <h3>Personen & Teams</h3>
      <div class="search-wrapper">
        <input id="adminSearch" type="text" placeholder="Person oder Team suchen...">
      </div>
      <div class="grid-admin">
        <div><label for="adm_name">Vor- und Nachname</label><input id="adm_name" type="text" placeholder="z. B. Max Mustermann"></div>
        <div><label for="adm_team">Team</label>
          <select id="adm_team" data-placeholder="‚Äî bitte w√§hlen ‚Äî"></select>
        </div>
        <div style="display:flex;align-items:flex-end"><button class="btn ok" id="adm_add">Anlegen</button></div>
      </div>
      <div class="table-wrapper" style="margin-top:14px;">
        <table>
          <thead><tr><th style="width:44%">Name</th><th style="width:44%">Team</th><th style="width:12%">Aktionen</th></tr></thead>
          <tbody id="adm_body"></tbody>
        </table>
      </div>
      <div class="hr"></div>
      <h3>ERP-Abgleich per Excel-Import</h3>
      <p class="note" style="font-size: 14px; margin-bottom: 12px;">Laden Sie hier die Excel-Datei aus dem ERP-System hoch. Das System wird bestehende Abrufe (via KV-Nummer) aktualisieren, neue Abrufe zu bestehenden Rahmenvertr√§gen (via Projektnummer) hinzuf√ºgen oder neue Fixauftr√§ge anlegen.</p>
      <div class="search-wrapper">
        <input type="file" id="erpFile" accept=".xlsx, .xls, .csv" style="padding: 10px; flex-grow: 1;">
        <button class="btn primary" id="btnErpImport">Import & Abgleich starten</button>
      </div>
      <div id="importResult" class="info-box hide" style="margin-top: 14px;"></div>

      <div class="hr"></div>
      <h3>Import: dock (Altdaten)</h3>
      <p class="note" style="font-size: 14px; margin-bottom: 12px;">
        Nur f√ºr Altdaten: L√§dt eine Excel-Datei, die KV-Nummern und Team-Prozents√§tze (als Zahlen von 0-1) enth√§lt. 
        Die Funktion <strong>√ºberspringt KV-Nummern, die nicht gefunden werden</strong>, und erstellt <strong>keine</strong> neuen Auftr√§ge.
        Sie <strong>√ºberschreibt</strong> die Sales-Verteilung f√ºr alle gefundenen Eintr√§ge.
      </p>
      <div class="search-wrapper">
        <input type="file" id="legacySalesFile" accept=".xlsx, .xls, .csv" style="padding: 10px; flex-grow: 1;">
        <button class="btn warn" id="btnLegacySalesImport">Legacy-Sales-Import starten</button>
      </div>
      <div id="legacyImportResult" class="info-box hide" style="margin-top: 14px;"></div>
      </div>
  </div>

  <div class="card hide" id="viewAnalytics">
    <div class="hd"><h1>Auswertung</h1><p>Jahressummen, monet√§r. Basis: Fixauftr√§ge & Rahmenvertr√§ge.</p></div>
    <div class="ct">
      <div class="analytics-controls">
        <label>Jahr</label>
        <select id="anaYear" class="ipt"></select>
        <button class="btn" id="anaRefresh">Aktualisieren</button>
        <button class="btn" id="btnAnaXlsx">Export XLSX</button>
      </div>
      <div class="grid-3">
        <div class="chart" style="grid-column:1/-1">
          <h3>Top Personen (monet√§r)</h3>
          <div id="chartPersons"></div>
        </div>
        <div class="chart" style="grid-column:1/-1">
          <h3>Teams (monet√§r, aggregiert)</h3>
          <div id="chartTeams"></div>
        </div>
        <div class="chart" style="grid-column:1/-1">
          <h3>Gesamt√ºbersicht (monet√§r)</h3>
          <div id="chartTotals"></div>
        </div>
      </div>
      
      <div class="hr"></div>
      <h2>Aktivit√§t Rahmenvertr√§ge</h2>
      <div class="analytics-controls">
        <label for="anaStartDate">Von</label>
        <input type="date" id="anaStartDate">
        <label for="anaEndDate">Bis</label>
        <input type="date" id="anaEndDate">
        <button class="btn" id="btnAnaThisYear">Dieses Jahr</button>
        <button class="btn" id="btnAnaLastYear">Letztes Jahr</button>
        <button class="btn primary" id="btnAnaRangeRefresh">Laden</button>
      </div>
      <div class="grid-3">
         <div class="chart" style="grid-column:1/-1">
          <h3 id="chartActivityTitle">Rahmenvertragsnutzung und Hunter/Founder-Anteile</h3>
          <div id="chartActivity"></div>
        </div>
      </div>

      <div class="hr"></div>
      <h2>Umsatz- & Deal-Trends</h2>
      <div class="analytics-controls">
        <label for="trendFromMonth">Von</label>
        <input type="month" id="trendFromMonth">
        <label for="trendToMonth">Bis</label>
        <input type="month" id="trendToMonth">
        <button class="btn" id="btnTrendThisYear">Dieses Jahr</button>
        <button class="btn" id="btnTrendLast12">Letzte 12 Monate</button>
        <button class="btn primary" id="btnTrendLoad">Aktualisieren</button>
        <button class="btn" id="btnTrendCsv">Export CSV</button>
        <button class="btn" id="btnTrendXlsx">Export XLSX</button>
      </div>
      <div id="trendSummary" class="metrics-grid"></div>
      <div class="grid-3">
        <div class="chart" style="grid-column:1/-1">
          <h3>Monatlicher Umsatz</h3>
          <div id="trendRevenueChart" class="chart-canvas"></div>
        </div>
        <div class="chart" style="grid-column:1/-1">
          <h3>Kumulierte Jahresleistung</h3>
          <div id="trendCumulativeChart" class="chart-canvas"></div>
        </div>
      </div>

    </div>
  </div>

</div>

<dialog id="confirmDlg">
  <button class="dialog-close" type="button" aria-label="Modal schlie√üen">√ó</button>
  <div class="hd" style="padding:16px;border-bottom:1px solid var(--border)"><strong><span id="confirmDlgTitle">Eintrag l√∂schen</span></strong></div>
  <div class="ct" style="padding:16px">
    <p id="confirmDlgText">Wollen Sie den Eintrag wirklich l√∂schen?</p>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn" id="btnNo">Abbrechen</button>
      <button class="btn danger" id="btnYes">L√∂schen</button>
    </div>
  </div>
</dialog>

<dialog id="moveToFrameworkDlg" style="min-width: 500px;">
    <button class="dialog-close" type="button" aria-label="Modal schlie√üen" onclick="this.closest('dialog').close()">√ó</button>
    <div class="hd">
        <h1>Auftr√§ge zuweisen</h1>
    </div>
    <div class="ct">
        <div id="moveValidationSummary" class="validation-summary"></div>
        <p id="moveDlgCountLabel"></p>
        <div>
            <label for="moveTargetFramework">Ziel-Rahmenvertrag *</label>
            <select id="moveTargetFramework">
                <option value="">-- Bitte Rahmenvertrag w√§hlen --</option>
            </select>
        </div>
        <div style="margin-top: 16px;">
            <label>Abruf-Typ *</label>
            <div class="radio-group">
                <label><input type="radio" name="moveType" value="founder" checked> Passiver Abruf (Founder)</label>
                <label><input type="radio" name="moveType" value="hunter"> Aktiver Abruf (Hunter)</label>
            </div>
            <p class="note small" style="margin-top: 10px;">
                <b>Passiv (Founder):</b> Nur Betrag & KV-Nr. werden √ºbernommen. Die Sales-Verteilung des Fixauftrags wird verworfen und stattdessen die Founder-Verteilung des Rahmenvertrags angewendet.
                <br><br>
                <b>Aktiv (Hunter):</b> Der komplette Eintrag inkl. Sales-Verteilung wird 1:1 als "Hunter"-Abruf √ºbernommen. Dies geht nur, wenn der Fixauftrag vollst√§ndig (Status "ok") ist.
            </p>
        </div>
        <div class="hr"></div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button class="btn" onclick="document.getElementById('moveToFrameworkDlg').close()">Abbrechen</button>
            <button class="btn ok" id="btnConfirmMove">Zuweisen</button>
        </div>
    </div>
</dialog>

<dialog id="mergeFixDlg" style="min-width: 720px;">
    <button class="dialog-close" type="button" aria-label="Modal schlie√üen" onclick="this.closest('dialog').close()">√ó</button>
    <div class="hd">
        <h1>Auftr√§ge zusammenf√ºhren</h1>
    </div>
    <div class="ct">
        <div id="mergeFixValidation" class="validation-summary"></div>
        <p id="mergeFixProjectNumber" class="note"></p>
        <div class="table-wrapper" style="margin-bottom: 16px;">
            <table style="min-width:auto;">
                <thead><tr><th>ID</th><th>Titel</th><th>Auftraggeber</th><th>Projektnummer</th><th>Wert</th></tr></thead>
                <tbody id="mergeFixSelectionBody"></tbody>
            </table>
        </div>
        <div id="mergeFixPreview" class="hide">
            <div class="sum-display">üí∞ Zusammengef√ºhrter Wert: <span id="mergeFixTotal"></span></div>
            <p class="note">Anteile nach Zusammenf√ºhrung:</p>
            <div class="table-wrapper">
                <table style="min-width:auto;">
                    <thead><tr><th>Person</th><th>Anteil %</th><th>Betrag</th></tr></thead>
                    <tbody id="mergeFixListBody"></tbody>
                </table>
            </div>
        </div>
        <div class="hr"></div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button class="btn" id="btnMergeFixCancel">Abbrechen</button>
            <button class="btn ok" id="btnMergeFixConfirm">Zusammenf√ºhren</button>
        </div>
    </div>
</dialog>

<dialog id="editTransactionDlg" style="min-width: 800px;">
    <button class="dialog-close" type="button" aria-label="Modal schlie√üen" onclick="this.closest('dialog').close()">√ó</button>
    <div class="hd">
        <h1 id="editTransDlgTitle">Abruf bearbeiten</h1>
    </div>
    <div class="ct">
        <div id="editTransValidationSummary" class="validation-summary"></div>
        <div id="editFounderTransView">
            <div class="grid-2">
                <div>
                    <label for="editFounderValueInput">Wert (EUR)</label>
                    <input type="text" id="editFounderValueInput" inputmode="decimal">
                </div>
                 <div>
                    <label for="editFounderKvNummer">KV-Nummer</label>
                    <input type="text" id="editFounderKvNummer">
                </div>
            </div>
             <div style="margin-top: 10px;">
                <label for="editFounderFreigabedatum">Abschlussdatum</label>
                <input type="date" id="editFounderFreigabedatum">
            </div>
        </div>

        <div id="editHunterTransView" class="hide">
             <div class="grid-3">
                <div><label for="editHunterTitle">Titel</label><input type="text" id="editHunterTitle"></div>
                <div><label for="editHunterAmount">Wert (EUR)</label><input type="text" id="editHunterAmount" inputmode="decimal"></div>
                <div><label for="editHunterKvNummer">KV-Nummer</label><input type="text" id="editHunterKvNummer"></div>
            </div>
            <div style="margin-top: 10px;">
                <label for="editHunterFreigabedatum">Abschlussdatum</label>
                <input type="date" id="editHunterFreigabedatum">
            </div>
            <div class="hr"></div>
            <div class="grid-3">
                <div><label>Gewicht: CS (%)</label><input type="number" id="editW_cs" value="50"></div>
                <div><label>Gewicht: Konzept (%)</label><input type="number" id="editW_konzept" value="30"></div>
                <div><label>Gewicht: Pitch (%)</label><input type="number" id="editW_pitch" value="20"></div>
            </div>
             <div class="hr"></div>
            <div class="actions"><span class="tag">Personen & Verteilung</span><button class="btn" id="editBtnAddRow" style="width:auto;">+ Zeile</button></div>
            <div class="table-wrapper" style="margin-top:14px">
                <table style="min-width:auto;">
                    <thead><tr><th>Person</th><th>CS</th><th>Konzept</th><th>Pitch</th><th>Aktion</th></tr></thead>
                    <tbody id="editTbody"></tbody>
                </table>
            </div>
        </div>
        
        <div class="hr"></div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button class="btn" onclick="document.getElementById('editTransactionDlg').close()">Abbrechen</button>
            <button class="btn ok" id="btnSaveTransaction">Speichern</button>
        </div>
    </div>
</dialog>

<dialog id="editFrameworkContractDlg" style="min-width: 800px;">
    <button class="dialog-close" type="button" aria-label="Modal schlie√üen" onclick="this.closest('dialog').close()">√ó</button>
    <div class="hd">
        <h1>Rahmenvertrag bearbeiten</h1>
    </div>
    <div class="ct">
        <div id="editFwValidationSummary" class="validation-summary"></div>
        <div class="grid-3">
            <div><label for="editFwClient">Auftraggeber</label><input type="text" id="editFwClient"></div>
            <div><label for="editFwTitle">Projekttitel</label><input type="text" id="editFwTitle"></div>
            <div><label for="editFwProjectNumber">Projektnummer</label><input type="text" id="editFwProjectNumber"></div>
        </div>
        <div class="hr"></div>
        <div class="grid-3">
            <div><label>Gewicht: CS (%)</label><input type="number" id="editFwW_cs" value="50"></div>
            <div><label>Gewicht: Konzept (%)</label><input type="number" id="editFwW_konzept" value="30"></div>
            <div><label>Gewicht: Pitch (%)</label><input type="number" id="editFwW_pitch" value="20"></div>
        </div>
        <div class="hr"></div>
        <div class="actions"><span class="tag">Gr√ºnder-Team & initiale Verteilung</span><button class="btn" id="editFwBtnAddRow" style="width:auto;">+ Zeile</button></div>
        <div class="table-wrapper" style="margin-top:14px">
            <table style="min-width:auto;">
                <thead><tr><th>Person</th><th>CS</th><th>Konzept</th><th>Pitch</th><th>Aktion</th></tr></thead>
                <tbody id="editFwTbody"></tbody>
            </table>
        </div>
        <div class="hr"></div>
        <div style="display:flex;gap:10px;justify-content:flex-end;">
            <button class="btn" onclick="document.getElementById('editFrameworkContractDlg').close()">Abbrechen</button>
            <button class="btn ok" id="btnSaveFrameworkContract">Speichern</button>
        </div>
    </div>
</dialog>

<script type="module" src="public/js/app.js"></script>

<!-- LOGBOOK v2 Dialog (admin-only access via dedicated button) -->
<dialog id="logbookDlgV2">
  <button class="dialog-close" type="button" aria-label="Modal schlie√üen" onclick="this.closest('dialog').close()">√ó</button>
  <div class="hd" style="display:flex;align-items:center;justify-content:space-between">
    <h1 style="margin:0;font-size:18px;">Logbuch</h1>
  </div>
  <div id="logbookV2" class="ct">
    <div class="controls">
      <input type="text" id="logSearchV2" placeholder="Suchen (KV, Projektnummer, Titel, Kunde, Grund, ID)‚Ä¶" style="flex:1">
      <label>Von <input type="date" id="logFromV2"></label>
      <label>Bis <input type="date" id="logToV2"></label>
      <select id="logEventFilterV2">
        <option value="">Alle Ereignisse</option>
        <option value="create">Neu angelegt</option>
        <option value="update">Aktualisiert</option>
        <option value="delete">Gel√∂scht</option>
        <option value="skip">√úbersprungen</option>
      </select>
      <select id="logSourceFilterV2">
        <option value="">Alle Quellen</option>
        <option value="erp">ERP</option>
        <option value="legacy_sales">Legacy</option>
        <option value="manuell">Manuell</option>
        <option value="hubspot">HubSpot</option>
      </select>
      <button class="btn" id="btnLogRefreshV2">Aktualisieren</button>
      <button class="btn" id="btnLogExportTxtV2">Export .txt</button>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th style="width:140px;">Zeit</th>
            <th style="width:110px;">Ereignis</th>
            <th style="width:120px;">KV</th>
            <th style="width:150px;">Projektnummer</th>
            <th style="width:260px;">Titel</th>
            <th style="width:180px;">Kunde</th>
            <th style="width:110px;">Œî Betrag</th>
            <th>Grund / Details</th>
          </tr>
        </thead>
        <tbody id="logbookBodyV2"></tbody>
      </table>
    </div>
  </div>
</dialog>



<script type="module" src="public/js/logbook-interceptor.js"></script>
<script src="public/js/erp-preview-override.js"></script>
</body>
</html>
