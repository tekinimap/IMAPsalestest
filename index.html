<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sales-Beteiligung</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root{
    --bg:#0a0f16; --panel:#0f1724; --panel2:#0c1320; --text:#e6ebf3; --muted:#94a3b8; --border:#213044;
    --accent:#3b82f6; --ok:#22c55e; --bad:#ef4444; --warn:#f59e0b; --radius:14px;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:15px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial}
  .container{max-width:1200px;margin:28px auto;padding:0 16px}
  
  .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px; flex-wrap: wrap; gap: 14px;}
  .main-nav{display:flex;gap:10px; flex-wrap: wrap;}
  .nav-link{font-size:14px;font-weight:600;color:#cbd5e1;padding:8px 14px;border:1px solid var(--border);border-radius:999px;background:#0b1326;cursor:pointer; text-decoration: none;}
  .nav-link:hover{background-color: var(--panel2);}
  .nav-link.active{background:var(--accent); color: var(--text); border-color: var(--accent);}
  .nav-link.disabled{opacity:.45;cursor:not-allowed;filter:grayscale(35%)}

  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 12px 32px rgba(0,0,0,.35);overflow:hidden;margin-bottom:18px}
  .hd{padding:20px 22px 8px}.hd h1{margin:0 0 8px;font-size:24px}.hd p{margin:0;color:var(--muted);font-size:14px}
  .ct{padding:20px 22px 24px}

  .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px}
  label{display:block;font-weight:600;margin:8px 0 6px}
  input[type="text"],input[type="number"],select{
    width:100%;background:var(--panel2);color:var(--text);border:1px solid var(--border);
    border-radius:10px;padding:12px;outline:none; font-size:15px;
  }
  input:disabled { background-color: #0a0f16; opacity: 0.6; }
  input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.35)}
  .note{color:var(--muted);font-size:13px; margin-top: 8px;}
  .info-box{background: var(--panel2); border: 1px solid var(--border); padding: 12px; border-radius: 10px; font-size: 13px; color: var(--muted); margin-bottom: 16px;}
  .actions{display:flex;gap:12px;flex-wrap:wrap;justify-content:space-between;align-items:center}
  .btn{appearance:none;border:1px solid var(--border);background:#0d1426;color:var(--text);padding:10px 16px;border-radius:12px;cursor:pointer;font-weight:600; font-size:15px;}
  .btn.primary{background:var(--accent);border-color:transparent}
  .btn.disabled{opacity:.5;pointer-events:none}
  .btn.ok{background:var(--ok);border-color:transparent}
  .btn.danger{background:var(--bad);border-color:transparent}
  .tag{background:#0c162b;border:1px solid var(--border);color:var(--muted);padding:8px 12px;border-radius:999px;font-size:13px}
  
  .radio-group {display:flex; gap:12px; margin-top: 8px;}
  .radio-group label {display:flex; align-items:center; gap:6px; font-weight:normal; font-size:14px;}

  .table-wrapper{width:100%;border:1px solid var(--border);border-radius:12px;overflow-x:auto;background:#0b1120}
  table{width:100%;min-width:980px;border-collapse:collapse}
  thead th{position:sticky;top:0;background:#0d162a;border-bottom:1px solid var(--border);padding:12px;text-align:left;font-size:13px}
  tbody td{border-top:1px solid var(--border);padding:10px 12px; vertical-align: middle;}
  tbody tr:hover{background:#0c1426}
  .delrow{background:#13203b;border:1px solid #21314f;color:#cbd5e1;border-radius:8px;padding:6px 8px;cursor:pointer}

  .sumchips{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
  .chip{background:#0b1220;border:1px solid var(--border);border-radius:999px;padding:8px 12px;font-size:12px;display:inline-flex;align-items:center;gap:8px}
  .chip .dot{width:8px;height:8px;border-radius:50%}
  .chip.ok .dot{background:var(--ok)} .chip.bad .dot{background:var(--bad)} .chip.warn .dot{background:var(--warn)}
  
  .live-result{font-size:13px; font-weight: 600; color: var(--muted);}
  .live-result .pct{color: var(--text); display: block; font-size: 15px;}
  .live-result .money{font-size: 12px;}

  .hr{height:1px;background:var(--border);margin:24px 0}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .small{font-size:12px}
  .hide{display:none !important}
  
  .search-wrapper{display:flex; gap:10px; margin-bottom:12px;}
  .search-wrapper input {width:100%;}

  .status{display:inline-block;padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700}
  .status.ok{background:rgba(34,197,94,.18);border:1px solid rgba(34,197,94,.4);color:#86efac}
  .status.bad{background:rgba(239,68,68,.18);border:1px solid rgba(239,68,68,.4);color:#fecaca}
  
  th.sortable{cursor:pointer;}
  th.sortable:hover{background-color: var(--panel2);}
  th .sort-icon{display:inline-block; width:1em; opacity:0.5;}
  
  .field-error {color:var(--bad); font-size:13px; font-weight:600; padding-top:4px; min-height:1.2em;}
  input.invalid-field, select.invalid-field {border-color:var(--bad) !important; box-shadow:0 0 0 3px rgba(239, 68, 68, .25) !important;}
  .checkbox-wrapper{display:flex; align-items:center; gap:8px; margin-top: 8px;}

  .iconbtn{appearance:none;border:1px solid var(--border);background:#0c1320;color:var(--text);width:36px;height:36px;border-radius:10px;display:inline-grid;place-items:center;cursor:pointer}
  .iconbtn:hover{background:var(--panel2);}
  .iconbtn[data-act="del"] svg{stroke-width:1.5;fill:rgba(239,68,68,.8)}
  .iconbtn[data-act="edit"] svg{stroke-width:1.5}
  
  .explanation details {border:1px solid var(--border); border-radius:12px; margin-bottom:16px; background:var(--panel2);}
  .explanation summary {padding:12px; font-weight:700; cursor:pointer;}
  .explanation .content {padding:0 12px 12px; font-size:14px; line-height:1.5;}
  .explanation .content p {margin:0 0 10px;}
  .explanation .content h4 {margin:12px 0 4px; color:var(--text);}


  .chart{background:#0c1324;border:1px solid var(--border);border-radius:12px;padding:14px}
  .chart h3{margin:0 0 10px 0;font-size:15px;color:#cbd5e1}
  .chart svg{width:100%;height:auto}
  
  /* --- Feedback & Loader --- */
  .toast{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--panel2);color:var(--text);padding:12px 20px;border-radius:10px;border:1px solid var(--border);box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:9999;opacity:0;transition:opacity .3s, bottom .3s;font-weight:600;}
  .toast.show{opacity:1;bottom:30px;}
  .toast.ok{background:var(--ok);border-color:transparent;}
  .toast.bad{background:var(--bad);border-color:transparent;}
  .loader{position:fixed;top:20px;right:20px;width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;z-index:10000;}
  @keyframes spin{to{transform:rotate(360deg)}}
  
  dialog {border:1px solid var(--border); background: var(--panel); color:var(--text); border-radius: var(--radius);}
  dialog::backdrop {background:rgba(0,0,0,.5);}

  /* --- Responsive Design --- */
  @media(max-width: 768px){
    .container{margin:16px auto; padding:0 12px;}
    .hd{padding:16px 18px 4px} .hd h1{font-size:20px} .hd p{font-size:13px}
    .ct{padding:16px 18px 20px}
    .grid-3{grid-template-columns:1fr;}
    .topbar{flex-direction:column; gap:10px; align-items:flex-start;}
    .main-nav {width: 100%; justify-content: space-around;}
    .actions{flex-direction:column; align-items:stretch; gap:12px;}
    .btn{width:100%; text-align:center;}
    .form-bottom-actions{justify-content:center !important;}
  }
  @media(max-width: 980px){
    table{min-width: 800px;}
  }

</style>
</head>
<body>

<div id="loader" class="loader hide"></div>
<div id="toast" class="toast"></div>

<div class="container">

  <div class="topbar">
    <div style="font-weight:700; font-size: 18px;">Sales-Beteiligung</div>
    <div class="main-nav">
      <a href="#" class="nav-link active" data-view="erfassung">Erfassung</a>
      <a href="#" class="nav-link" data-view="fixauftraege">Fixaufträge</a>
      <a href="#" class="nav-link" data-view="rahmen">Rahmenverträge</a>
      <a href="#" class="nav-link" data-view="analytics">Auswertung</a>
      <a href="#" class="nav-link" data-view="admin">Admin</a>
    </div>
  </div>

  <div class="card" id="viewErfassung">
    <div class="hd"><h1>Erfassung</h1><p id="erfassungSub">Neuen Auftrag oder Rahmenvertrag anlegen.</p></div>
    <div class="ct">
      <div id="abrufInfo" class="info-box hide"></div>
      <div class="grid-3">
        <div>
          <label for="auftraggeber">Auftraggeber *</label>
          <input id="auftraggeber" type="text" autocomplete="organization">
          <div class="field-error" data-validation-for="auftraggeber"></div>
        </div>
        <div>
          <label for="projekttitel">Projekttitel *</label>
          <input id="projekttitel" type="text">
          <div class="field-error" data-validation-for="projekttitel"></div>
        </div>
        <div>
          <label for="auftragswert">Auftragswert *</label>
          <input id="auftragswert" type="text" inputmode="decimal" placeholder="z. B. 120.000,00">
          <div class="checkbox-wrapper">
            <input type="checkbox" id="auftragswertBekannt" checked>
            <label for="auftragswertBekannt" style="margin:0; font-weight:normal; font-size:13px;">Auftragswert bekannt?</label>
          </div>
          <div class="field-error" data-validation-for="auftragswert"></div>
        </div>
      </div>
      <div class="grid-3" style="margin-top:10px">
        <div>
          <label for="submittedBy">Einschätzung abgegeben von *</label>
          <input id="submittedBy" list="peopleList" placeholder="Namen eintippen oder auswählen...">
          <div class="field-error" data-validation-for="submittedBy"></div>
        </div>
        <div id="projectTypeWrapper">
          <label>Projekttyp *</label>
          <div class="radio-group">
            <label><input type="radio" name="projectType" value="fix" checked> Fixauftrag</label>
            <label><input type="radio" name="projectType" value="rahmen"> Rahmenvertrag</label>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid-3">
        <div>
          <label>Gewicht: Consultative Selling (%)</label>
          <input id="w_cs" type="number" min="0" max="100" step="1" value="50">
        </div>
        <div>
          <label>Gewicht: Konzepterstellung (%)</label>
          <input id="w_konzept" type="number" min="0" max="100" step="1" value="30">
        </div>
        <div>
          <label>Gewicht: Pitch (%)</label>
          <input id="w_pitch" type="number" min="0" max="100" step="1" value="20">
        </div>
      </div>
      <div class="note mono" id="w_note" style="margin-top:6px">Summe Gewichte: 100 %</div>
      <div class="field-error" data-validation-for="weights"></div>

      <div class="hr"></div>

      <div class="actions"><span class="tag">Person aus Liste wählen oder frei eintippen · 0–100 je Kategorie</span><button class="btn" id="btnAddRow" style="width:auto;">+ Zeile</button></div>
      <div class="field-error" data-validation-for="rows"></div>

      <datalist id="peopleList"></datalist>

      <div class="table-wrapper" style="margin-top:14px">
        <table>
          <thead><tr>
            <th style="width:25%">Person</th>
            <th style="width:15%">Consultative Selling</th>
            <th style="width:15%">Konzepterstellung</th>
            <th style="width:15%">Pitch</th>
            <th style="width:20%">Live-Anteil</th>
            <th style="width:10%">Aktion</th>
          </tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="sumchips" id="sumchips"></div>
      <div class="field-error" data-validation-for="categories"></div>

      <div class="hr"></div>

      <div class="form-bottom-actions" style="display:flex; justify-content:space-between; align-items:flex-end; gap:20px; flex-wrap: wrap;">
        <div style="flex-grow: 0; min-width: auto;">
          <label for="projectNumber" style="font-weight:500; font-size:13px; color: var(--muted);">Projektnummer</label>
          <input id="projectNumber" type="text" disabled placeholder="Wird später eingetragen" aria-label="Projektnummer, auszufüllen von Corporate Functions" style="padding: 8px 12px; width: 200px;">
        </div>
        <div style="display:flex;gap:10px; flex-grow: 1; justify-content: flex-end;">
          <button class="btn primary disabled" id="btnSave">Speichern</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card hide" id="viewFixauftraege">
    <div class="hd"><h1>Fixaufträge</h1><p>Suche, Filter & Sortierung. Export .xlsx der gefilterten Ansicht.</p></div>
    <div class="ct">
      <div class="search-wrapper">
        <input id="omniSearch" type="text" placeholder="Suchen... (z.B. 'DRV Bund status:vollständig quelle:hubspot wert:>50000')">
        <button class="btn" id="btnXlsx" style="white-space:nowrap;">Export XLSX</button>
      </div>

      <div class="table-wrapper">
        <table>
          <thead><tr>
            <th class="sortable" data-sort="title">Projekttitel<span class="sort-icon"></span></th>
            <th class="sortable" data-sort="client">Auftraggeber<span class="sort-icon"></span></th>
            <th class="sortable" data-sort="source">Quelle<span class="sort-icon"></span></th>
            <th style="width:14%">Status</th>
            <th class="sortable" data-sort="amount">Wert EUR<span class="sort-icon"></span></th>
            <th class="sortable" data-sort="ts">Zuletzt bearbeitet<span class="sort-icon"></span></th>
            <th style="width:10%">Aktionen</th>
          </tr></thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div class="card hide" id="viewRahmen">
    <div class="hd"><h1>Rahmenverträge</h1><p>Werte von dynamischen Rahmenverträgen aktualisieren und neue Abrufe erfassen.</p></div>
    <div class="ct">
       <div class="explanation">
         <details>
           <summary>Das Founder & Hunter Modell</summary>
           <div class="content">
             <p>Rahmenverträge sind dynamisch. Um sowohl den Gewinn des ursprünglichen Vertrags als auch die Akquise neuer Aufträge innerhalb dieses Vertrags fair zu belohnen, nutzen wir das Zwei-Säulen-Modell "Founder & Hunter".</p>
             <h4>Die Rollen</h4>
             <p><b>Founder (Gründer):</b> Das Team, das die strategische Vorarbeit leistet und den ursprünglichen Rahmenvertrag gewinnt.<br>
             <b>Hunter (Jäger):</b> Das Team oder die Person, die aktiv einen neuen, konkreten Auftrag (Abruf) aus einem bestehenden Rahmenvertrag generiert.</p>
             <h4>Zwei Arten von Umsätzen & ihre Verteilung</h4>
             <p><b>1. Passiver Abruf ("Founder +"):</b> Der Kunde kommt von sich aus auf uns zu. 100% dieses neuen Auftragswertes werden dem ursprünglichen Founder-Team zugerechnet.</p>
             <p><b>2. Aktiver Abruf ("Hunter +"):</b> Ein Mitarbeiter leistet aktive Vertriebsarbeit. Der Auftragswert wird gesplittet: 20% gehen als "Grund-Provision" an das Founder-Team. Die restlichen 80% bilden die neue 100%-Basis für das Hunter-Team.</p>
           </div>
         </details>
       </div>
       <div class="table-wrapper">
        <table>
          <thead><tr>
            <th style="width:15%">Projektnummer</th>
            <th style="width:25%">Projekttitel</th>
            <th style="width:20%">Kunde</th>
            <th style="width:15%">Gesamtwert</th>
            <th style="width:25%">Aktionen</th>
          </tr></thead>
          <tbody id="rahmenBody"></tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div class="card hide" id="viewRahmenDetails">
    <div class="hd"><h1 id="rahmenDetailsTitle"></h1><p id="rahmenDetailsSub"></p></div>
    <div class="ct">
      <button class="btn" id="backToRahmen" style="margin-bottom: 16px;">← Zurück zur Übersicht</button>
      <h3>Gründer-Team (initiale Verteilung)</h3>
      <div class="table-wrapper">
        <table style="min-width:auto;">
          <thead><tr><th>Person</th><th>Anteil</th></tr></thead>
          <tbody id="rahmenFoundersBody"></tbody>
        </table>
      </div>
      <div class="hr"></div>
      <h3>Transaktions-Historie</h3>
       <div class="table-wrapper">
        <table style="min-width:auto;">
          <thead><tr><th>Datum</th><th>Typ</th><th>Titel/Notiz</th><th>Wert</th><th>Aktionen</th></tr></thead>
          <tbody id="rahmenTransaktionenBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card hide" id="viewAdmin">
    <div class="hd"><h1>Admin: Personen & Teams</h1><p>Anlegen, Bearbeiten, Löschen.</p></div>
    <div class="ct">
      <div class="search-wrapper">
        <input id="adminSearch" type="text" placeholder="Person oder Team suchen...">
      </div>
      <div class="hr"></div>
      <div class="grid-3">
        <div><label for="adm_name">Vor- und Nachname</label><input id="adm_name" type="text" placeholder="z. B. Max Mustermann"></div>
        <div><label for="adm_team">Team</label>
          <select id="adm_team">
            <option value="">— bitte wählen —</option>
            <option>Vielfalt+</option>
            <option>Evaluation und Beteiligung</option>
            <option>Nachhaltigkeit</option>
            <option>Sozial- und Krankenversicherungen</option>
            <option>ChangePartner</option>
            <option>Bundes- und Landesbehörden</option>
            <option>Kommunalverwaltungen</option>
            <option>Internationale Zusammenarbeit</option>
            <option>Head of Organisational Excellence</option>
            <option>Head of Public Impact</option>
          </select>
        </div>
        <div style="display:flex;align-items:flex-end"><button class="btn ok" id="adm_add">Anlegen</button></div>
      </div>

      <div class="hr"></div>

      <div class="table-wrapper">
        <table>
          <thead><tr><th style="width:40%">Name</th><th style="width:40%">Team</th><th style="width:20%">Aktionen</th></tr></thead>
          <tbody id="adm_body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="card hide" id="viewAnalytics">
    <div class="hd"><h1>Auswertung</h1><p>Jahressummen, monetär. Basis: Fixaufträge & Rahmenverträge.</p></div>
    <div class="ct">
      <div style="display:flex;gap:10px;align-items:center;margin-bottom:8px; flex-wrap: wrap;">
        <label>Jahr</label>
        <select id="anaYear" class="ipt"></select>
        <button class="btn" id="anaRefresh">Aktualisieren</button>
        <button class="btn" id="btnAnaXlsx">Export XLSX</button>
      </div>
      <div class="grid-3">
        <div class="chart" style="grid-column:1/-1">
          <h3>Top Personen (monetär)</h3>
          <div id="chartPersons"></div>
        </div>
        <div class="chart" style="grid-column:1/-1">
          <h3>Teams (monetär, aggregiert)</h3>
          <div id="chartTeams"></div>
        </div>
      </div>
    </div>
  </div>

</div>

<dialog id="confirmDlg">
  <div class="hd" style="padding:16px;border-bottom:1px solid var(--border)"><strong id="confirmTitle">Eintrag löschen</strong></div>
  <div class="ct" style="padding:16px">
    <p id="confirmText">Wollen Sie den Eintrag wirklich löschen?</p>
    <div style="display:flex;gap:10px;justify-content:flex-end">
      <button class="btn" id="btnNo">Abbrechen</button>
      <button class="btn danger" id="btnYes">Löschen</button>
    </div>
  </div>
</dialog>

<dialog id="addFounderValueDlg">
  <div class="hd" style="padding:16px;border-bottom:1px solid var(--border)"><strong id="founderDlgTitle">Passiven Abruf hinzufügen</strong></div>
  <div class="ct" style="padding:16px">
    <label for="founderValueInput">Wert des Abrufs (EUR)</label>
    <input type="text" id="founderValueInput" inputmode="decimal">
    <div style="display:flex;gap:10px;justify-content:flex-end; margin-top: 16px;">
      <button class="btn" id="btnFounderCancel">Abbrechen</button>
      <button class="btn ok" id="btnFounderSave">Speichern</button>
    </div>
  </div>
</dialog>